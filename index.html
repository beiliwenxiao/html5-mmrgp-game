<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼ è§’é»„å·¾èµ·ä¹‰åºç«  - ç¬¬ä¸€å¹•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            overflow: hidden;
        }
        
        #game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        #gameCanvas {
            border: 2px solid #4CAF50;
            background-color: #2a2a2a;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        #ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        #tutorial-panel {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px 40px;
            border-radius: 15px;
            border: 3px solid #2196F3;
            pointer-events: auto;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 0 20px rgba(33, 150, 243, 0.5);
            animation: fadeIn 0.3s ease-in;
        }
        
        #tips-panel {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px 40px;
            border-radius: 15px;
            border: 3px solid #4CAF50;
            pointer-events: none;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        #tutorial-panel h3 {
            color: #2196F3;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        #tips-panel h3 {
            color: #4CAF50;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        #tutorial-panel p {
            font-size: 18px;
            line-height: 1.6;
            color: #ffffff;
            margin-bottom: 20px;
        }
        
        #tips-panel p {
            font-size: 18px;
            line-height: 1.6;
            color: #ffffff;
        }
        
        #tutorial-panel .key {
            display: inline-block;
            background: #2196F3;
            color: #000;
            padding: 5px 12px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 18px;
            margin: 0 3px;
        }
        
        #tips-panel .key {
            display: inline-block;
            background: #4CAF50;
            color: #000;
            padding: 5px 12px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 18px;
            margin: 0 3px;
        }
        
        #tutorial-panel .tutorial-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        #tutorial-panel button {
            padding: 10px 20px;
            background: #4CAF50;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        #tutorial-panel button:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        #tutorial-panel button:active {
            transform: translateY(0);
        }
        
        #tutorial-panel button:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        #tutorial-panel .step-indicator {
            font-size: 14px;
            color: #aaa;
            margin-top: 10px;
        }
        
        #debug-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            pointer-events: none;
        }
        
        #debug-panel div {
            margin: 2px 0;
        }
        
        #controls-hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .hidden {
            display: none !important;
        }
        
        #loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
        }
        
        #loading-screen h1 {
            color: #4CAF50;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 300px;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.3s;
        }
        
        /* æŠ€èƒ½æ æ ·å¼ */
        #skill-bar {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            pointer-events: auto;
        }
        
        .skill-slot {
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #4CAF50;
            border-radius: 8px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .skill-slot:hover {
            border-color: #8BC34A;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.5);
        }
        
        .skill-slot.on-cooldown {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .skill-slot.on-cooldown:hover {
            transform: none;
            box-shadow: none;
        }
        
        .skill-icon {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .skill-hotkey {
            position: absolute;
            bottom: 2px;
            right: 4px;
            font-size: 10px;
            color: #4CAF50;
            font-weight: bold;
        }
        
        .skill-cooldown {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            border-radius: 6px;
        }
        
        .skill-name {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            color: #aaa;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .skill-slot:hover .skill-name {
            opacity: 1;
        }
        
        .skill-mana-cost {
            position: absolute;
            top: 2px;
            left: 4px;
            font-size: 10px;
            color: #2196F3;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div id="ui-overlay">
            <div id="tutorial-panel" class="hidden">
                <h3 id="tutorial-title">æ•™ç¨‹</h3>
                <p id="tutorial-text">æ•™ç¨‹å†…å®¹</p>
                <div class="tutorial-buttons">
                    <button id="tutorial-prev-btn" style="display: none;">ä¸Šä¸€æ­¥</button>
                    <button id="tutorial-next-btn">ä¸‹ä¸€æ­¥</button>
                </div>
                <div class="step-indicator" id="tutorial-step-indicator"></div>
            </div>
            
            <div id="tips-panel" class="hidden">
                <h3 id="tips-title">æç¤º</h3>
                <p id="tips-text">æç¤ºå†…å®¹</p>
            </div>
            
            <div id="debug-panel">
                <div>FPS: <span id="fps">60</span></div>
                <div>ä½ç½®: <span id="position">0, 0</span></div>
                <div>ç”Ÿå‘½å€¼: <span id="hp">100/100</span></div>
                <div>é˜¶æ®µ: <span id="phase">-</span></div>
                <div>æ•Œäºº: <span id="enemies">0</span></div>
            </div>
            
            <div id="controls-hint">
                WASD/æ–¹å‘é”®: ç§»åŠ¨ | é¼ æ ‡ç‚¹å‡»: ç§»åŠ¨ | E: æ‹¾å– | C: å±æ€§/è£…å¤‡ | B: èƒŒåŒ… | 1-3: æŠ€èƒ½
            </div>
            
            <div id="skill-bar" style="display: none;">
                <div class="skill-slot" data-skill-index="0">
                    <div class="skill-icon">âš”ï¸</div>
                    <div class="skill-hotkey">1</div>
                    <div class="skill-mana-cost">0</div>
                    <div class="skill-name">æ™®é€šæ”»å‡»</div>
                </div>
                <div class="skill-slot" data-skill-index="1">
                    <div class="skill-icon">ğŸ’¥</div>
                    <div class="skill-hotkey">2</div>
                    <div class="skill-mana-cost">10</div>
                    <div class="skill-name">é‡å‡»</div>
                </div>
                <div class="skill-slot" data-skill-index="2">
                    <div class="skill-icon">ğŸ”¥</div>
                    <div class="skill-hotkey">3</div>
                    <div class="skill-mana-cost">15</div>
                    <div class="skill-name">ç«çƒæœ¯</div>
                </div>
                <div class="skill-slot" data-skill-index="3">
                    <div class="skill-icon">ğŸ’š</div>
                    <div class="skill-hotkey">4</div>
                    <div class="skill-mana-cost">20</div>
                    <div class="skill-name">æ²»ç–—æœ¯</div>
                </div>
            </div>
        </div>
        
        <div id="loading-screen">
            <h1>å¼ è§’é»„å·¾èµ·ä¹‰åºç« </h1>
            <h2>ç¬¬ä¸€å¹•ï¼šç»æœ›çš„å¼€å§‹</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p id="loading-text">åŠ è½½ä¸­...</p>
        </div>
    </div>
    
    <script type="module">
        import { Act1SceneECS } from './src/prologue/scenes/Act1SceneECS.js';
        import { Act2Scene } from './src/prologue/scenes/Act2Scene.js';
        import { SceneManager } from './src/core/SceneManager.js';
        import { DialogueBox } from './src/ui/DialogueBox.js';
        import { SkillTreePanel } from './src/ui/SkillTreePanel.js';
        import { NotificationSystem } from './src/ui/NotificationSystem.js';
        import { InventoryPanel } from './src/ui/InventoryPanel.js';
        import { AttributePanel } from './src/ui/AttributePanel.js';
        import { PlayerInfoPanel } from './src/ui/PlayerInfoPanel.js';
        
        // åœºæ™¯ç®¡ç†å™¨
        let sceneManager = null;
        
        // UIç»„ä»¶
        let dialogueBox = null;
        let skillTreePanel = null;
        let notificationSystem = null;
        let inventoryPanel = null;
        let attributePanel = null;
        let playerInfoPanel = null;
        
        // æ¸¸æˆçŠ¶æ€
        let scene = null;
        let lastTime = performance.now();
        let fps = 60;
        let frameCount = 0;
        let fpsTime = 0;
        
        // è·å–å…ƒç´ 
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const loadingScreen = document.getElementById('loading-screen');
        const progressFill = document.getElementById('progress-fill');
        const loadingText = document.getElementById('loading-text');
        const tutorialPanel = document.getElementById('tutorial-panel');
        const tutorialTitle = document.getElementById('tutorial-title');
        const tutorialText = document.getElementById('tutorial-text');
        const tutorialNextBtn = document.getElementById('tutorial-next-btn');
        const tutorialPrevBtn = document.getElementById('tutorial-prev-btn');
        const tutorialStepIndicator = document.getElementById('tutorial-step-indicator');
        
        const tipsPanel = document.getElementById('tips-panel');
        const tipsTitle = document.getElementById('tips-title');
        const tipsText = document.getElementById('tips-text');
        
        // å½“å‰æ•™ç¨‹æ•°æ®
        let currentTutorialData = null;
        
        // è°ƒè¯•é¢æ¿å…ƒç´ 
        const fpsElement = document.getElementById('fps');
        const positionElement = document.getElementById('position');
        const hpElement = document.getElementById('hp');
        const phaseElement = document.getElementById('phase');
        const enemiesElement = document.getElementById('enemies');
        
        // æ•™ç¨‹æŒ‰é’®äº‹ä»¶
        tutorialNextBtn.addEventListener('click', () => {
            if (scene && scene.tutorialSystem) {
                const hasNext = scene.tutorialSystem.nextStep();
                if (!hasNext) {
                    // æ²¡æœ‰ä¸‹ä¸€æ­¥äº†ï¼Œéšè—æ•™ç¨‹
                    hideTutorial();
                }
            }
        });
        
        tutorialPrevBtn.addEventListener('click', () => {
            if (scene && scene.tutorialSystem) {
                scene.tutorialSystem.previousStep();
            }
        });
        
        // ä¸ºåœºæ™¯è®¾ç½®å›è°ƒ
        function setupSceneCallbacks(sceneInstance) {
            if (!sceneInstance || !sceneInstance.tutorialSystem) return;
            
            // è®¾ç½®æ•™ç¨‹å›è°ƒ
            sceneInstance.tutorialSystem.onShow((data) => {
                currentTutorialData = data;
                
                // åˆ¤æ–­æ˜¯æ¸è¿›å¼æç¤ºè¿˜æ˜¯åŸºç¡€æ•™ç¨‹
                const isProgressiveTip = data.tutorialId && data.tutorialId.startsWith('progressive_tip_');
                
                // å¤„ç†ä¸¤ç§å›è°ƒæ ¼å¼ï¼š
                // 1. showTutorial è°ƒç”¨æ—¶ä¼ å…¥ tutorial å¯¹è±¡
                // 2. showStep è°ƒç”¨æ—¶ä¼ å…¥ stepData å¯¹è±¡
                if (data.step && data.step.text) {
                    // stepData æ ¼å¼ï¼ˆå¤šæ­¥æ•™ç¨‹ï¼‰
                    if (isProgressiveTip) {
                        // æ¸è¿›å¼æç¤ºï¼šä½¿ç”¨æç¤ºé¢æ¿ï¼ˆæ— æŒ‰é’®ï¼‰
                        showTips(data.tutorialTitle, data.step.text);
                    } else {
                        // åŸºç¡€æ•™ç¨‹ï¼šä½¿ç”¨æ•™ç¨‹é¢æ¿ï¼ˆæœ‰æŒ‰é’®ï¼‰
                        showTutorial(
                            data.tutorialTitle, 
                            data.step.text,
                            data.stepIndex,
                            data.totalSteps,
                            data.isLastStep
                        );
                    }
                } else if (data.title) {
                    // tutorial å¯¹è±¡æ ¼å¼ï¼ˆé¦–æ¬¡æ˜¾ç¤ºï¼‰
                    if (isProgressiveTip) {
                        // æ¸è¿›å¼æç¤ºï¼šä½¿ç”¨æç¤ºé¢æ¿ï¼ˆæ— æŒ‰é’®ï¼‰
                        showTips(data.title, data.steps[0]?.text || '');
                    } else {
                        // åŸºç¡€æ•™ç¨‹ï¼šä½¿ç”¨æ•™ç¨‹é¢æ¿ï¼ˆæœ‰æŒ‰é’®ï¼‰
                        showTutorial(
                            data.title, 
                            data.steps[0]?.text || '',
                            0,
                            data.steps.length,
                            data.steps.length === 1
                        );
                    }
                }
            });
            
            sceneInstance.tutorialSystem.onHide(() => {
                hideTutorial();
                hideTips();
            });
            
            // è®¾ç½®å¯¹è¯ç³»ç»Ÿå›è°ƒï¼ˆå¦‚æœæœ‰ï¼‰
            if (sceneInstance.dialogueSystem) {
                // åˆ›å»ºæˆ–æ›´æ–° DialogueBox
                if (!dialogueBox) {
                    dialogueBox = new DialogueBox({
                        x: 100,
                        y: 370,
                        width: 600,
                        height: 200,
                        visible: false,
                        dialogueSystem: sceneInstance.dialogueSystem
                    });
                } else {
                    dialogueBox.setDialogueSystem(sceneInstance.dialogueSystem);
                }
                
                // å½“å¯¹è¯å¼€å§‹æ—¶æ˜¾ç¤ºå¯¹è¯æ¡†
                sceneInstance.dialogueSystem.onStart(() => {
                    dialogueBox.show();
                });
                
                // å½“å¯¹è¯ç»“æŸæ—¶éšè—å¯¹è¯æ¡†
                sceneInstance.dialogueSystem.onEnd(() => {
                    dialogueBox.hide();
                });
                
                // å¦‚æœå¯¹è¯å·²ç»åœ¨è¿›è¡Œä¸­ï¼Œç«‹å³æ˜¾ç¤ºå¯¹è¯æ¡†
                if (sceneInstance.dialogueSystem.isDialogueActive()) {
                    dialogueBox.show();
                }
            }
            
            // è®¾ç½®é€šçŸ¥ç³»ç»Ÿå›è°ƒï¼ˆç”¨äºç¬¬äºŒå¹•ï¼‰
            if (sceneInstance.setNotificationCallback) {
                sceneInstance.setNotificationCallback((message, type) => {
                    if (notificationSystem) {
                        notificationSystem.addNotification(message, type);
                    }
                });
            }
            
            // è®¾ç½®ç©å®¶å®ä½“å¼•ç”¨ï¼ˆç”¨äºèƒŒåŒ…ç³»ç»Ÿï¼‰
            if (sceneInstance.setPlayerEntity && sceneInstance.playerEntity) {
                sceneInstance.setPlayerEntity(sceneInstance.playerEntity);
            }
        }
        
        // åˆå§‹åŒ–æ¸¸æˆ
        async function initGame() {
            try {
                // æ¨¡æ‹ŸåŠ è½½è¿‡ç¨‹
                updateLoading(0, 'åˆå§‹åŒ– ECS ç³»ç»Ÿ...');
                await sleep(500);
                
                updateLoading(25, 'åŠ è½½æ ¸å¿ƒç³»ç»Ÿ...');
                await sleep(500);
                
                updateLoading(50, 'åˆ›å»ºåœºæ™¯ç®¡ç†å™¨...');
                sceneManager = new SceneManager();
                await sleep(300);
                
                updateLoading(60, 'æ³¨å†Œåœºæ™¯...');
                // åˆ›å»ºå¹¶æ³¨å†Œç¬¬ä¸€å¹•åœºæ™¯
                const act1Scene = new Act1SceneECS();
                sceneManager.registerScene('Act1Scene', act1Scene);
                sceneManager.registerScene('Act1SceneECS', act1Scene); // å…¼å®¹æ—§åç§°
                
                // åˆ›å»ºå¹¶æ³¨å†Œç¬¬äºŒå¹•åœºæ™¯
                const act2Scene = new Act2Scene();
                sceneManager.registerScene('Act2Scene', act2Scene);
                
                // è®¾ç½®åœºæ™¯ç®¡ç†å™¨å¼•ç”¨
                act1Scene.setSceneManager(sceneManager);
                act2Scene.setSceneManager(sceneManager);
                
                // åˆå§‹åŒ–é€šçŸ¥ç³»ç»Ÿ
                notificationSystem = new NotificationSystem({
                    x: 10,
                    y: 100,
                    maxNotifications: 5
                });
                
                // ä¸ºæ‰€æœ‰åœºæ™¯è®¾ç½®æ•™ç¨‹å›è°ƒ
                setupSceneCallbacks(act1Scene);
                setupSceneCallbacks(act2Scene);
                
                scene = act1Scene;
                await sleep(500);
                
                updateLoading(75, 'åˆå§‹åŒ–ç©å®¶å®ä½“...');
                
                // ä½¿ç”¨åœºæ™¯ç®¡ç†å™¨åˆ‡æ¢åˆ°ç¬¬ä¸€å¹•
                updateLoading(90, 'è¿›å…¥ç¬¬ä¸€å¹•...');
                sceneManager.switchTo('Act1Scene');
                await sleep(500);
                
                updateLoading(100, 'å®Œæˆï¼');
                await sleep(500);
                
                // éšè—åŠ è½½å±å¹•
                loadingScreen.style.display = 'none';
                
                // å¼€å§‹æ¸¸æˆå¾ªç¯
                gameLoop();
                
                console.log('æ¸¸æˆåˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('æ¸¸æˆåˆå§‹åŒ–å¤±è´¥:', error);
                loadingText.textContent = 'åŠ è½½å¤±è´¥: ' + error.message;
            }
        }
        
        // æ›´æ–°åŠ è½½è¿›åº¦
        function updateLoading(progress, text) {
            progressFill.style.width = progress + '%';
            loadingText.textContent = text;
        }
        
        // å»¶è¿Ÿå‡½æ•°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // æ˜¾ç¤ºæ•™ç¨‹ï¼ˆåŸºç¡€æ•™ç¨‹ï¼Œæœ‰æŒ‰é’®ï¼‰
        function showTutorial(title, text, stepIndex = 0, totalSteps = 1, isLastStep = true) {
            tutorialTitle.textContent = title;
            // ä½¿ç”¨innerHTMLæ”¯æŒHTMLæ ‡ç­¾
            tutorialText.innerHTML = text;
            tutorialPanel.classList.remove('hidden');
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            if (totalSteps > 1) {
                tutorialStepIndicator.textContent = `æ­¥éª¤ ${stepIndex + 1} / ${totalSteps}`;
                tutorialStepIndicator.style.display = 'block';
            } else {
                tutorialStepIndicator.style.display = 'none';
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            // ä¸Šä¸€æ­¥æŒ‰é’®ï¼šåªåœ¨ä¸æ˜¯ç¬¬ä¸€æ­¥æ—¶æ˜¾ç¤º
            if (stepIndex > 0) {
                tutorialPrevBtn.style.display = 'inline-block';
            } else {
                tutorialPrevBtn.style.display = 'none';
            }
            
            // ä¸‹ä¸€æ­¥æŒ‰é’®ï¼šæœ€åä¸€æ­¥æ˜¾ç¤º"å®Œæˆ"ï¼Œå…¶ä»–æ˜¾ç¤º"ä¸‹ä¸€æ­¥"
            if (isLastStep) {
                tutorialNextBtn.textContent = 'å®Œæˆ';
            } else {
                tutorialNextBtn.textContent = 'ä¸‹ä¸€æ­¥';
            }
        }
        
        // éšè—æ•™ç¨‹
        function hideTutorial() {
            tutorialPanel.classList.add('hidden');
            currentTutorialData = null;
        }
        
        // æ˜¾ç¤ºæç¤ºï¼ˆæ¸è¿›å¼æç¤ºï¼Œæ— æŒ‰é’®ï¼‰
        function showTips(title, text) {
            tipsTitle.textContent = title;
            // ä½¿ç”¨innerHTMLæ”¯æŒHTMLæ ‡ç­¾
            tipsText.innerHTML = text;
            tipsPanel.classList.remove('hidden');
        }
        
        // éšè—æç¤º
        function hideTips() {
            tipsPanel.classList.add('hidden');
        }
        
        // æ¸¸æˆå¾ªç¯
        function gameLoop() {
            const currentTime = performance.now();
            const deltaTime = (currentTime - lastTime) / 1000;
            lastTime = currentTime;
            
            // è®¡ç®— FPS
            frameCount++;
            fpsTime += deltaTime;
            if (fpsTime >= 1.0) {
                fps = frameCount;
                frameCount = 0;
                fpsTime = 0;
            }
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = '#2a2a2a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // æ›´æ–°å’Œæ¸²æŸ“åœºæ™¯
            if (sceneManager) {
                sceneManager.update(deltaTime);
                sceneManager.render(ctx);
                
                // å¯¹è¯æ¡†ç”±åœºæ™¯è‡ªå·±æ¸²æŸ“ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤æ¸²æŸ“
                
                // æ›´æ–°å’Œæ¸²æŸ“æŠ€èƒ½æ ‘é¢æ¿
                if (skillTreePanel) {
                    skillTreePanel.render(ctx);
                }
                
                // æ›´æ–°å’Œæ¸²æŸ“é€šçŸ¥ç³»ç»Ÿ
                if (notificationSystem) {
                    notificationSystem.update(deltaTime * 1000); // è½¬æ¢ä¸ºæ¯«ç§’
                    notificationSystem.render(ctx);
                }
                
                // èƒŒåŒ…é¢æ¿ç”±åœºæ™¯è‡ªå·±æ¸²æŸ“ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤æ¸²æŸ“
                // åªæœ‰å½“åœºæ™¯æ²¡æœ‰èƒŒåŒ…é¢æ¿æ—¶æ‰æ¸²æŸ“å…¨å±€çš„
                if (inventoryPanel && (!scene || !scene.inventoryPanel)) {
                    inventoryPanel.update(deltaTime);
                    inventoryPanel.render(ctx);
                }
                
                // è§’è‰²ä¿¡æ¯é¢æ¿ç”±åœºæ™¯è‡ªå·±æ¸²æŸ“ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤æ¸²æŸ“
                // åªæœ‰å½“åœºæ™¯æ²¡æœ‰è§’è‰²ä¿¡æ¯é¢æ¿æ—¶æ‰æ¸²æŸ“å…¨å±€çš„
                if (playerInfoPanel && (!scene || !scene.playerInfoPanel)) {
                    playerInfoPanel.update(deltaTime);
                    playerInfoPanel.render(ctx);
                }
                
                // è·å–å½“å‰åœºæ™¯
                const currentScene = sceneManager.getCurrentScene();
                
                // å¦‚æœåœºæ™¯åˆ‡æ¢äº†ï¼Œè®¾ç½®æ–°åœºæ™¯çš„å›è°ƒ
                if (currentScene !== scene) {
                    console.log('åœºæ™¯åˆ‡æ¢æ£€æµ‹åˆ°ï¼Œè®¾ç½®æ–°åœºæ™¯å›è°ƒ');
                    scene = currentScene;
                    if (scene) {
                        setupSceneCallbacks(scene);
                        
                        // å¦‚æœæ˜¯ç¬¬äºŒå¹•åœºæ™¯ï¼Œè®¾ç½®ç©å®¶å®ä½“å’ŒèƒŒåŒ…é¢æ¿
                        if (scene.setPlayerEntity && scene.playerEntity) {
                            scene.setPlayerEntity(scene.playerEntity);
                        }
                        
                        // æ›´æ–°èƒŒåŒ…é¢æ¿çš„å®ä½“å¼•ç”¨
                        if (inventoryPanel && scene.playerEntity) {
                            inventoryPanel.setEntity(scene.playerEntity);
                        }
                        
                        // é‡ç½®æŠ€èƒ½æ ‘é¢æ¿å’Œå±æ€§é¢æ¿ï¼ˆå› ä¸ºä¸åŒåœºæ™¯å¯èƒ½æœ‰ä¸åŒçš„ç³»ç»Ÿå®ä¾‹ï¼‰
                        if (skillTreePanel) {
                            skillTreePanel.hide();
                            skillTreePanel = null;
                        }
                        if (attributePanel) {
                            attributePanel.hide();
                            attributePanel = null;
                        }
                        // é‡ç½®å…¨å±€è§’è‰²ä¿¡æ¯é¢æ¿ï¼ˆå› ä¸ºä¸åŒåœºæ™¯å¯èƒ½æœ‰ä¸åŒçš„ç©å®¶å®ä½“ï¼‰
                        if (playerInfoPanel) {
                            playerInfoPanel.hide();
                            playerInfoPanel = null;
                        }
                    }
                }
                
                // æ›´æ–°è°ƒè¯•ä¿¡æ¯
                if (scene) {
                    updateDebugInfo();
                }
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        // æ›´æ–°è°ƒè¯•ä¿¡æ¯
        function updateDebugInfo() {
            if (!scene) return;
            
            fpsElement.textContent = fps;
            
            // ä½¿ç”¨ playerEntityï¼ˆä¸¤å¹•éƒ½æœ‰ï¼‰
            if (scene.playerEntity) {
                const transform = scene.playerEntity.getComponent('transform');
                if (transform) {
                    positionElement.textContent = 
                        `${Math.floor(transform.position.x)}, ${Math.floor(transform.position.y)}`;
                } else {
                    positionElement.textContent = '-';
                }
                
                const stats = scene.playerEntity.getComponent('stats');
                if (stats) {
                    hpElement.textContent = `${Math.floor(stats.hp)}/${stats.maxHp}`;
                }
            } else {
                positionElement.textContent = '-';
                hpElement.textContent = '-';
            }
            
            // tutorialPhaseï¼ˆä¸¤å¹•éƒ½æœ‰ï¼‰
            phaseElement.textContent = scene.tutorialPhase || '-';
            
            // enemyEntitiesï¼ˆä¸¤å¹•éƒ½æœ‰ï¼Œç¬¬äºŒå¹•ä¸ºç©ºæ•°ç»„ï¼‰
            if (scene.enemyEntities && Array.isArray(scene.enemyEntities)) {
                const aliveEnemies = scene.enemyEntities.filter(enemy => {
                    const stats = enemy.getComponent('stats');
                    return stats && stats.hp > 0;
                });
                enemiesElement.textContent = aliveEnemies.length;
            } else {
                enemiesElement.textContent = '0';
            }
            
            // æ›´æ–°æŠ€èƒ½æ 
            updateSkillBar();
        }
        
        // æ›´æ–°æŠ€èƒ½æ æ˜¾ç¤º
        function updateSkillBar() {
            if (!scene || !scene.playerEntity) return;
            
            const skills = scene.playerEntity.getComponent('skills');
            if (!skills) return;
            
            const skillSlots = document.querySelectorAll('.skill-slot');
            skillSlots.forEach((slot, index) => {
                const skill = skills.skills[index];
                if (!skill) return;
                
                // æ£€æŸ¥å†·å´
                const cooldownRemaining = skills.getCooldownRemaining(skill.id);
                const isOnCooldown = cooldownRemaining > 0;
                
                // æ›´æ–°æ ·å¼
                if (isOnCooldown) {
                    slot.classList.add('on-cooldown');
                    // æ˜¾ç¤ºå†·å´æ—¶é—´
                    let cooldownDiv = slot.querySelector('.skill-cooldown');
                    if (!cooldownDiv) {
                        cooldownDiv = document.createElement('div');
                        cooldownDiv.className = 'skill-cooldown';
                        slot.appendChild(cooldownDiv);
                    }
                    cooldownDiv.textContent = Math.ceil(cooldownRemaining);
                } else {
                    slot.classList.remove('on-cooldown');
                    const cooldownDiv = slot.querySelector('.skill-cooldown');
                    if (cooldownDiv) {
                        cooldownDiv.remove();
                    }
                }
            });
        }
        
        // æŠ€èƒ½æ ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.skill-slot').forEach((slot, index) => {
            slot.addEventListener('click', () => {
                if (!scene || !scene.playerEntity) return;
                useSkill(index);
            });
        });
        
        // ä½¿ç”¨æŠ€èƒ½
        function useSkill(skillIndex) {
            if (!scene || !scene.combatSystem) return;
            
            const skills = scene.playerEntity.getComponent('skills');
            if (!skills) return;
            
            const skill = skills.skills[skillIndex];
            if (!skill) return;
            
            // å°è¯•ä½¿ç”¨æŠ€èƒ½
            scene.combatSystem.useSkill(scene.playerEntity, skill.id);
        }
        
        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            // ç©ºæ ¼é”® - ç»§ç»­å¯¹è¯
            if (e.code === 'Space' && dialogueBox && dialogueBox.visible) {
                e.preventDefault();
                dialogueBox.continueDialogue();
                return;
            }
            
            // Ké”® - æ‰“å¼€æŠ€èƒ½æ ‘
            if (e.code === 'KeyK') {
                // è·å–å½“å‰åœºæ™¯çš„æŠ€èƒ½æ ‘ç³»ç»Ÿå’Œç©å®¶
                const currentSkillTreeSystem = scene?.skillTreeSystem || scene?.getSkillTreeSystem?.();
                const currentPlayer = scene?.player;
                
                if (skillTreePanel) {
                    skillTreePanel.toggle();
                } else if (currentSkillTreeSystem && currentPlayer) {
                    // åˆ›å»ºæŠ€èƒ½æ ‘é¢æ¿
                    skillTreePanel = new SkillTreePanel({
                        x: 100,
                        y: 50,
                        width: 600,
                        height: 500,
                        skillTreeSystem: currentSkillTreeSystem,
                        character: currentPlayer
                    });
                    skillTreePanel.show();
                } else {
                    console.log('æŠ€èƒ½æ ‘ç³»ç»Ÿæˆ–ç©å®¶æ•°æ®ä¸å¯ç”¨');
                }
                return;
            }
            
            // Bé”® - æ‰“å¼€èƒŒåŒ…
            if (e.code === 'KeyB') {
                // å¦‚æœåœºæ™¯æœ‰è‡ªå·±çš„èƒŒåŒ…é¢æ¿ï¼Œè®©åœºæ™¯è‡ªå·±å¤„ç†ï¼ˆé€šè¿‡ inputManagerï¼‰
                // è¿™é‡Œä¸åšä»»ä½•å¤„ç†ï¼Œé¿å…é‡å¤åˆ‡æ¢
                if (scene && scene.inventoryPanel) {
                    // åœºæ™¯ä¼šé€šè¿‡ checkInventoryToggle å¤„ç†
                    // æ›´æ–°å…¨å±€å¼•ç”¨ä»¥ä¾¿å…¶ä»–åœ°æ–¹ä½¿ç”¨
                    inventoryPanel = scene.inventoryPanel;
                    return;
                }
                
                // åªæœ‰åœºæ™¯æ²¡æœ‰èƒŒåŒ…é¢æ¿æ—¶æ‰åœ¨è¿™é‡Œå¤„ç†
                if (inventoryPanel) {
                    inventoryPanel.toggle();
                } else if (scene && scene.playerEntity) {
                    // åˆ›å»ºæ–°çš„èƒŒåŒ…é¢æ¿
                    inventoryPanel = new InventoryPanel({
                        x: 200,
                        y: 100,
                        visible: true,
                        onItemUse: (item, healAmount, manaAmount) => {
                            console.log('ç‰©å“ä½¿ç”¨:', item.name);
                            // é€šçŸ¥åœºæ™¯ç‰©å“å·²ä½¿ç”¨
                            if (scene && scene.onTalismanWaterUsed) {
                                scene.onTalismanWaterUsed(item, healAmount);
                            }
                            // æ˜¾ç¤ºæ¢å¤é€šçŸ¥
                            if (notificationSystem && healAmount > 0) {
                                notificationSystem.addNotification(`æ¢å¤äº† ${healAmount} ç‚¹ç”Ÿå‘½å€¼`, 'success');
                            }
                        }
                    });
                    inventoryPanel.setEntity(scene.playerEntity);
                }
                return;
            }
            
            // Cé”® - æ‰“å¼€è§’è‰²ä¿¡æ¯é¢æ¿ï¼ˆPlayerInfoPanelï¼‰
            if (e.code === 'KeyC') {
                // å¦‚æœåœºæ™¯æœ‰è‡ªå·±çš„è§’è‰²ä¿¡æ¯é¢æ¿ï¼Œè®©åœºæ™¯è‡ªå·±å¤„ç†ï¼ˆé€šè¿‡ inputManagerï¼‰
                if (scene && scene.playerInfoPanel) {
                    // åœºæ™¯ä¼šé€šè¿‡ checkPlayerInfoToggle å¤„ç†
                    return;
                }
                
                // åœºæ™¯æ²¡æœ‰è§’è‰²ä¿¡æ¯é¢æ¿æ—¶ï¼Œä½¿ç”¨å…¨å±€çš„
                if (scene && scene.playerEntity) {
                    if (playerInfoPanel) {
                        playerInfoPanel.toggle();
                    } else {
                        // åˆ›å»ºå…¨å±€è§’è‰²ä¿¡æ¯é¢æ¿
                        playerInfoPanel = new PlayerInfoPanel({
                            x: 10,
                            y: 10,
                            width: 280,
                            height: 320,
                            visible: true,
                            onAttributeAllocate: (player) => {
                                console.log('å…¨å±€ PlayerInfoPanel: å±æ€§åŠ ç‚¹æŒ‰é’®è¢«ç‚¹å‡»');
                                // è·å–åœºæ™¯çš„å±æ€§ç³»ç»Ÿ
                                const currentAttributeSystem = scene?.attributeSystem || scene?.getAttributeSystem?.();
                                if (currentAttributeSystem && player) {
                                    if (attributePanel) {
                                        if (attributePanel.isOpen()) {
                                            attributePanel.hide();
                                        } else {
                                            attributePanel.show(player.id);
                                        }
                                    } else {
                                        // åˆ›å»ºå±æ€§é¢æ¿
                                        attributePanel = new AttributePanel(document.body, currentAttributeSystem);
                                        attributePanel.show(player.id);
                                    }
                                } else {
                                    console.log('å±æ€§ç³»ç»Ÿä¸å¯ç”¨');
                                }
                            }
                        });
                        playerInfoPanel.setPlayer(scene.playerEntity);
                    }
                } else {
                    console.log('å½“å‰åœºæ™¯æ²¡æœ‰ç©å®¶å®ä½“');
                }
                return;
            }
            
            if (!scene || !scene.playerEntity) return;
            
            // æŠ€èƒ½å¿«æ·é”® 1-4
            if (e.key >= '1' && e.key <= '4') {
                const skillIndex = parseInt(e.key) - 1;
                useSkill(skillIndex);
            }
        });
        
        // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            if (skillTreePanel && skillTreePanel.isVisible) {
                skillTreePanel.handleMouseMove(mouseX, mouseY);
            }
            
            if (dialogueBox && dialogueBox.visible) {
                dialogueBox.handleMouseMove(mouseX, mouseY);
            }
            
            // èƒŒåŒ…é¢æ¿çš„é¼ æ ‡ç§»åŠ¨ç”±åœºæ™¯å¤„ç†
            // åªæœ‰å½“åœºæ™¯æ²¡æœ‰èƒŒåŒ…é¢æ¿æ—¶æ‰å¤„ç†å…¨å±€çš„
            if (inventoryPanel && inventoryPanel.visible && (!scene || !scene.inventoryPanel)) {
                inventoryPanel.handleMouseMove(mouseX, mouseY);
            }
            
            // è§’è‰²ä¿¡æ¯é¢æ¿çš„é¼ æ ‡ç§»åŠ¨ç”±åœºæ™¯å¤„ç†
            // åªæœ‰å½“åœºæ™¯æ²¡æœ‰è§’è‰²ä¿¡æ¯é¢æ¿æ—¶æ‰å¤„ç†å…¨å±€çš„
            if (playerInfoPanel && playerInfoPanel.visible && (!scene || !scene.playerInfoPanel)) {
                playerInfoPanel.handleMouseMove(mouseX, mouseY);
            }
        });
        
        // é¼ æ ‡ç‚¹å‡»äº‹ä»¶
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            // èƒŒåŒ…é¢æ¿çš„ç‚¹å‡»ç”±åœºæ™¯å¤„ç†
            // åªæœ‰å½“åœºæ™¯æ²¡æœ‰èƒŒåŒ…é¢æ¿æ—¶æ‰å¤„ç†å…¨å±€çš„
            if (inventoryPanel && inventoryPanel.visible && (!scene || !scene.inventoryPanel)) {
                if (inventoryPanel.handleMouseClick(mouseX, mouseY, 'left')) {
                    return;
                }
            }
            
            // è§’è‰²ä¿¡æ¯é¢æ¿çš„ç‚¹å‡»ç”±åœºæ™¯å¤„ç†
            // åªæœ‰å½“åœºæ™¯æ²¡æœ‰è§’è‰²ä¿¡æ¯é¢æ¿æ—¶æ‰å¤„ç†å…¨å±€çš„
            if (playerInfoPanel && playerInfoPanel.visible && (!scene || !scene.playerInfoPanel)) {
                if (playerInfoPanel.handleMouseClick(mouseX, mouseY, 'left')) {
                    return;
                }
            }
            
            // ä¼˜å…ˆå¤„ç†æŠ€èƒ½æ ‘é¢æ¿ç‚¹å‡»
            if (skillTreePanel && skillTreePanel.isVisible) {
                if (skillTreePanel.handleClick(mouseX, mouseY)) {
                    return;
                }
            }
            
            if (dialogueBox && dialogueBox.visible) {
                dialogueBox.handleMouseClick(mouseX, mouseY);
            }
        });
        
        // å³é”®èœå•äº‹ä»¶ï¼ˆç”¨äºèƒŒåŒ…ï¼‰
        canvas.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            // èƒŒåŒ…é¢æ¿çš„å³é”®ç”±åœºæ™¯å¤„ç†
            // åªæœ‰å½“åœºæ™¯æ²¡æœ‰èƒŒåŒ…é¢æ¿æ—¶æ‰å¤„ç†å…¨å±€çš„
            if (inventoryPanel && inventoryPanel.visible && (!scene || !scene.inventoryPanel)) {
                inventoryPanel.handleMouseClick(mouseX, mouseY, 'right');
            }
        });
        
        // å¯åŠ¨æ¸¸æˆ
        initGame();
    </script>
</body>
</html>
