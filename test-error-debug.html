<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”™è¯¯å¤„ç†å’Œè°ƒè¯•å·¥å…·æµ‹è¯•</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a2e;
            color: #ffffff;
            font-family: 'Courier New', monospace;
        }
        
        h1 {
            color: #4a90e2;
            margin-bottom: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .section {
            background: #2a2a3e;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        .section h2 {
            color: #f39c12;
            margin-top: 0;
        }
        
        button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background: #357abd;
        }
        
        button.danger {
            background: #e74c3c;
        }
        
        button.danger:hover {
            background: #c0392b;
        }
        
        button.success {
            background: #27ae60;
        }
        
        button.success:hover {
            background: #229954;
        }
        
        .info {
            background: #34495e;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        
        .warning {
            background: #34495e;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #f39c12;
        }
        
        canvas {
            border: 2px solid #4a90e2;
            display: block;
            margin: 20px auto;
            background: #0f0f1e;
        }
        
        pre {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ é”™è¯¯å¤„ç†å’Œè°ƒè¯•å·¥å…·æµ‹è¯•</h1>
        
        <div class="section">
            <h2>1. é”™è¯¯å¤„ç†æµ‹è¯•</h2>
            <div class="info">
                <strong>è¯´æ˜:</strong> æµ‹è¯•å„ç§é”™è¯¯åœºæ™¯å’Œé”™è¯¯å¤„ç†æœºåˆ¶
            </div>
            <button onclick="testRuntimeError()">è§¦å‘è¿è¡Œæ—¶é”™è¯¯</button>
            <button onclick="testAsyncError()">è§¦å‘å¼‚æ­¥é”™è¯¯</button>
            <button onclick="testResourceError()">æ¨¡æ‹Ÿèµ„æºåŠ è½½å¤±è´¥</button>
            <button onclick="testWrappedFunction()">æµ‹è¯•é”™è¯¯åŒ…è£…</button>
            <button onclick="viewErrors()">æŸ¥çœ‹é”™è¯¯å†å²</button>
            <button onclick="clearErrors()">æ¸…é™¤é”™è¯¯</button>
        </div>
        
        <div class="section">
            <h2>2. æ—¥å¿—ç³»ç»Ÿæµ‹è¯•</h2>
            <div class="info">
                <strong>è¯´æ˜:</strong> æµ‹è¯•ä¸åŒçº§åˆ«çš„æ—¥å¿—è®°å½•å’Œè¿‡æ»¤
            </div>
            <button onclick="testDebugLog()">DEBUGæ—¥å¿—</button>
            <button onclick="testInfoLog()">INFOæ—¥å¿—</button>
            <button onclick="testWarnLog()">WARNæ—¥å¿—</button>
            <button onclick="testErrorLog()">ERRORæ—¥å¿—</button>
            <button onclick="testLogFilter()">æµ‹è¯•æ—¥å¿—è¿‡æ»¤</button>
            <button onclick="viewLogs()">æŸ¥çœ‹æ—¥å¿—å†å²</button>
            <button class="success" onclick="exportLogs()">å¯¼å‡ºæ—¥å¿—</button>
            <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
            <div class="warning">
                <strong>æ—¥å¿—çº§åˆ«æ§åˆ¶:</strong><br>
                <button onclick="setLogLevel(0)">DEBUG</button>
                <button onclick="setLogLevel(1)">INFO</button>
                <button onclick="setLogLevel(2)">WARN</button>
                <button onclick="setLogLevel(3)">ERROR</button>
            </div>
        </div>
        
        <div class="section">
            <h2>3. è°ƒè¯•å·¥å…·æµ‹è¯•</h2>
            <div class="info">
                <strong>è¯´æ˜:</strong> æµ‹è¯•è°ƒè¯•æ¨¡å¼å’Œå¯è§†åŒ–å·¥å…·<br>
                <strong>å¿«æ·é”®:</strong> F3=åˆ‡æ¢è°ƒè¯•, F4=ç¢°æ’ç›’, F5=è·¯å¾„, F6=æ”»å‡»èŒƒå›´, F7=ç½‘æ ¼, F8=å¯¼å‡ºæ—¥å¿—
            </div>
            <button class="success" onclick="toggleDebug()">åˆ‡æ¢è°ƒè¯•æ¨¡å¼ (F3)</button>
            <button onclick="toggleCollisionBoxes()">åˆ‡æ¢ç¢°æ’ç›’ (F4)</button>
            <button onclick="togglePaths()">åˆ‡æ¢è·¯å¾„ (F5)</button>
            <button onclick="toggleAttackRanges()">åˆ‡æ¢æ”»å‡»èŒƒå›´ (F6)</button>
            <button onclick="toggleGrid()">åˆ‡æ¢ç½‘æ ¼ (F7)</button>
            <button onclick="createTestEntities()">åˆ›å»ºæµ‹è¯•å®ä½“</button>
            <button onclick="selectRandomEntity()">é€‰æ‹©éšæœºå®ä½“</button>
            <button onclick="clearSelection()">æ¸…é™¤é€‰æ‹©</button>
        </div>
        
        <div class="section">
            <h2>4. å¯è§†åŒ–æµ‹è¯•</h2>
            <canvas id="testCanvas" width="800" height="600"></canvas>
            <div class="info">
                <strong>æç¤º:</strong> å¯ç”¨è°ƒè¯•æ¨¡å¼åï¼Œå¯ä»¥çœ‹åˆ°å®ä½“çš„ç¢°æ’ç›’ã€è·¯å¾„å’Œå…¶ä»–è°ƒè¯•ä¿¡æ¯
            </div>
        </div>
        
        <div class="section">
            <h2>5. æµ‹è¯•ç»“æœ</h2>
            <div id="results" style="background: #1a1a1a; padding: 15px; border-radius: 5px; min-height: 100px;">
                <p style="color: #95a5a6;">æµ‹è¯•ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { ErrorHandler } from './src/core/ErrorHandler.js';
        import { logger, LogLevel } from './src/core/Logger.js';
        import { DebugTools } from './src/core/DebugTools.js';

        // åˆå§‹åŒ–
        const errorHandler = new ErrorHandler();
        const canvas = document.getElementById('testCanvas');
        const ctx = canvas.getContext('2d');
        
        // æ¨¡æ‹Ÿæ¸¸æˆå¼•æ“å¯¹è±¡
        const mockGameEngine = {
            canvas: canvas,
            ctx: ctx
        };
        
        const debugTools = new DebugTools(mockGameEngine);
        
        // æµ‹è¯•å®ä½“
        let testEntities = [];
        
        // æ¨¡æ‹Ÿç›¸æœº
        const camera = {
            x: 0,
            y: 0,
            width: 800,
            height: 600
        };

        // æš´éœ²åˆ°å…¨å±€
        window.errorHandler = errorHandler;
        window.logger = logger;
        window.debugTools = debugTools;
        window.testEntities = testEntities;

        // é”™è¯¯å¤„ç†æµ‹è¯•
        window.testRuntimeError = () => {
            try {
                throw new Error('è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è¿è¡Œæ—¶é”™è¯¯');
            } catch (error) {
                errorHandler.handleError({
                    type: 'runtime',
                    message: error.message,
                    error,
                    timestamp: Date.now()
                });
            }
            log('è§¦å‘äº†è¿è¡Œæ—¶é”™è¯¯');
        };

        window.testAsyncError = async () => {
            try {
                await Promise.reject(new Error('è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å¼‚æ­¥é”™è¯¯'));
            } catch (error) {
                errorHandler.handleError({
                    type: 'async',
                    message: error.message,
                    error,
                    timestamp: Date.now()
                });
            }
            log('è§¦å‘äº†å¼‚æ­¥é”™è¯¯');
        };

        window.testResourceError = () => {
            errorHandler.handleError({
                type: 'resource',
                message: 'èµ„æºåŠ è½½å¤±è´¥: test-image.png',
                source: 'AssetManager',
                timestamp: Date.now()
            });
            log('æ¨¡æ‹Ÿäº†èµ„æºåŠ è½½å¤±è´¥');
        };

        window.testWrappedFunction = () => {
            const wrappedFn = errorHandler.wrap(() => {
                throw new Error('åŒ…è£…å‡½æ•°ä¸­çš„é”™è¯¯');
            }, 'testContext');
            
            try {
                wrappedFn();
            } catch (e) {
                log('æ•è·äº†åŒ…è£…å‡½æ•°çš„é”™è¯¯');
            }
        };

        window.viewErrors = () => {
            const errors = errorHandler.getErrors();
            log(`é”™è¯¯å†å² (${errors.length}æ¡):`);
            errors.forEach((err, i) => {
                log(`${i + 1}. [${err.type}] ${err.message}`);
            });
        };

        window.clearErrors = () => {
            errorHandler.clearErrors();
            log('å·²æ¸…é™¤æ‰€æœ‰é”™è¯¯');
        };

        // æ—¥å¿—ç³»ç»Ÿæµ‹è¯•
        window.testDebugLog = () => {
            logger.debug('è¿™æ˜¯ä¸€æ¡DEBUGæ—¥å¿—', { data: 'test' });
            log('å·²è®°å½•DEBUGæ—¥å¿—');
        };

        window.testInfoLog = () => {
            logger.info('è¿™æ˜¯ä¸€æ¡INFOæ—¥å¿—', { status: 'ok' });
            log('å·²è®°å½•INFOæ—¥å¿—');
        };

        window.testWarnLog = () => {
            logger.warn('è¿™æ˜¯ä¸€æ¡WARNæ—¥å¿—', { warning: 'test' });
            log('å·²è®°å½•WARNæ—¥å¿—');
        };

        window.testErrorLog = () => {
            logger.error('è¿™æ˜¯ä¸€æ¡ERRORæ—¥å¿—', { error: 'test' });
            log('å·²è®°å½•ERRORæ—¥å¿—');
        };

        window.testLogFilter = () => {
            logger.addFilter(/æµ‹è¯•/);
            logger.info('è¿™æ¡æ—¥å¿—åŒ…å«æµ‹è¯•å…³é”®å­—');
            logger.info('è¿™æ¡æ—¥å¿—ä¸åŒ…å«å…³é”®å­—');
            logger.clearFilters();
            log('å·²æµ‹è¯•æ—¥å¿—è¿‡æ»¤ï¼ˆæŸ¥çœ‹æ§åˆ¶å°ï¼‰');
        };

        window.viewLogs = () => {
            const logs = logger.getLogs();
            log(`æ—¥å¿—å†å² (${logs.length}æ¡):`);
            logs.slice(-10).forEach((entry, i) => {
                log(`${i + 1}. [${entry.levelName}] ${entry.message}`);
            });
        };

        window.exportLogs = () => {
            logger.downloadLogs('text');
            log('æ—¥å¿—å·²å¯¼å‡º');
        };

        window.clearLogs = () => {
            logger.clearLogs();
            log('å·²æ¸…é™¤æ‰€æœ‰æ—¥å¿—');
        };

        window.setLogLevel = (level) => {
            logger.setLevel(level);
            const levels = ['DEBUG', 'INFO', 'WARN', 'ERROR'];
            log(`æ—¥å¿—çº§åˆ«è®¾ç½®ä¸º: ${levels[level]}`);
        };

        // è°ƒè¯•å·¥å…·æµ‹è¯•
        window.toggleDebug = () => {
            debugTools.toggle();
            log(`è°ƒè¯•æ¨¡å¼: ${debugTools.isEnabled() ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}`);
        };

        window.toggleCollisionBoxes = () => {
            debugTools.options.showCollisionBoxes = !debugTools.options.showCollisionBoxes;
            log(`ç¢°æ’ç›’æ˜¾ç¤º: ${debugTools.options.showCollisionBoxes ? 'å¼€' : 'å…³'}`);
        };

        window.togglePaths = () => {
            debugTools.options.showPaths = !debugTools.options.showPaths;
            log(`è·¯å¾„æ˜¾ç¤º: ${debugTools.options.showPaths ? 'å¼€' : 'å…³'}`);
        };

        window.toggleAttackRanges = () => {
            debugTools.options.showAttackRanges = !debugTools.options.showAttackRanges;
            log(`æ”»å‡»èŒƒå›´æ˜¾ç¤º: ${debugTools.options.showAttackRanges ? 'å¼€' : 'å…³'}`);
        };

        window.toggleGrid = () => {
            debugTools.options.showGrid = !debugTools.options.showGrid;
            log(`ç½‘æ ¼æ˜¾ç¤º: ${debugTools.options.showGrid ? 'å¼€' : 'å…³'}`);
        };

        window.createTestEntities = () => {
            testEntities = [];
            
            for (let i = 0; i < 5; i++) {
                const entity = {
                    id: `entity-${i}`,
                    type: i === 0 ? 'player' : 'enemy',
                    components: new Map()
                };
                
                entity.components.set('transform', {
                    position: {
                        x: 100 + i * 150,
                        y: 300
                    }
                });
                
                entity.components.set('combat', {
                    attackRange: 80 + i * 20
                });
                
                entity.components.set('movement', {
                    path: [
                        { x: 100 + i * 150, y: 200 },
                        { x: 150 + i * 150, y: 250 },
                        { x: 100 + i * 150, y: 300 }
                    ]
                });
                
                testEntities.push(entity);
            }
            
            log(`å·²åˆ›å»º ${testEntities.length} ä¸ªæµ‹è¯•å®ä½“`);
            renderTestScene();
        };

        window.selectRandomEntity = () => {
            if (testEntities.length === 0) {
                log('è¯·å…ˆåˆ›å»ºæµ‹è¯•å®ä½“');
                return;
            }
            
            const entity = testEntities[Math.floor(Math.random() * testEntities.length)];
            debugTools.selectEntity(entity);
            log(`å·²é€‰æ‹©å®ä½“: ${entity.id}`);
            renderTestScene();
        };

        window.clearSelection = () => {
            debugTools.clearSelectedEntity();
            log('å·²æ¸…é™¤é€‰æ‹©');
            renderTestScene();
        };

        // æ¸²æŸ“æµ‹è¯•åœºæ™¯
        function renderTestScene() {
            ctx.fillStyle = '#0f0f1e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // æ¸²æŸ“å®ä½“
            for (const entity of testEntities) {
                const transform = entity.components.get('transform');
                if (transform) {
                    ctx.fillStyle = entity.type === 'player' ? '#4a90e2' : '#e74c3c';
                    ctx.fillRect(
                        transform.position.x - 16,
                        transform.position.y - 16,
                        32,
                        32
                    );
                }
            }
            
            // æ¸²æŸ“è°ƒè¯•ä¿¡æ¯
            if (debugTools.isEnabled()) {
                debugTools.render(ctx, camera, testEntities);
            }
        }

        // æ—¥å¿—è¾“å‡º
        function log(message) {
            const results = document.getElementById('results');
            const time = new Date().toLocaleTimeString();
            results.innerHTML += `<p style="color: #00ff00; margin: 5px 0;">[${time}] ${message}</p>`;
            results.scrollTop = results.scrollHeight;
        }

        // åˆå§‹åŒ–æ—¥å¿—
        log('é”™è¯¯å¤„ç†å’Œè°ƒè¯•å·¥å…·æµ‹è¯•é¡µé¢å·²åŠ è½½');
        log('æŒ‰ F3 åˆ‡æ¢è°ƒè¯•æ¨¡å¼');
        
        // æ¸²æŸ“å¾ªç¯
        function gameLoop() {
            if (debugTools.isEnabled()) {
                debugTools.update(0.016);
                renderTestScene();
            }
            requestAnimationFrame(gameLoop);
        }
        
        gameLoop();
    </script>
</body>
</html>
