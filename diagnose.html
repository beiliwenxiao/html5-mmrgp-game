<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœºæ™¯åˆ‡æ¢è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a2e;
            color: #ffffff;
            font-family: 'Courier New', monospace;
        }
        h1 { color: #4a9eff; }
        .section {
            background: #0f0c29;
            border: 2px solid #4a9eff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
        }
        button:hover { background: #357abd; }
        .success { color: #51cf66; }
        .error { color: #ff4444; }
        .warning { color: #ffaa00; }
        pre {
            background: #000;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
        .step { margin: 10px 0; padding: 10px; background: #1e1e3e; border-radius: 3px; }
        .step-number { 
            display: inline-block;
            width: 30px;
            height: 30px;
            background: #4a9eff;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” åœºæ™¯åˆ‡æ¢è¯Šæ–­å·¥å…·</h1>
    
    <div class="section">
        <h2>æ­¥éª¤ 1: æ£€æŸ¥æ¸¸æˆå¼•æ“</h2>
        <button onclick="checkGameEngine()">è¿è¡Œæ£€æŸ¥</button>
        <div id="engineCheck"></div>
    </div>

    <div class="section">
        <h2>æ­¥éª¤ 2: æµ‹è¯•åœºæ™¯åˆ‡æ¢ï¼ˆæ— æ•°æ®ï¼‰</h2>
        <button onclick="testSceneSwitchNoData()">æµ‹è¯•åˆ‡æ¢åˆ°æ¸¸æˆåœºæ™¯</button>
        <div id="switchNoData"></div>
    </div>

    <div class="section">
        <h2>æ­¥éª¤ 3: æµ‹è¯•åœºæ™¯åˆ‡æ¢ï¼ˆå¸¦è§’è‰²æ•°æ®ï¼‰</h2>
        <button onclick="testSceneSwitchWithData()">æµ‹è¯•åˆ‡æ¢åˆ°æ¸¸æˆåœºæ™¯ï¼ˆå¸¦æ•°æ®ï¼‰</button>
        <div id="switchWithData"></div>
    </div>

    <div class="section">
        <h2>æ­¥éª¤ 4: å®Œæ•´æµç¨‹æµ‹è¯•</h2>
        <button onclick="testFullFlow()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
        <div id="fullFlow"></div>
    </div>

    <div class="section">
        <h2>å®æ—¶æ—¥å¿—</h2>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <pre id="log"></pre>
    </div>

    <script type="module">
        import { GameEngine } from './src/core/GameEngine.js';

        let gameEngine = null;
        const logDiv = document.getElementById('log');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff4444' : type === 'success' ? '#51cf66' : type === 'warning' ? '#ffaa00' : '#ffffff';
            logDiv.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        window.clearLog = function() {
            logDiv.innerHTML = '';
        };

        window.checkGameEngine = async function() {
            const div = document.getElementById('engineCheck');
            div.innerHTML = '<p>æ£€æŸ¥ä¸­...</p>';
            
            try {
                log('å¼€å§‹æ£€æŸ¥æ¸¸æˆå¼•æ“...', 'info');
                
                // åˆ›å»ºä¸´æ—¶canvas
                const canvas = document.createElement('canvas');
                canvas.width = 1280;
                canvas.height = 720;
                document.body.appendChild(canvas);
                canvas.style.display = 'none';
                
                gameEngine = new GameEngine(canvas);
                window.gameEngine = gameEngine;
                
                log('âœ“ GameEngine å®ä¾‹åˆ›å»ºæˆåŠŸ', 'success');
                
                await gameEngine.init();
                log('âœ“ GameEngine åˆå§‹åŒ–æˆåŠŸ', 'success');
                
                gameEngine.start();
                log('âœ“ GameEngine å¯åŠ¨æˆåŠŸ', 'success');
                
                // æ£€æŸ¥åœºæ™¯ç®¡ç†å™¨
                if (gameEngine.sceneManager) {
                    log('âœ“ SceneManager å­˜åœ¨', 'success');
                    
                    const currentScene = gameEngine.sceneManager.getCurrentScene();
                    log(`âœ“ å½“å‰åœºæ™¯: ${currentScene ? currentScene.name : 'None'}`, 'success');
                    
                    // æ£€æŸ¥æ³¨å†Œçš„åœºæ™¯
                    const scenes = Array.from(gameEngine.sceneManager.scenes.keys());
                    log(`âœ“ å·²æ³¨å†Œåœºæ™¯: ${scenes.join(', ')}`, 'success');
                } else {
                    log('âœ— SceneManager ä¸å­˜åœ¨', 'error');
                }
                
                div.innerHTML = '<p class="success">âœ“ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼</p>';
                
            } catch (error) {
                log(`âœ— é”™è¯¯: ${error.message}`, 'error');
                div.innerHTML = `<p class="error">âœ— æ£€æŸ¥å¤±è´¥: ${error.message}</p>`;
            }
        };

        window.testSceneSwitchNoData = function() {
            const div = document.getElementById('switchNoData');
            
            if (!gameEngine) {
                div.innerHTML = '<p class="error">è¯·å…ˆè¿è¡Œæ­¥éª¤1</p>';
                return;
            }
            
            log('æµ‹è¯•åœºæ™¯åˆ‡æ¢ï¼ˆæ— æ•°æ®ï¼‰...', 'info');
            
            try {
                const beforeScene = gameEngine.sceneManager.getCurrentScene();
                log(`åˆ‡æ¢å‰åœºæ™¯: ${beforeScene ? beforeScene.name : 'None'}`, 'info');
                
                gameEngine.sceneManager.switchTo('Game');
                
                // ç­‰å¾…è½¬åœºå®Œæˆ
                setTimeout(() => {
                    const afterScene = gameEngine.sceneManager.getCurrentScene();
                    log(`åˆ‡æ¢ååœºæ™¯: ${afterScene ? afterScene.name : 'None'}`, 'info');
                    
                    if (afterScene && afterScene.name === 'Game') {
                        log('âœ“ åœºæ™¯åˆ‡æ¢æˆåŠŸ', 'success');
                        div.innerHTML = '<p class="success">âœ“ æµ‹è¯•é€šè¿‡</p>';
                    } else {
                        log('âœ— åœºæ™¯åˆ‡æ¢å¤±è´¥', 'error');
                        div.innerHTML = '<p class="error">âœ— æµ‹è¯•å¤±è´¥</p>';
                    }
                }, 1000);
                
            } catch (error) {
                log(`âœ— é”™è¯¯: ${error.message}`, 'error');
                div.innerHTML = `<p class="error">âœ— ${error.message}</p>`;
            }
        };

        window.testSceneSwitchWithData = function() {
            const div = document.getElementById('switchWithData');
            
            if (!gameEngine) {
                div.innerHTML = '<p class="error">è¯·å…ˆè¿è¡Œæ­¥éª¤1</p>';
                return;
            }
            
            log('æµ‹è¯•åœºæ™¯åˆ‡æ¢ï¼ˆå¸¦è§’è‰²æ•°æ®ï¼‰...', 'info');
            
            try {
                const testCharacter = {
                    id: 'test_' + Date.now(),
                    name: 'æµ‹è¯•è§’è‰²',
                    class: 'warrior',
                    level: 1,
                    stats: { hp: 150, maxHp: 150, mp: 50, maxMp: 50 }
                };
                
                log(`åˆ›å»ºæµ‹è¯•è§’è‰²: ${JSON.stringify(testCharacter)}`, 'info');
                
                const dataToPass = { character: testCharacter };
                log(`å‡†å¤‡ä¼ é€’çš„æ•°æ®å¯¹è±¡: ${JSON.stringify(dataToPass)}`, 'info');
                log(`æ•°æ®å¯¹è±¡çš„ character å±æ€§: ${JSON.stringify(dataToPass.character)}`, 'info');
                
                gameEngine.sceneManager.switchTo('Game', dataToPass);
                
                // ç­‰å¾…è½¬åœºå®Œæˆ
                setTimeout(() => {
                    const gameScene = gameEngine.sceneManager.getCurrentScene();
                    
                    if (gameScene && gameScene.name === 'Game') {
                        log('âœ“ åˆ‡æ¢åˆ°æ¸¸æˆåœºæ™¯æˆåŠŸ', 'success');
                        
                        log(`GameScene.character çš„å€¼: ${JSON.stringify(gameScene.character)}`, 'info');
                        
                        if (gameScene.character) {
                            log(`âœ“ è§’è‰²æ•°æ®å·²ä¼ é€’: ${gameScene.character.name}`, 'success');
                            div.innerHTML = '<p class="success">âœ“ æµ‹è¯•é€šè¿‡ - è§’è‰²æ•°æ®æ­£ç¡®ä¼ é€’</p>';
                        } else {
                            log('âœ— è§’è‰²æ•°æ®æœªä¼ é€’', 'error');
                            log(`GameScene å¯¹è±¡: ${JSON.stringify({name: gameScene.name, character: gameScene.character})}`, 'error');
                            div.innerHTML = '<p class="error">âœ— æµ‹è¯•å¤±è´¥ - è§’è‰²æ•°æ®ä¸¢å¤±</p>';
                        }
                    } else {
                        log('âœ— æœªèƒ½åˆ‡æ¢åˆ°æ¸¸æˆåœºæ™¯', 'error');
                        div.innerHTML = '<p class="error">âœ— æµ‹è¯•å¤±è´¥</p>';
                    }
                }, 1000);
                
            } catch (error) {
                log(`âœ— é”™è¯¯: ${error.message}`, 'error');
                log(`é”™è¯¯å †æ ˆ: ${error.stack}`, 'error');
                div.innerHTML = `<p class="error">âœ— ${error.message}</p>`;
            }
        };

        window.testFullFlow = function() {
            const div = document.getElementById('fullFlow');
            div.innerHTML = '<p>è¿è¡Œå®Œæ•´æµ‹è¯•...</p>';
            
            if (!gameEngine) {
                div.innerHTML = '<p class="error">è¯·å…ˆè¿è¡Œæ­¥éª¤1</p>';
                return;
            }
            
            log('=== å¼€å§‹å®Œæ•´æµç¨‹æµ‹è¯• ===', 'info');
            
            const steps = [
                { name: 'åˆ‡æ¢åˆ°ç™»å½•åœºæ™¯', scene: 'Login', data: null },
                { name: 'åˆ‡æ¢åˆ°è§’è‰²é€‰æ‹©åœºæ™¯', scene: 'Character', data: null },
                { name: 'åˆ‡æ¢åˆ°æ¸¸æˆåœºæ™¯ï¼ˆå¸¦æ•°æ®ï¼‰', scene: 'Game', data: { 
                    character: { 
                        id: 'full_test', 
                        name: 'å®Œæ•´æµ‹è¯•è§’è‰²', 
                        class: 'mage', 
                        level: 5 
                    } 
                }}
            ];
            
            let currentStep = 0;
            
            function runNextStep() {
                if (currentStep >= steps.length) {
                    log('=== å®Œæ•´æµç¨‹æµ‹è¯•å®Œæˆ ===', 'success');
                    div.innerHTML = '<p class="success">âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡</p>';
                    return;
                }
                
                const step = steps[currentStep];
                log(`æ­¥éª¤ ${currentStep + 1}: ${step.name}`, 'info');
                
                gameEngine.sceneManager.switchTo(step.scene, step.data);
                
                setTimeout(() => {
                    const currentScene = gameEngine.sceneManager.getCurrentScene();
                    
                    if (currentScene && currentScene.name === step.scene) {
                        log(`âœ“ ${step.name} æˆåŠŸ`, 'success');
                        
                        if (step.data && step.data.character && currentScene.character) {
                            log(`âœ“ è§’è‰²æ•°æ®: ${currentScene.character.name}`, 'success');
                        }
                        
                        currentStep++;
                        runNextStep();
                    } else {
                        log(`âœ— ${step.name} å¤±è´¥`, 'error');
                        div.innerHTML = `<p class="error">âœ— æµ‹è¯•åœ¨æ­¥éª¤ ${currentStep + 1} å¤±è´¥</p>`;
                    }
                }, 1000);
            }
            
            runNextStep();
        };

        // è‡ªåŠ¨è¿è¡Œæ­¥éª¤1
        log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡è¿è¡Œè¯Šæ–­...', 'info');
    </script>
</body>
</html>
