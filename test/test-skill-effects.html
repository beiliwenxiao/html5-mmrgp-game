<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ€èƒ½ç‰¹æ•ˆæµ‹è¯• - Skill Effects Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            overflow: hidden;
        }

        #gameCanvas {
            display: block;
            background: #2d5016;
            margin: 0 auto;
        }

        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 5px;
            max-width: 300px;
        }

        #controls h2 {
            margin-bottom: 10px;
            font-size: 18px;
            color: #ffaa00;
        }

        #controls p {
            margin: 5px 0;
            font-size: 14px;
            line-height: 1.5;
        }

        .skill-button {
            display: inline-block;
            margin: 5px;
            padding: 10px 15px;
            background: #4444ff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .skill-button:hover {
            background: #6666ff;
        }

        .skill-button:active {
            background: #2222cc;
        }

        #stats {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 5px;
            min-width: 200px;
        }

        #stats h3 {
            margin-bottom: 10px;
            font-size: 16px;
            color: #00ff88;
        }

        #stats p {
            margin: 5px 0;
            font-size: 13px;
        }

        .key {
            display: inline-block;
            padding: 2px 6px;
            background: #333;
            border: 1px solid #666;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="1200" height="800"></canvas>
    
    <div id="controls">
        <h2>ğŸ® æŠ€èƒ½ç‰¹æ•ˆæµ‹è¯•</h2>
        <p><strong>ç‚¹å‡»ç”»å¸ƒ</strong>è®¾ç½®ç›®æ ‡ä½ç½®</p>
        <p><strong>æŒ‰æ•°å­—é”®</strong>é‡Šæ”¾æŠ€èƒ½ï¼š</p>
        <p><span class="key">1</span> æ™®é€šæ”»å‡»</p>
        <p><span class="key">2</span> ç«çƒæœ¯</p>
        <p><span class="key">3</span> å†°æªæœ¯</p>
        <p><span class="key">4</span> æ²»ç–—æœ¯</p>
        <p><span class="key">5</span> å¤šé‡å°„å‡»</p>
        <p><span class="key">6</span> æ¯’ç®­</p>
        <p><span class="key">7</span> å¼ºåŠ›æ–©å‡»</p>
        <p><span class="key">8</span> æŠ¤ç›¾</p>
        <p><span class="key">C</span> æ¸…é™¤æ‰€æœ‰ç²’å­</p>
    </div>

    <div id="stats">
        <h3>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h3>
        <p>FPS: <span id="fps">60</span></p>
        <p>æ´»è·ƒç²’å­: <span id="particles">0</span></p>
        <p>æŠ›å°„ç‰©: <span id="projectiles">0</span></p>
        <p>å‘å°„å™¨: <span id="emitters">0</span></p>
    </div>

    <script type="module">
        import { ParticleSystem } from './src/rendering/ParticleSystem.js';
        import { SkillEffects } from './src/rendering/SkillEffects.js';
        import { Camera } from './src/rendering/Camera.js';

        // è·å–Canvaså’Œä¸Šä¸‹æ–‡
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // åˆ›å»ºç›¸æœºï¼ˆå‚æ•°æ˜¯ x, y, width, heightï¼‰
        const camera = new Camera(canvas.width / 2, canvas.height / 2, canvas.width, canvas.height);

        // åˆ›å»ºç²’å­ç³»ç»Ÿ
        const particleSystem = new ParticleSystem(2000);

        // åˆ›å»ºæŠ€èƒ½ç‰¹æ•ˆç³»ç»Ÿ
        const skillEffects = new SkillEffects(particleSystem);

        // ç©å®¶ä½ç½®ï¼ˆç”»å¸ƒä¸­å¿ƒï¼‰
        const playerPos = { x: canvas.width / 2, y: canvas.height / 2 };

        // ç›®æ ‡ä½ç½®
        let targetPos = null;

        // æŠ€èƒ½åˆ—è¡¨
        const skills = [
            { id: 'basic_attack', name: 'æ™®é€šæ”»å‡»', key: '1' },
            { id: 'mage_fireball', name: 'ç«çƒæœ¯', key: '2' },
            { id: 'mage_ice_lance', name: 'å†°æªæœ¯', key: '3' },
            { id: 'mage_heal', name: 'æ²»ç–—æœ¯', key: '4' },
            { id: 'archer_multi_shot', name: 'å¤šé‡å°„å‡»', key: '5' },
            { id: 'archer_poison_arrow', name: 'æ¯’ç®­', key: '6' },
            { id: 'warrior_slash', name: 'å¼ºåŠ›æ–©å‡»', key: '7' },
            { id: 'warrior_defense', name: 'æŠ¤ç›¾', key: '8' }
        ];

        // FPS è®¡ç®—
        let lastTime = performance.now();
        let frameCount = 0;
        let fps = 60;

        // é¼ æ ‡ç‚¹å‡»äº‹ä»¶
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            targetPos = {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
            console.log('ç›®æ ‡ä½ç½®è®¾ç½®ä¸º:', targetPos);
        });

        // é”®ç›˜äº‹ä»¶
        document.addEventListener('keydown', (e) => {
            // æŸ¥æ‰¾å¯¹åº”çš„æŠ€èƒ½
            const skill = skills.find(s => s.key === e.key);
            
            if (skill) {
                console.log(`é‡Šæ”¾æŠ€èƒ½: ${skill.name}`);
                
                // åˆ›å»ºæŠ€èƒ½ç‰¹æ•ˆ
                skillEffects.createSkillEffect(
                    skill.id,
                    playerPos,
                    targetPos,
                    (hitPos) => {
                        console.log(`æŠ€èƒ½å‘½ä¸­ä½ç½®:`, hitPos);
                    }
                );
            } else if (e.key.toLowerCase() === 'c') {
                // æ¸…é™¤æ‰€æœ‰ç²’å­
                particleSystem.clear();
                skillEffects.clear();
                console.log('æ¸…é™¤æ‰€æœ‰ç²’å­');
            }
        });

        // æ¸¸æˆå¾ªç¯
        function gameLoop(currentTime) {
            // è®¡ç®—æ—¶é—´å¢é‡
            const deltaTime = (currentTime - lastTime) / 1000;
            lastTime = currentTime;

            // è®¡ç®—FPS
            frameCount++;
            if (frameCount >= 60) {
                fps = Math.round(1 / deltaTime);
                frameCount = 0;
            }

            // æ›´æ–°
            update(deltaTime);

            // æ¸²æŸ“
            render();

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats();

            // ç»§ç»­å¾ªç¯
            requestAnimationFrame(gameLoop);
        }

        // æ›´æ–°é€»è¾‘
        function update(deltaTime) {
            // æ›´æ–°ç²’å­ç³»ç»Ÿ
            particleSystem.update(deltaTime);

            // æ›´æ–°æŠ€èƒ½ç‰¹æ•ˆ
            skillEffects.update(deltaTime);
        }

        // æ¸²æŸ“
        function render() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = '#2d5016';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç»˜åˆ¶ç½‘æ ¼
            drawGrid();

            // ç»˜åˆ¶ç©å®¶
            drawPlayer();

            // ç»˜åˆ¶ç›®æ ‡ä½ç½®
            if (targetPos) {
                drawTarget();
            }

            // æ¸²æŸ“ç²’å­
            particleSystem.render(ctx, camera);

            // æ¸²æŸ“æŠ›å°„ç‰©
            skillEffects.render(ctx, camera);
        }

        // ç»˜åˆ¶ç½‘æ ¼
        function drawGrid() {
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;

            // å‚ç›´çº¿
            for (let x = 0; x < canvas.width; x += 50) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }

            // æ°´å¹³çº¿
            for (let y = 0; y < canvas.height; y += 50) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }

        // ç»˜åˆ¶ç©å®¶
        function drawPlayer() {
            ctx.save();
            
            // ç»˜åˆ¶ç©å®¶åœ†åœˆ
            ctx.fillStyle = '#4444ff';
            ctx.beginPath();
            ctx.arc(playerPos.x, playerPos.y, 20, 0, Math.PI * 2);
            ctx.fill();

            // ç»˜åˆ¶è¾¹æ¡†
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.stroke();

            // ç»˜åˆ¶æ ‡ç­¾
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ç©å®¶', playerPos.x, playerPos.y - 30);

            ctx.restore();
        }

        // ç»˜åˆ¶ç›®æ ‡
        function drawTarget() {
            ctx.save();

            // ç»˜åˆ¶ç›®æ ‡åå­—
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 2;
            
            const size = 15;
            ctx.beginPath();
            ctx.moveTo(targetPos.x - size, targetPos.y);
            ctx.lineTo(targetPos.x + size, targetPos.y);
            ctx.moveTo(targetPos.x, targetPos.y - size);
            ctx.lineTo(targetPos.x, targetPos.y + size);
            ctx.stroke();

            // ç»˜åˆ¶ç›®æ ‡åœ†åœˆ
            ctx.beginPath();
            ctx.arc(targetPos.x, targetPos.y, 10, 0, Math.PI * 2);
            ctx.stroke();

            ctx.restore();
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('fps').textContent = fps;
            document.getElementById('particles').textContent = particleSystem.getActiveCount();
            document.getElementById('projectiles').textContent = skillEffects.projectiles.length;
            document.getElementById('emitters').textContent = skillEffects.activeEmitters.length;
        }

        // å¯åŠ¨æ¸¸æˆå¾ªç¯
        console.log('æŠ€èƒ½ç‰¹æ•ˆæµ‹è¯•å¯åŠ¨');
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>
