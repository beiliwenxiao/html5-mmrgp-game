<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èƒŒåŒ…é¢æ¿æµ‹è¯• - å¼ è§’é»„å·¾èµ·ä¹‰åºç« </title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #ffffff;
      overflow: hidden;
    }

    #gameCanvas {
      display: block;
      margin: 0 auto;
      background: #0f0f1e;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
    }

    .controls {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 20px;
      border-radius: 10px;
      border: 2px solid #4080ff;
      max-width: 300px;
      z-index: 1000;
    }

    .controls h2 {
      color: #4080ff;
      margin-bottom: 15px;
      font-size: 18px;
      border-bottom: 2px solid #4080ff;
      padding-bottom: 10px;
    }

    .control-group {
      margin-bottom: 15px;
    }

    .control-group label {
      display: block;
      margin-bottom: 5px;
      color: #cccccc;
      font-size: 14px;
    }

    button {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      background: linear-gradient(135deg, #4080ff 0%, #6080ff 100%);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s;
    }

    button:hover {
      background: linear-gradient(135deg, #5090ff 0%, #7090ff 100%);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(64, 128, 255, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button.danger {
      background: linear-gradient(135deg, #ff4040 0%, #ff6060 100%);
    }

    button.danger:hover {
      background: linear-gradient(135deg, #ff5050 0%, #ff7070 100%);
    }

    .info {
      background: rgba(40, 40, 60, 0.6);
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      font-size: 12px;
      line-height: 1.6;
    }

    .info p {
      margin: 5px 0;
    }

    .info .label {
      color: #4080ff;
      font-weight: bold;
    }

    .status {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px;
      border-radius: 10px;
      border: 2px solid #40ff40;
      max-width: 300px;
      z-index: 1000;
    }

    .status h3 {
      color: #40ff40;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .status p {
      margin: 5px 0;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="1200" height="800"></canvas>

  <div class="controls">
    <h2>ğŸ’ èƒŒåŒ…é¢æ¿æµ‹è¯•</h2>
    
    <div class="control-group">
      <button id="togglePanel">åˆ‡æ¢èƒŒåŒ…é¢æ¿ (I)</button>
      <button id="addEquipment">æ·»åŠ è£…å¤‡</button>
      <button id="addConsumable">æ·»åŠ æ¶ˆè€—å“</button>
      <button id="addMaterial">æ·»åŠ ææ–™</button>
      <button id="fillInventory">å¡«æ»¡èƒŒåŒ…</button>
      <button id="clearInventory" class="danger">æ¸…ç©ºèƒŒåŒ…</button>
    </div>

    <div class="info">
      <p><span class="label">æ“ä½œè¯´æ˜:</span></p>
      <p>â€¢ æŒ‰ I é”®åˆ‡æ¢èƒŒåŒ…é¢æ¿</p>
      <p>â€¢ å·¦é”®æ‹–æ‹½ç‰©å“ç§»åŠ¨</p>
      <p>â€¢ å³é”®ä½¿ç”¨/è£…å¤‡ç‰©å“</p>
      <p>â€¢ æ‚¬åœæŸ¥çœ‹ç‰©å“è¯¦æƒ…</p>
      <p>â€¢ ç‚¹å‡»ç­›é€‰æŒ‰é’®è¿‡æ»¤ç‰©å“</p>
    </div>
  </div>

  <div class="status">
    <h3>ğŸ“Š èƒŒåŒ…çŠ¶æ€</h3>
    <p>å®¹é‡: <span id="capacity">0/30</span></p>
    <p>è£…å¤‡: <span id="equipmentCount">0</span></p>
    <p>æ¶ˆè€—å“: <span id="consumableCount">0</span></p>
    <p>ææ–™: <span id="materialCount">0</span></p>
    <p>æœ€åæ“ä½œ: <span id="lastAction">æ— </span></p>
  </div>

  <script type="module">
    import { InventorySystem } from '../src/prologue/systems/InventorySystem.js';
    import { InventoryPanel } from '../src/prologue/ui/InventoryPanel.js';

    // è·å–Canvaså’Œä¸Šä¸‹æ–‡
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // åˆ›å»ºèƒŒåŒ…ç³»ç»Ÿ
    const inventorySystem = new InventorySystem(30);

    // åˆ›å»ºèƒŒåŒ…é¢æ¿
    const inventoryPanel = new InventoryPanel({
      x: 300,
      y: 100,
      width: 600,
      height: 600,
      inventorySystem: inventorySystem,
      visible: true,  // é»˜è®¤æ˜¾ç¤º
      onItemUse: (item) => {
        console.log('ä½¿ç”¨ç‰©å“:', item.name);
        updateStatus(`ä½¿ç”¨äº† ${item.name}`);
        // ç§»é™¤æ¶ˆè€—å“
        inventorySystem.removeItem(item.id, 1);
      },
      onItemEquip: (item) => {
        console.log('è£…å¤‡ç‰©å“:', item.name);
        updateStatus(`è£…å¤‡äº† ${item.name}`);
      }
    });

    // ç¤ºä¾‹ç‰©å“æ•°æ®
    const sampleItems = {
      equipment: [
        {
          id: 'sword1',
          name: 'æœ¨å‰‘',
          type: 'equipment',
          description: 'ç®€é™‹çš„æœ¨åˆ¶æ­¦å™¨ï¼ŒèŠèƒœäºæ— ',
          stackable: false,
          attributes: { attack: 5, defense: 0, health: 0, speed: 0 }
        },
        {
          id: 'armor1',
          name: 'å¸ƒè¡£',
          type: 'equipment',
          description: 'æ™®é€šçš„å¸ƒåˆ¶è¡£æœï¼Œæä¾›åŸºç¡€é˜²æŠ¤',
          stackable: false,
          attributes: { attack: 0, defense: 3, health: 10, speed: 0 }
        },
        {
          id: 'ring1',
          name: 'é“œæˆ’æŒ‡',
          type: 'equipment',
          description: 'ç®€å•çš„é“œåˆ¶æˆ’æŒ‡',
          stackable: false,
          attributes: { attack: 1, defense: 1, health: 5, speed: 2 }
        }
      ],
      consumable: [
        {
          id: 'potion',
          name: 'è¯æ°´',
          type: 'consumable',
          description: 'æ¢å¤50ç‚¹ç”Ÿå‘½å€¼',
          stackable: true,
          maxStack: 99
        },
        {
          id: 'food',
          name: 'å¹²ç²®',
          type: 'consumable',
          description: 'æ¢å¤30ç‚¹ç”Ÿå‘½å€¼',
          stackable: true,
          maxStack: 99
        },
        {
          id: 'talisman',
          name: 'ç¬¦æ°´',
          type: 'consumable',
          description: 'å¼ è§’çš„ç¬¦æ°´ï¼Œæ¢å¤50ç‚¹ç”Ÿå‘½å€¼',
          stackable: true,
          maxStack: 20
        }
      ],
      material: [
        {
          id: 'wood',
          name: 'æœ¨æ',
          type: 'material',
          description: 'æ™®é€šçš„æœ¨æï¼Œå¯ç”¨äºåˆ¶ä½œ',
          stackable: true,
          maxStack: 99
        },
        {
          id: 'iron',
          name: 'é“çŸ¿',
          type: 'material',
          description: 'é“çŸ¿çŸ³ï¼Œå¯ç”¨äºé”»é€ ',
          stackable: true,
          maxStack: 99
        },
        {
          id: 'cloth',
          name: 'å¸ƒæ–™',
          type: 'material',
          description: 'æ™®é€šå¸ƒæ–™ï¼Œå¯ç”¨äºç¼åˆ¶',
          stackable: true,
          maxStack: 99
        }
      ]
    };

    // é¼ æ ‡çŠ¶æ€
    let mouseX = 0;
    let mouseY = 0;
    let mouseDown = false;

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatus(action = null) {
      const capacity = `${inventorySystem.getUsedSlots()}/${inventorySystem.maxSlots}`;
      document.getElementById('capacity').textContent = capacity;
      
      const equipmentCount = inventorySystem.getItemsByType('equipment').length;
      const consumableCount = inventorySystem.getItemsByType('consumable').length;
      const materialCount = inventorySystem.getItemsByType('material').length;
      
      document.getElementById('equipmentCount').textContent = equipmentCount;
      document.getElementById('consumableCount').textContent = consumableCount;
      document.getElementById('materialCount').textContent = materialCount;
      
      if (action) {
        document.getElementById('lastAction').textContent = action;
      }
    }

    // æ·»åŠ éšæœºè£…å¤‡
    function addRandomEquipment() {
      const items = sampleItems.equipment;
      const item = items[Math.floor(Math.random() * items.length)];
      const newItem = { ...item, id: `${item.id}_${Date.now()}` };
      
      if (inventorySystem.addItem(newItem)) {
        updateStatus(`æ·»åŠ äº† ${item.name}`);
      } else {
        updateStatus('èƒŒåŒ…å·²æ»¡ï¼');
      }
    }

    // æ·»åŠ éšæœºæ¶ˆè€—å“
    function addRandomConsumable() {
      const items = sampleItems.consumable;
      const item = items[Math.floor(Math.random() * items.length)];
      const quantity = Math.floor(Math.random() * 10) + 1;
      
      if (inventorySystem.addItem(item, quantity)) {
        updateStatus(`æ·»åŠ äº† ${quantity} ä¸ª ${item.name}`);
      } else {
        updateStatus('èƒŒåŒ…å·²æ»¡ï¼');
      }
    }

    // æ·»åŠ éšæœºææ–™
    function addRandomMaterial() {
      const items = sampleItems.material;
      const item = items[Math.floor(Math.random() * items.length)];
      const quantity = Math.floor(Math.random() * 20) + 1;
      
      if (inventorySystem.addItem(item, quantity)) {
        updateStatus(`æ·»åŠ äº† ${quantity} ä¸ª ${item.name}`);
      } else {
        updateStatus('èƒŒåŒ…å·²æ»¡ï¼');
      }
    }

    // å¡«æ»¡èƒŒåŒ…
    function fillInventory() {
      while (!inventorySystem.isFull()) {
        const type = Math.random();
        if (type < 0.3) {
          addRandomEquipment();
        } else if (type < 0.6) {
          addRandomConsumable();
        } else {
          addRandomMaterial();
        }
      }
      updateStatus('èƒŒåŒ…å·²å¡«æ»¡');
    }

    // æ¸…ç©ºèƒŒåŒ…
    function clearInventory() {
      inventorySystem.clear();
      updateStatus('èƒŒåŒ…å·²æ¸…ç©º');
    }

    // äº‹ä»¶ç›‘å¬
    document.getElementById('togglePanel').addEventListener('click', () => {
      inventoryPanel.toggle();
      updateStatus(inventoryPanel.visible ? 'æ‰“å¼€èƒŒåŒ…' : 'å…³é—­èƒŒåŒ…');
    });

    document.getElementById('addEquipment').addEventListener('click', addRandomEquipment);
    document.getElementById('addConsumable').addEventListener('click', addRandomConsumable);
    document.getElementById('addMaterial').addEventListener('click', addRandomMaterial);
    document.getElementById('fillInventory').addEventListener('click', fillInventory);
    document.getElementById('clearInventory').addEventListener('click', clearInventory);

    // é”®ç›˜äº‹ä»¶
    document.addEventListener('keydown', (e) => {
      if (e.key === 'i' || e.key === 'I') {
        inventoryPanel.toggle();
        updateStatus(inventoryPanel.visible ? 'æ‰“å¼€èƒŒåŒ…' : 'å…³é—­èƒŒåŒ…');
      }
    });

    // é¼ æ ‡äº‹ä»¶
    canvas.addEventListener('mousemove', (e) => {
      const rect = canvas.getBoundingClientRect();
      mouseX = e.clientX - rect.left;
      mouseY = e.clientY - rect.top;
      
      inventoryPanel.handleMouseMove(mouseX, mouseY);
    });

    canvas.addEventListener('mousedown', (e) => {
      const rect = canvas.getBoundingClientRect();
      mouseX = e.clientX - rect.left;
      mouseY = e.clientY - rect.top;
      mouseDown = true;
      
      inventoryPanel.handleMouseDown(mouseX, mouseY, e.button);
      e.preventDefault();
    });

    canvas.addEventListener('mouseup', (e) => {
      const rect = canvas.getBoundingClientRect();
      mouseX = e.clientX - rect.left;
      mouseY = e.clientY - rect.top;
      mouseDown = false;
      
      inventoryPanel.handleMouseUp(mouseX, mouseY);
    });

    canvas.addEventListener('contextmenu', (e) => {
      e.preventDefault();
    });

    // æ¸²æŸ“å¾ªç¯
    let lastTime = 0;
    function gameLoop(currentTime) {
      const deltaTime = currentTime - lastTime;
      lastTime = currentTime;

      // æ¸…ç©ºç”»å¸ƒ
      ctx.fillStyle = '#0f0f1e';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // ç»˜åˆ¶èƒŒæ™¯ç½‘æ ¼
      ctx.strokeStyle = 'rgba(64, 128, 255, 0.1)';
      ctx.lineWidth = 1;
      for (let x = 0; x < canvas.width; x += 50) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }
      for (let y = 0; y < canvas.height; y += 50) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }

      // ç»˜åˆ¶æ ‡é¢˜
      ctx.fillStyle = '#4080ff';
      ctx.font = 'bold 32px Arial, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillText('èƒŒåŒ…é¢æ¿æµ‹è¯•', canvas.width / 2, 30);

      ctx.fillStyle = '#cccccc';
      ctx.font = '16px Arial, sans-serif';
      ctx.fillText('æŒ‰ I é”®æ‰“å¼€/å…³é—­èƒŒåŒ…é¢æ¿', canvas.width / 2, 70);

      // æ›´æ–°å’Œæ¸²æŸ“èƒŒåŒ…é¢æ¿
      inventoryPanel.update(deltaTime);
      inventoryPanel.render(ctx);

      // ç»˜åˆ¶é¼ æ ‡åæ ‡ï¼ˆè°ƒè¯•ç”¨ï¼‰
      if (inventoryPanel.visible) {
        ctx.fillStyle = '#888888';
        ctx.font = '12px monospace';
        ctx.textAlign = 'left';
        ctx.fillText(`é¼ æ ‡: (${mouseX}, ${mouseY})`, 10, canvas.height - 20);
      }

      requestAnimationFrame(gameLoop);
    }

    // åˆå§‹åŒ–
    updateStatus('åˆå§‹åŒ–å®Œæˆ');
    
    // æ·»åŠ ä¸€äº›åˆå§‹ç‰©å“
    inventorySystem.addItem(sampleItems.equipment[0]);
    inventorySystem.addItem(sampleItems.consumable[0], 5);
    inventorySystem.addItem(sampleItems.material[0], 10);
    updateStatus('æ·»åŠ äº†åˆå§‹ç‰©å“');

    // å¯åŠ¨æ¸¸æˆå¾ªç¯
    requestAnimationFrame(gameLoop);

    console.log('èƒŒåŒ…é¢æ¿æµ‹è¯•å·²å¯åŠ¨');
    console.log('èƒŒåŒ…ç³»ç»Ÿ:', inventorySystem);
    console.log('èƒŒåŒ…é¢æ¿:', inventoryPanel);
  </script>
</body>
</html>
