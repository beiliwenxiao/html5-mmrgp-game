<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´æ¸¸æˆæµç¨‹æµ‹è¯•</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #1a1a2e;
            color: #ffffff;
        }
        
        #test-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: #4a9eff;
            text-align: center;
        }
        
        #game-container {
            position: relative;
            width: 1280px;
            height: 720px;
            margin: 20px auto;
            border: 2px solid #4a9eff;
            background: #000;
        }
        
        #game-canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        #test-controls {
            background: #2a2a4e;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .control-group {
            margin: 15px 0;
        }
        
        .control-group h3 {
            color: #4a9eff;
            margin-bottom: 10px;
        }
        
        button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background: #5aa9ff;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        #test-log {
            background: #1e1e3e;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #4a9eff;
            padding-left: 10px;
        }
        
        .log-success {
            border-left-color: #51cf66;
            color: #51cf66;
        }
        
        .log-error {
            border-left-color: #ff6b6b;
            color: #ff6b6b;
        }
        
        .log-info {
            border-left-color: #4a9eff;
            color: #aaaaaa;
        }
        
        #test-status {
            background: #2a2a4e;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px;
            background: #1e1e3e;
            border-radius: 4px;
        }
        
        .status-label {
            font-weight: bold;
        }
        
        .status-value {
            color: #4a9eff;
        }
        
        .status-pass {
            color: #51cf66;
        }
        
        .status-fail {
            color: #ff6b6b;
        }
    </style>
</head>
<body>
    <div id="test-container">
        <h1>ğŸ® å®Œæ•´æ¸¸æˆæµç¨‹æµ‹è¯•</h1>
        
        <div id="game-container">
            <canvas id="game-canvas" width="1280" height="720"></canvas>
        </div>
        
        <div id="test-controls">
            <div class="control-group">
                <h3>åœºæ™¯æµ‹è¯•</h3>
                <button onclick="testLoginScene()">æµ‹è¯•ç™»å½•åœºæ™¯</button>
                <button onclick="testCharacterScene()">æµ‹è¯•è§’è‰²é€‰æ‹©åœºæ™¯</button>
                <button onclick="testGameScene()">æµ‹è¯•æ¸¸æˆåœºæ™¯</button>
                <button onclick="testCompleteFlow()">æµ‹è¯•å®Œæ•´æµç¨‹</button>
            </div>
            
            <div class="control-group">
                <h3>åŠŸèƒ½æµ‹è¯•</h3>
                <button onclick="testMovement()">æµ‹è¯•ç§»åŠ¨</button>
                <button onclick="testCombat()">æµ‹è¯•æˆ˜æ–—</button>
                <button onclick="testSkills()">æµ‹è¯•æŠ€èƒ½</button>
                <button onclick="testUI()">æµ‹è¯•UI</button>
            </div>
            
            <div class="control-group">
                <h3>æ§åˆ¶</h3>
                <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
                <button onclick="resetGame()">é‡ç½®æ¸¸æˆ</button>
            </div>
        </div>
        
        <div id="test-status">
            <h3>æµ‹è¯•çŠ¶æ€</h3>
            <div class="status-item">
                <span class="status-label">å½“å‰åœºæ™¯:</span>
                <span class="status-value" id="current-scene">-</span>
            </div>
            <div class="status-item">
                <span class="status-label">FPS:</span>
                <span class="status-value" id="fps-value">-</span>
            </div>
            <div class="status-item">
                <span class="status-label">å®ä½“æ•°é‡:</span>
                <span class="status-value" id="entity-count">-</span>
            </div>
            <div class="status-item">
                <span class="status-label">æµ‹è¯•é€šè¿‡:</span>
                <span class="status-value" id="tests-passed">0</span>
            </div>
            <div class="status-item">
                <span class="status-label">æµ‹è¯•å¤±è´¥:</span>
                <span class="status-value" id="tests-failed">0</span>
            </div>
        </div>
        
        <div id="test-log">
            <div class="log-entry log-info">æµ‹è¯•æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
        </div>
    </div>

    <script type="module">
        import { GameEngine } from './src/core/GameEngine.js';
        
        let gameEngine = null;
        let testsPassed = 0;
        let testsFailed = 0;
        
        // åˆå§‹åŒ–æ¸¸æˆ
        async function initGame() {
            try {
                const canvas = document.getElementById('game-canvas');
                gameEngine = new GameEngine(canvas);
                window.gameEngine = gameEngine;
                
                await gameEngine.init();
                gameEngine.start();
                
                log('æ¸¸æˆå¼•æ“åˆå§‹åŒ–æˆåŠŸ', 'success');
                updateStatus();
                
                // å¯åŠ¨çŠ¶æ€æ›´æ–°
                setInterval(updateStatus, 1000);
                
                return true;
            } catch (error) {
                log('æ¸¸æˆå¼•æ“åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                return false;
            }
        }
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus() {
            if (!gameEngine) return;
            
            // å½“å‰åœºæ™¯
            const currentScene = gameEngine.sceneManager?.currentScene?.name || '-';
            document.getElementById('current-scene').textContent = currentScene;
            
            // FPS
            const fps = gameEngine.performanceMonitor?.getFPS() || 0;
            document.getElementById('fps-value').textContent = fps.toFixed(1);
            
            // å®ä½“æ•°é‡
            const scene = gameEngine.sceneManager?.currentScene;
            let entityCount = 0;
            if (scene && scene.entities) {
                entityCount = scene.entities.length;
            }
            document.getElementById('entity-count').textContent = entityCount;
            
            // æµ‹è¯•ç»Ÿè®¡
            document.getElementById('tests-passed').textContent = testsPassed;
            document.getElementById('tests-failed').textContent = testsFailed;
        }
        
        // æµ‹è¯•æ–­è¨€
        function assert(condition, message) {
            if (condition) {
                testsPassed++;
                log(`âœ“ ${message}`, 'success');
                return true;
            } else {
                testsFailed++;
                log(`âœ— ${message}`, 'error');
                return false;
            }
        }
        
        // ç­‰å¾…å‡½æ•°
        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // æµ‹è¯•ç™»å½•åœºæ™¯
        window.testLoginScene = async function() {
            log('å¼€å§‹æµ‹è¯•ç™»å½•åœºæ™¯...', 'info');
            
            try {
                gameEngine.sceneManager.switchTo('Login');
                await wait(500);
                
                const scene = gameEngine.sceneManager.currentScene;
                assert(scene.name === 'Login', 'ç™»å½•åœºæ™¯åŠ è½½æˆåŠŸ');
                assert(scene.title === 'HTML5 MMRPG', 'æ ‡é¢˜æ˜¾ç¤ºæ­£ç¡®');
                assert(scene.startButton !== undefined, 'å¼€å§‹æŒ‰é’®å­˜åœ¨');
                
                log('ç™»å½•åœºæ™¯æµ‹è¯•å®Œæˆ', 'success');
            } catch (error) {
                log('ç™»å½•åœºæ™¯æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        };
        
        // æµ‹è¯•è§’è‰²é€‰æ‹©åœºæ™¯
        window.testCharacterScene = async function() {
            log('å¼€å§‹æµ‹è¯•è§’è‰²é€‰æ‹©åœºæ™¯...', 'info');
            
            try {
                gameEngine.sceneManager.switchTo('Character');
                await wait(500);
                
                const scene = gameEngine.sceneManager.currentScene;
                assert(scene.name === 'Character', 'è§’è‰²é€‰æ‹©åœºæ™¯åŠ è½½æˆåŠŸ');
                assert(scene.mode === 'list', 'åˆå§‹æ¨¡å¼ä¸ºåˆ—è¡¨æ¨¡å¼');
                assert(scene.classes !== undefined, 'èŒä¸šæ•°æ®å­˜åœ¨');
                assert(Object.keys(scene.classes).length === 3, 'æœ‰3ä¸ªèŒä¸šå¯é€‰');
                
                // æµ‹è¯•åˆ‡æ¢åˆ°åˆ›å»ºæ¨¡å¼
                scene.mode = 'create';
                await wait(100);
                assert(scene.mode === 'create', 'åˆ‡æ¢åˆ°åˆ›å»ºæ¨¡å¼æˆåŠŸ');
                
                // æµ‹è¯•è§’è‰²åç§°éªŒè¯
                assert(!scene.validateCharacterName(''), 'ç©ºåç§°éªŒè¯å¤±è´¥');
                assert(!scene.validateCharacterName('a'), 'çŸ­åç§°éªŒè¯å¤±è´¥');
                assert(scene.validateCharacterName('æµ‹è¯•è§’è‰²'), 'æœ‰æ•ˆåç§°éªŒè¯é€šè¿‡');
                
                log('è§’è‰²é€‰æ‹©åœºæ™¯æµ‹è¯•å®Œæˆ', 'success');
            } catch (error) {
                log('è§’è‰²é€‰æ‹©åœºæ™¯æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        };
        
        // æµ‹è¯•æ¸¸æˆåœºæ™¯
        window.testGameScene = async function() {
            log('å¼€å§‹æµ‹è¯•æ¸¸æˆåœºæ™¯...', 'info');
            
            try {
                const testCharacter = {
                    id: 'test-1',
                    name: 'æµ‹è¯•è§’è‰²',
                    class: 'warrior',
                    level: 1,
                    stats: { hp: 150, maxHp: 150, mp: 50, maxMp: 50, attack: 15, defense: 10, speed: 150 },
                    skills: ['basic_attack', 'power_strike'],
                    position: { x: 640, y: 360 }
                };
                
                gameEngine.sceneManager.switchTo('Game', { character: testCharacter });
                await wait(1000);
                
                const scene = gameEngine.sceneManager.currentScene;
                assert(scene.name === 'Game', 'æ¸¸æˆåœºæ™¯åŠ è½½æˆåŠŸ');
                assert(scene.player !== undefined, 'ç©å®¶å®ä½“å­˜åœ¨');
                assert(scene.entities.length > 0, 'åœºæ™¯ä¸­æœ‰å®ä½“');
                
                // æµ‹è¯•ç³»ç»Ÿ
                assert(scene.renderSystem !== undefined, 'æ¸²æŸ“ç³»ç»Ÿå­˜åœ¨');
                assert(scene.movementSystem !== undefined, 'ç§»åŠ¨ç³»ç»Ÿå­˜åœ¨');
                assert(scene.combatSystem !== undefined, 'æˆ˜æ–—ç³»ç»Ÿå­˜åœ¨');
                assert(scene.uiSystem !== undefined, 'UIç³»ç»Ÿå­˜åœ¨');
                
                log('æ¸¸æˆåœºæ™¯æµ‹è¯•å®Œæˆ', 'success');
            } catch (error) {
                log('æ¸¸æˆåœºæ™¯æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        };
        
        // æµ‹è¯•å®Œæ•´æµç¨‹
        window.testCompleteFlow = async function() {
            log('========================================', 'info');
            log('å¼€å§‹æµ‹è¯•å®Œæ•´æ¸¸æˆæµç¨‹...', 'info');
            log('========================================', 'info');
            
            try {
                // 1. ç™»å½•åœºæ™¯
                log('æ­¥éª¤ 1: æµ‹è¯•ç™»å½•åœºæ™¯', 'info');
                gameEngine.sceneManager.switchTo('Login');
                await wait(1000);
                assert(gameEngine.sceneManager.currentScene.name === 'Login', 'è¿›å…¥ç™»å½•åœºæ™¯');
                
                // 2. åˆ‡æ¢åˆ°è§’è‰²é€‰æ‹©
                log('æ­¥éª¤ 2: åˆ‡æ¢åˆ°è§’è‰²é€‰æ‹©åœºæ™¯', 'info');
                gameEngine.sceneManager.switchTo('Character');
                await wait(1000);
                assert(gameEngine.sceneManager.currentScene.name === 'Character', 'è¿›å…¥è§’è‰²é€‰æ‹©åœºæ™¯');
                
                // 3. åˆ›å»ºè§’è‰²
                log('æ­¥éª¤ 3: åˆ›å»ºæµ‹è¯•è§’è‰²', 'info');
                const scene = gameEngine.sceneManager.currentScene;
                scene.mode = 'create';
                scene.createForm.nameInput = 'æµç¨‹æµ‹è¯•è§’è‰²';
                scene.createForm.selectedClass = 'mage';
                await wait(500);
                assert(scene.createForm.nameInput === 'æµç¨‹æµ‹è¯•è§’è‰²', 'è§’è‰²åç§°è®¾ç½®æˆåŠŸ');
                assert(scene.createForm.selectedClass === 'mage', 'èŒä¸šé€‰æ‹©æˆåŠŸ');
                
                // 4. è¿›å…¥æ¸¸æˆ
                log('æ­¥éª¤ 4: è¿›å…¥æ¸¸æˆåœºæ™¯', 'info');
                const testCharacter = {
                    id: 'flow-test-1',
                    name: 'æµç¨‹æµ‹è¯•è§’è‰²',
                    class: 'mage',
                    level: 1,
                    stats: { hp: 80, maxHp: 80, mp: 150, maxMp: 150, attack: 25, defense: 5, speed: 180 },
                    skills: ['basic_attack', 'fireball', 'ice_lance'],
                    position: { x: 640, y: 360 }
                };
                gameEngine.sceneManager.switchTo('Game', { character: testCharacter });
                await wait(1500);
                assert(gameEngine.sceneManager.currentScene.name === 'Game', 'è¿›å…¥æ¸¸æˆåœºæ™¯');
                
                const gameScene = gameEngine.sceneManager.currentScene;
                assert(gameScene.player !== undefined, 'ç©å®¶è§’è‰²åˆ›å»ºæˆåŠŸ');
                
                log('========================================', 'info');
                log('å®Œæ•´æµç¨‹æµ‹è¯•å®Œæˆï¼', 'success');
                log('========================================', 'info');
            } catch (error) {
                log('å®Œæ•´æµç¨‹æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        };
        
        // æµ‹è¯•ç§»åŠ¨
        window.testMovement = async function() {
            log('å¼€å§‹æµ‹è¯•ç§»åŠ¨åŠŸèƒ½...', 'info');
            
            try {
                const scene = gameEngine.sceneManager.currentScene;
                if (scene.name !== 'Game') {
                    log('è¯·å…ˆè¿›å…¥æ¸¸æˆåœºæ™¯', 'error');
                    return;
                }
                
                const player = scene.player;
                const initialX = player.transform.position.x;
                const initialY = player.transform.position.y;
                
                // æ¨¡æ‹Ÿé”®ç›˜ç§»åŠ¨
                log('æµ‹è¯•é”®ç›˜ç§»åŠ¨ (Wé”®)', 'info');
                gameEngine.inputManager.keys.set('w', true);
                await wait(500);
                gameEngine.inputManager.keys.set('w', false);
                
                const movedY = player.transform.position.y;
                assert(movedY < initialY, 'å‘ä¸Šç§»åŠ¨æˆåŠŸ');
                
                // æ¨¡æ‹Ÿç‚¹å‡»ç§»åŠ¨
                log('æµ‹è¯•ç‚¹å‡»ç§»åŠ¨', 'info');
                const targetX = initialX + 100;
                const targetY = initialY;
                
                if (player.movement) {
                    player.movement.path = [{ x: targetX, y: targetY }];
                    player.movement.isMoving = true;
                }
                
                await wait(1000);
                assert(player.movement.path.length === 0 || !player.movement.isMoving, 'ç‚¹å‡»ç§»åŠ¨å®Œæˆ');
                
                log('ç§»åŠ¨åŠŸèƒ½æµ‹è¯•å®Œæˆ', 'success');
            } catch (error) {
                log('ç§»åŠ¨åŠŸèƒ½æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        };
        
        // æµ‹è¯•æˆ˜æ–—
        window.testCombat = async function() {
            log('å¼€å§‹æµ‹è¯•æˆ˜æ–—åŠŸèƒ½...', 'info');
            
            try {
                const scene = gameEngine.sceneManager.currentScene;
                if (scene.name !== 'Game') {
                    log('è¯·å…ˆè¿›å…¥æ¸¸æˆåœºæ™¯', 'error');
                    return;
                }
                
                const player = scene.player;
                const enemies = scene.entities.filter(e => e.type === 'enemy');
                
                assert(enemies.length > 0, 'åœºæ™¯ä¸­æœ‰æ•Œäºº');
                
                if (enemies.length > 0) {
                    const enemy = enemies[0];
                    const initialHp = enemy.stats.hp;
                    
                    // è®¾ç½®ç›®æ ‡
                    if (player.combat) {
                        player.combat.target = enemy;
                        log('è®¾ç½®æ”»å‡»ç›®æ ‡', 'info');
                    }
                    
                    // ç­‰å¾…æ”»å‡»
                    await wait(2000);
                    
                    // æ£€æŸ¥æ˜¯å¦é€ æˆä¼¤å®³
                    if (enemy.stats.hp < initialHp) {
                        assert(true, 'æˆåŠŸå¯¹æ•Œäººé€ æˆä¼¤å®³');
                    } else {
                        log('æœªé€ æˆä¼¤å®³ï¼ˆå¯èƒ½è·ç¦»å¤ªè¿œæˆ–å†·å´ä¸­ï¼‰', 'info');
                    }
                }
                
                log('æˆ˜æ–—åŠŸèƒ½æµ‹è¯•å®Œæˆ', 'success');
            } catch (error) {
                log('æˆ˜æ–—åŠŸèƒ½æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        };
        
        // æµ‹è¯•æŠ€èƒ½
        window.testSkills = async function() {
            log('å¼€å§‹æµ‹è¯•æŠ€èƒ½åŠŸèƒ½...', 'info');
            
            try {
                const scene = gameEngine.sceneManager.currentScene;
                if (scene.name !== 'Game') {
                    log('è¯·å…ˆè¿›å…¥æ¸¸æˆåœºæ™¯', 'error');
                    return;
                }
                
                const player = scene.player;
                assert(player.combat !== undefined, 'ç©å®¶æœ‰æˆ˜æ–—ç»„ä»¶');
                assert(player.combat.skills.length > 0, 'ç©å®¶æœ‰æŠ€èƒ½');
                
                const skill = player.combat.skills[0];
                assert(skill.id !== undefined, 'æŠ€èƒ½æœ‰ID');
                assert(skill.name !== undefined, 'æŠ€èƒ½æœ‰åç§°');
                assert(skill.cooldown !== undefined, 'æŠ€èƒ½æœ‰å†·å´æ—¶é—´');
                
                log(`ç©å®¶æŠ€èƒ½: ${player.combat.skills.map(s => s.name).join(', ')}`, 'info');
                
                log('æŠ€èƒ½åŠŸèƒ½æµ‹è¯•å®Œæˆ', 'success');
            } catch (error) {
                log('æŠ€èƒ½åŠŸèƒ½æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        };
        
        // æµ‹è¯•UI
        window.testUI = async function() {
            log('å¼€å§‹æµ‹è¯•UIåŠŸèƒ½...', 'info');
            
            try {
                const scene = gameEngine.sceneManager.currentScene;
                if (scene.name !== 'Game') {
                    log('è¯·å…ˆè¿›å…¥æ¸¸æˆåœºæ™¯', 'error');
                    return;
                }
                
                assert(scene.uiSystem !== undefined, 'UIç³»ç»Ÿå­˜åœ¨');
                assert(scene.uiSystem.healthBar !== undefined, 'ç”Ÿå‘½å€¼æ¡å­˜åœ¨');
                assert(scene.uiSystem.manaBar !== undefined, 'é­”æ³•å€¼æ¡å­˜åœ¨');
                assert(scene.uiSystem.skillBar !== undefined, 'æŠ€èƒ½æ å­˜åœ¨');
                assert(scene.uiSystem.minimap !== undefined, 'å°åœ°å›¾å­˜åœ¨');
                
                log('UIåŠŸèƒ½æµ‹è¯•å®Œæˆ', 'success');
            } catch (error) {
                log('UIåŠŸèƒ½æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        };
        
        // æ¸…ç©ºæ—¥å¿—
        window.clearLog = function() {
            document.getElementById('test-log').innerHTML = '';
            log('æ—¥å¿—å·²æ¸…ç©º', 'info');
        };
        
        // é‡ç½®æ¸¸æˆ
        window.resetGame = async function() {
            log('é‡ç½®æ¸¸æˆ...', 'info');
            testsPassed = 0;
            testsFailed = 0;
            
            if (gameEngine) {
                gameEngine.stop();
            }
            
            await wait(500);
            await initGame();
            
            log('æ¸¸æˆé‡ç½®å®Œæˆ', 'success');
        };
        
        // å¯åŠ¨æ¸¸æˆ
        initGame();
    </script>
</body>
</html>
