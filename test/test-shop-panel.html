<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å•†åº—é¢æ¿æµ‹è¯• - ShopPanel Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #ffffff;
      overflow: hidden;
    }
    
    #gameCanvas {
      display: block;
      background: #0f0f1e;
      cursor: default;
    }
    
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #444;
      max-width: 300px;
    }
    
    .controls h3 {
      margin-bottom: 10px;
      color: #4CAF50;
      font-size: 16px;
    }
    
    .controls button {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }
    
    .controls button:hover {
      background: #45a049;
    }
    
    .controls button:active {
      background: #3d8b40;
    }
    
    .info {
      margin-top: 10px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      font-size: 12px;
      line-height: 1.6;
    }
    
    .info p {
      margin: 3px 0;
    }
    
    .status {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid #444;
      font-size: 12px;
    }
    
    .status.success {
      border-color: #4CAF50;
      color: #4CAF50;
    }
    
    .status.error {
      border-color: #f44336;
      color: #f44336;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  
  <div class="controls">
    <h3>ğŸª å•†åº—é¢æ¿æµ‹è¯•</h3>
    <div style="background: rgba(100, 200, 100, 0.2); padding: 8px; margin-bottom: 10px; border-radius: 4px; font-size: 11px;">
      <strong>âœ… è¿è¡Œæ–¹æ³•:</strong><br>
      1. è¿è¡Œ: <code>npm run dev</code><br>
      2. è®¿é—®: <code>http://localhost:5173/test/test-shop-panel.html</code>
    </div>
    <button id="btnToggleShop">æ‰“å¼€/å…³é—­å•†åº—</button>
    <button id="btnToggleInventory">æ‰“å¼€/å…³é—­èƒŒåŒ…</button>
    <button id="btnAddCurrency">å¢åŠ è´§å¸ (+100)</button>
    <button id="btnAddItem">æ·»åŠ ç‰©å“åˆ°èƒŒåŒ…</button>
    <button id="btnResetShop">é‡ç½®å•†åº—</button>
    
    <div class="info">
      <p><strong>æ“ä½œè¯´æ˜:</strong></p>
      <p><strong>å•†åº—:</strong></p>
      <p>â€¢ ç‚¹å‡»æ ‡ç­¾é¡µåˆ‡æ¢è´­ä¹°/å‡ºå”®æ¨¡å¼</p>
      <p>â€¢ ç‚¹å‡»ç‰©å“é€‰æ‹©è¦äº¤æ˜“çš„ç‰©å“</p>
      <p>â€¢ ä½¿ç”¨ +/- æŒ‰é’®è°ƒæ•´æ•°é‡</p>
      <p>â€¢ ç‚¹å‡»è´­ä¹°/å‡ºå”®æŒ‰é’®å®Œæˆäº¤æ˜“</p>
      <p><strong>èƒŒåŒ…:</strong></p>
      <p>â€¢ æ‹–æ‹½ç‰©å“å¯ä»¥ç§»åŠ¨ä½ç½®</p>
      <p>â€¢ å³é”®ç‰©å“å¯ä»¥ä½¿ç”¨/è£…å¤‡</p>
      <p>â€¢ ç‚¹å‡»ç­›é€‰æŒ‰é’®è¿‡æ»¤ç‰©å“ç±»å‹</p>
      <p>â€¢ é¼ æ ‡æ‚¬åœæŸ¥çœ‹ç‰©å“è¯¦æƒ…</p>
    </div>
  </div>
  
  <div id="statusMessage" class="status" style="display: none;"></div>

  <script type="module">
    import { ShopPanel } from '../src/prologue/ui/ShopPanel.js';
    import { ShopSystem } from '../src/prologue/systems/ShopSystem.js';
    import { InventorySystem } from '../src/prologue/systems/InventorySystem.js';
    import { InventoryPanel } from '../src/prologue/ui/InventoryPanel.js';

    console.log('æ¨¡å—åŠ è½½æˆåŠŸ');
    console.log('ShopPanel:', ShopPanel);
    console.log('ShopSystem:', ShopSystem);
    console.log('InventorySystem:', InventorySystem);

    // Canvas è®¾ç½®
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // åˆ›å»ºç³»ç»Ÿå®ä¾‹
    const shopSystem = new ShopSystem();
    const inventorySystem = new InventorySystem(40);

    // åˆ›å»ºæ¨¡æ‹Ÿç©å®¶
    const player = {
      name: 'æµ‹è¯•ç©å®¶',
      currency: 500,
      inventory: inventorySystem
    };

    // æ³¨å†Œæµ‹è¯•å•†åº—
    shopSystem.registerShop('test_shop', {
      name: 'å¼ è§’æ‚è´§é“º',
      description: 'é»„å·¾å†›çš„è¡¥ç»™å•†åº—',
      items: [
        {
          id: 'sword_1',
          name: 'é“å‰‘',
          type: 'equipment',
          price: 100,
          stock: 5,
          description: 'æ™®é€šçš„é“åˆ¶é•¿å‰‘ï¼Œé€‚åˆåˆå­¦è€…ä½¿ç”¨ã€‚',
          attributes: { attack: 15, speed: 5 }
        },
        {
          id: 'armor_1',
          name: 'å¸ƒç”²',
          type: 'equipment',
          price: 80,
          stock: 10,
          description: 'ç®€å•çš„å¸ƒåˆ¶æŠ¤ç”²ï¼Œæä¾›åŸºç¡€é˜²æŠ¤ã€‚',
          attributes: { defense: 10, health: 20 }
        },
        {
          id: 'potion_hp',
          name: 'ç”Ÿå‘½è¯æ°´',
          type: 'consumable',
          price: 30,
          stock: 20,
          description: 'æ¢å¤50ç‚¹ç”Ÿå‘½å€¼çš„è¯æ°´ã€‚'
        },
        {
          id: 'potion_mp',
          name: 'æ³•åŠ›è¯æ°´',
          type: 'consumable',
          price: 25,
          stock: 15,
          description: 'æ¢å¤30ç‚¹æ³•åŠ›å€¼çš„è¯æ°´ã€‚'
        },
        {
          id: 'material_1',
          name: 'é“çŸ¿çŸ³',
          type: 'material',
          price: 10,
          stock: 50,
          description: 'ç”¨äºé”»é€ æ­¦å™¨çš„åŸºç¡€ææ–™ã€‚'
        },
        {
          id: 'material_2',
          name: 'å¸ƒæ–™',
          type: 'material',
          price: 8,
          stock: 40,
          description: 'ç”¨äºåˆ¶ä½œæŠ¤ç”²çš„åŸºç¡€ææ–™ã€‚'
        },
        {
          id: 'bow_1',
          name: 'æœ¨å¼“',
          type: 'equipment',
          price: 120,
          stock: 3,
          description: 'ç®€å•çš„æœ¨åˆ¶å¼“ç®­ï¼Œé€‚åˆè¿œç¨‹æ”»å‡»ã€‚',
          attributes: { attack: 12, speed: 8 }
        },
        {
          id: 'shield_1',
          name: 'æœ¨ç›¾',
          type: 'equipment',
          price: 90,
          stock: 8,
          description: 'æœ¨åˆ¶ç›¾ç‰Œï¼Œæä¾›é¢å¤–é˜²æŠ¤ã€‚',
          attributes: { defense: 15 }
        }
      ],
      priceModifier: 1.0
    });

    // æ·»åŠ ä¸€äº›åˆå§‹ç‰©å“åˆ°èƒŒåŒ…
    const addResult1 = inventorySystem.addItem({
      id: 'old_sword',
      name: 'æ—§å‰‘',
      type: 'equipment',
      price: 50,
      description: 'ä¸€æŠŠç”Ÿé”ˆçš„æ—§å‰‘ã€‚',
      attributes: { attack: 8 }
    }, 1);
    console.log('æ·»åŠ æ—§å‰‘ç»“æœ:', addResult1);

    const addResult2 = inventorySystem.addItem({
      id: 'old_armor',
      name: 'æ—§ç”²',
      type: 'equipment',
      price: 40,
      description: 'ç ´æŸçš„æ—§æŠ¤ç”²ã€‚',
      attributes: { defense: 5 }
    }, 1);
    console.log('æ·»åŠ æ—§ç”²ç»“æœ:', addResult2);
    
    console.log('èƒŒåŒ…ç‰©å“åˆ—è¡¨:', inventorySystem.getAllItems());
    console.log('èƒŒåŒ…å·²ç”¨æ§½ä½:', inventorySystem.getUsedSlots());

    // åˆ›å»ºå•†åº—é¢æ¿ï¼ˆå³ä¾§ï¼‰
    const shopPanel = new ShopPanel({
      x: 680,
      y: 50,
      width: 700,
      height: 550,
      shopSystem: shopSystem,
      inventorySystem: inventorySystem,
      visible: false,
      onBuy: (item, quantity, result) => {
        showStatus(`è´­ä¹°æˆåŠŸ: ${item.name} x${quantity}ï¼ŒèŠ±è´¹ ${result.totalCost} é“œé’±`, 'success');
      },
      onSell: (item, quantity, result) => {
        showStatus(`å‡ºå”®æˆåŠŸ: ${item.name} x${quantity}ï¼Œè·å¾— ${result.totalValue} é“œé’±`, 'success');
      },
      onClose: () => {
        showStatus('å•†åº—å·²å…³é—­', 'success');
      }
    });

    shopPanel.setPlayer(player);

    // åˆ›å»ºèƒŒåŒ…é¢æ¿ï¼ˆå·¦ä¾§ï¼‰
    const inventoryPanel = new InventoryPanel({
      x: 50,
      y: 50,
      width: 600,
      height: 500,
      inventorySystem: inventorySystem,
      visible: false,
      onItemUse: (item) => {
        showStatus(`ä½¿ç”¨ç‰©å“: ${item.name}`, 'success');
        console.log('ä½¿ç”¨ç‰©å“:', item);
      },
      onItemEquip: (item) => {
        showStatus(`è£…å¤‡ç‰©å“: ${item.name}`, 'success');
        console.log('è£…å¤‡ç‰©å“:', item);
      }
    });

    inventoryPanel.setPlayer(player);

    // çŠ¶æ€æ¶ˆæ¯æ˜¾ç¤º
    function showStatus(message, type = 'success') {
      const statusEl = document.getElementById('statusMessage');
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
      statusEl.style.display = 'block';
      
      setTimeout(() => {
        statusEl.style.display = 'none';
      }, 3000);
    }

    // æŒ‰é’®äº‹ä»¶
    document.getElementById('btnToggleShop').addEventListener('click', () => {
      console.log('æŒ‰é’®è¢«ç‚¹å‡»');
      console.log('å½“å‰visibleçŠ¶æ€:', shopPanel.visible);
      
      if (shopPanel.visible) {
        console.log('å…³é—­å•†åº—');
        shopPanel.closeShop();
      } else {
        console.log('æ‰“å¼€å•†åº—');
        shopPanel.openShop('test_shop');
        console.log('æ‰“å¼€åvisibleçŠ¶æ€:', shopPanel.visible);
        showStatus('å•†åº—å·²æ‰“å¼€', 'success');
      }
    });

    document.getElementById('btnToggleInventory').addEventListener('click', () => {
      inventoryPanel.toggle();
      const status = inventoryPanel.visible ? 'å·²æ‰“å¼€' : 'å·²å…³é—­';
      showStatus(`èƒŒåŒ…${status}`, 'success');
    });

    document.getElementById('btnAddCurrency').addEventListener('click', () => {
      player.currency += 100;
      showStatus(`è´§å¸å¢åŠ  +100ï¼Œå½“å‰: ${player.currency} é“œé’±`, 'success');
    });

    document.getElementById('btnAddItem').addEventListener('click', () => {
      const testItem = {
        id: `test_item_${Date.now()}`,
        name: 'æµ‹è¯•ç‰©å“',
        type: 'material',
        price: 20,
        description: 'ç”¨äºæµ‹è¯•çš„ç‰©å“ã€‚'
      };
      
      const result = inventorySystem.addItem(testItem, 1);
      if (result.success) {
        showStatus('ç‰©å“å·²æ·»åŠ åˆ°èƒŒåŒ…', 'success');
      } else {
        showStatus('èƒŒåŒ…å·²æ»¡ï¼Œæ— æ³•æ·»åŠ ç‰©å“', 'error');
      }
    });

    document.getElementById('btnResetShop').addEventListener('click', () => {
      // é‡ç½®å•†åº—åº“å­˜
      const shop = shopSystem.getShop('test_shop');
      if (shop) {
        shop.items.forEach(item => {
          if (item.id === 'sword_1') item.stock = 5;
          if (item.id === 'armor_1') item.stock = 10;
          if (item.id === 'potion_hp') item.stock = 20;
          if (item.id === 'potion_mp') item.stock = 15;
          if (item.id === 'material_1') item.stock = 50;
          if (item.id === 'material_2') item.stock = 40;
          if (item.id === 'bow_1') item.stock = 3;
          if (item.id === 'shield_1') item.stock = 8;
        });
      }
      
      // é‡ç½®ç©å®¶è´§å¸
      player.currency = 500;
      
      showStatus('å•†åº—å·²é‡ç½®', 'success');
    });

    // é¼ æ ‡äº‹ä»¶å¤„ç†
    let mouseX = 0;
    let mouseY = 0;

    canvas.addEventListener('mousemove', (e) => {
      const rect = canvas.getBoundingClientRect();
      mouseX = e.clientX - rect.left;
      mouseY = e.clientY - rect.top;
      
      shopPanel.handleMouseMove(mouseX, mouseY);
      inventoryPanel.handleMouseMove(mouseX, mouseY);
    });

    canvas.addEventListener('mousedown', (e) => {
      const rect = canvas.getBoundingClientRect();
      mouseX = e.clientX - rect.left;
      mouseY = e.clientY - rect.top;
      
      inventoryPanel.handleMouseDown(mouseX, mouseY, e.button);
    });

    canvas.addEventListener('mouseup', (e) => {
      const rect = canvas.getBoundingClientRect();
      mouseX = e.clientX - rect.left;
      mouseY = e.clientY - rect.top;
      
      inventoryPanel.handleMouseUp(mouseX, mouseY);
    });

    canvas.addEventListener('click', (e) => {
      const rect = canvas.getBoundingClientRect();
      mouseX = e.clientX - rect.left;
      mouseY = e.clientY - rect.top;
      
      shopPanel.handleMouseClick(mouseX, mouseY);
    });

    canvas.addEventListener('wheel', (e) => {
      e.preventDefault();
      shopPanel.handleMouseWheel(e.deltaY > 0 ? 1 : -1);
    });

    // æ¸²æŸ“å¾ªç¯
    let lastTime = 0;
    
    function gameLoop(currentTime) {
      const deltaTime = currentTime - lastTime;
      lastTime = currentTime;
      
      // æ¸…ç©ºç”»å¸ƒ
      ctx.fillStyle = '#0f0f1e';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // ç»˜åˆ¶èƒŒæ™¯ç½‘æ ¼
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
      ctx.lineWidth = 1;
      for (let x = 0; x < canvas.width; x += 50) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }
      for (let y = 0; y < canvas.height; y += 50) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }
      
      // ç»˜åˆ¶æ ‡é¢˜
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 24px Arial, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillText('å•†åº—é¢æ¿æµ‹è¯• - ShopPanel Test', canvas.width / 2, 20);
      
      // ç»˜åˆ¶ç©å®¶ä¿¡æ¯
      ctx.fillStyle = '#ffd700';
      ctx.font = '16px Arial, sans-serif';
      ctx.textAlign = 'right';
      ctx.fillText(`è´§å¸: ${player.currency} é“œé’±`, canvas.width - 20, 20);
      
      ctx.fillStyle = '#00ff00';
      ctx.fillText(`èƒŒåŒ…: ${inventorySystem.getUsedSlots()}/${inventorySystem.maxSlots}`, canvas.width - 20, 45);
      
      // æ›´æ–°å’Œæ¸²æŸ“èƒŒåŒ…é¢æ¿ï¼ˆå…ˆæ¸²æŸ“ï¼Œåœ¨ä¸‹å±‚ï¼‰
      inventoryPanel.update(deltaTime);
      inventoryPanel.render(ctx);
      
      // æ›´æ–°å’Œæ¸²æŸ“å•†åº—é¢æ¿ï¼ˆåæ¸²æŸ“ï¼Œåœ¨ä¸Šå±‚ï¼‰
      shopPanel.update(deltaTime);
      shopPanel.render(ctx);
      
      requestAnimationFrame(gameLoop);
    }
    
    requestAnimationFrame(gameLoop);
    
    console.log('å•†åº—é¢æ¿æµ‹è¯•å·²å¯åŠ¨');
    console.log('ShopPanel:', shopPanel);
    console.log('ShopSystem:', shopSystem);
    console.log('InventorySystem:', inventorySystem);
  </script>
</body>
</html>
