<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¯¹è¯æ¡†ç»„ä»¶æµ‹è¯• - DialogueBox</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      padding: 30px;
      max-width: 1400px;
      width: 100%;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      text-align: center;
    }

    .subtitle {
      color: #666;
      text-align: center;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .canvas-container {
      position: relative;
      background: #2c3e50;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    #gameCanvas {
      display: block;
      width: 100%;
      height: auto;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .control-group {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #e9ecef;
    }

    .control-group h3 {
      color: #495057;
      font-size: 14px;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    button {
      width: 100%;
      padding: 10px 15px;
      margin: 5px 0;
      border: none;
      border-radius: 5px;
      background: #667eea;
      color: white;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    button:active {
      transform: translateY(0);
    }

    button.secondary {
      background: #6c757d;
    }

    button.secondary:hover {
      background: #5a6268;
    }

    .info {
      background: #e7f3ff;
      border-left: 4px solid #2196F3;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }

    .info h3 {
      color: #1976D2;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .info ul {
      margin-left: 20px;
      color: #555;
      line-height: 1.8;
    }

    .log {
      background: #f8f9fa;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .log-entry {
      padding: 5px;
      border-bottom: 1px solid #e9ecef;
      color: #495057;
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .log-entry.info {
      background: transparent;
      border-left: none;
      padding: 5px;
      margin: 0;
    }

    .log-entry.success {
      color: #28a745;
    }

    .log-entry.error {
      color: #dc3545;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ—¨ï¸ å¯¹è¯æ¡†ç»„ä»¶æµ‹è¯•</h1>
    <p class="subtitle">DialogueBox Component Test - å¼ è§’é»„å·¾èµ·ä¹‰åºç« </p>

    <div class="info">
      <h3>ğŸ“‹ åŠŸèƒ½è¯´æ˜</h3>
      <ul>
        <li><strong>æ‰“å­—æœºæ•ˆæœ</strong>ï¼šå¯¹è¯æ–‡æœ¬é€å­—æ˜¾ç¤ºï¼Œç‚¹å‡»å¯è·³è¿‡</li>
        <li><strong>è§’è‰²å¤´åƒ</strong>ï¼šæ˜¾ç¤ºè¯´è¯è€…çš„å¤´åƒï¼ˆå½“å‰ä¸ºå ä½ç¬¦ï¼‰</li>
        <li><strong>å¯¹è¯é€‰é¡¹</strong>ï¼šæ”¯æŒå¤šä¸ªé€‰é¡¹ï¼Œé¼ æ ‡æ‚¬åœé«˜äº®</li>
        <li><strong>éŸ³æ•ˆé›†æˆ</strong>ï¼šæ‰“å­—æœºéŸ³æ•ˆã€æ‚¬åœéŸ³æ•ˆã€é€‰æ‹©éŸ³æ•ˆ</li>
        <li><strong>ç»§ç»­æç¤º</strong>ï¼šæ— é€‰é¡¹æ—¶æ˜¾ç¤ºé—ªçƒçš„ç»§ç»­æç¤º</li>
      </ul>
    </div>

    <div class="canvas-container">
      <canvas id="gameCanvas" width="1200" height="700"></canvas>
    </div>

    <div class="controls">
      <div class="control-group">
        <h3>å¯¹è¯æ§åˆ¶</h3>
        <button onclick="startSimpleDialogue()">å¼€å§‹ç®€å•å¯¹è¯</button>
        <button onclick="startChoiceDialogue()">å¼€å§‹é€‰æ‹©å¯¹è¯</button>
        <button onclick="startComplexDialogue()">å¼€å§‹å¤æ‚å¯¹è¯</button>
        <button onclick="endDialogue()" class="secondary">ç»“æŸå¯¹è¯</button>
      </div>

      <div class="control-group">
        <h3>æ˜¾ç¤ºæ§åˆ¶</h3>
        <button onclick="toggleDialogueBox()">æ˜¾ç¤º/éšè—å¯¹è¯æ¡†</button>
        <button onclick="skipTypewriter()">è·³è¿‡æ‰“å­—æœºæ•ˆæœ</button>
        <button onclick="continueDialogue()">ç»§ç»­å¯¹è¯</button>
      </div>

      <div class="control-group">
        <h3>éŸ³æ•ˆæ§åˆ¶</h3>
        <button onclick="toggleMute()">é™éŸ³/å–æ¶ˆé™éŸ³</button>
        <button onclick="testTypewriterSound()">æµ‹è¯•æ‰“å­—æœºéŸ³æ•ˆ</button>
        <button onclick="testChoiceSound()">æµ‹è¯•é€‰æ‹©éŸ³æ•ˆ</button>
      </div>
    </div>

    <div class="log" id="logContainer">
      <div class="log-entry info">ç­‰å¾…æ“ä½œ...</div>
    </div>
  </div>

  <script type="module">
    import { DialogueBox } from '../src/prologue/ui/DialogueBox.js';
    import { DialogueSystem } from '../src/prologue/systems/DialogueSystem.js';
    import { AudioManager } from '../src/core/AudioManager.js';

    console.log('=== æµ‹è¯•é¡µé¢åŠ è½½ ===');
    
    // è·å–Canvaså’Œä¸Šä¸‹æ–‡
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // åˆå§‹åŒ–ç³»ç»Ÿ
    const dialogueSystem = new DialogueSystem();
    const audioManager = new AudioManager();

    // åˆ›å»ºå¯¹è¯æ¡†
    const dialogueBox = new DialogueBox({
      x: 50,
      y: 450,
      width: 1100,
      height: 230,
      dialogueSystem: dialogueSystem,
      audioManager: audioManager,
      visible: false,
      onChoiceSelect: (index, choice) => {
        log(`é€‰æ‹©äº†é€‰é¡¹ ${index + 1}: ${choice.text}`, 'success');
      },
      onDialogueEnd: () => {
        log('å¯¹è¯ç»“æŸ', 'info');
      },
      onContinue: () => {
        log('ç»§ç»­å¯¹è¯', 'info');
      }
    });

    // æ³¨å†Œæµ‹è¯•å¯¹è¯
    function registerTestDialogues() {
      // ç®€å•å¯¹è¯
      dialogueSystem.registerDialogue('simple', {
        title: 'ç®€å•å¯¹è¯',
        startNode: 'start',
        nodes: {
          start: {
            speaker: 'å¼ è§’',
            text: 'ä½ é†’äº†ã€‚ä½ åœ¨è’é‡ä¸­æ˜å€’äº†ï¼Œæˆ‘ä»¬æŠŠä½ æ•‘äº†å›æ¥ã€‚',
            portrait: 'zhangjiao',
            nextNode: 'node2'
          },
          node2: {
            speaker: 'å¼ è§’',
            text: 'è¿™æ˜¯ä¸€ç¢—ç¬¦æ°´ï¼Œå–ä¸‹å»ä¼šè®©ä½ æ¢å¤ä½“åŠ›ã€‚',
            portrait: 'zhangjiao',
            nextNode: 'node3'
          },
          node3: {
            speaker: 'å¼ è§’',
            text: 'è‹å¤©å·²æ­»ï¼Œé»„å¤©å½“ç«‹ã€‚å²åœ¨ç”²å­ï¼Œå¤©ä¸‹å¤§å‰ã€‚',
            portrait: 'zhangjiao',
            nextNode: null
          }
        }
      });

      // é€‰æ‹©å¯¹è¯
      dialogueSystem.registerDialogue('choice', {
        title: 'é€‰æ‹©å¯¹è¯',
        startNode: 'start',
        nodes: {
          start: {
            speaker: 'å¼ è§’',
            text: 'ä½ æ„¿æ„åŠ å…¥æˆ‘ä»¬ï¼Œä¸€èµ·æ¨ç¿»è…æœ½çš„æœå»·å—ï¼Ÿ',
            portrait: 'zhangjiao',
            choices: [
              { text: 'æˆ‘æ„¿æ„åŠ å…¥', nextNode: 'join' },
              { text: 'è®©æˆ‘å†æƒ³æƒ³', nextNode: 'think' },
              { text: 'æˆ‘æ‹’ç»', nextNode: 'refuse' }
            ]
          },
          join: {
            speaker: 'å¼ è§’',
            text: 'å¾ˆå¥½ï¼ä»ä»Šå¤©èµ·ï¼Œä½ å°±æ˜¯é»„å·¾å†›çš„ä¸€å‘˜äº†ã€‚',
            portrait: 'zhangjiao',
            nextNode: null
          },
          think: {
            speaker: 'å¼ è§’',
            text: 'æ²¡å…³ç³»ï¼Œæ…¢æ…¢è€ƒè™‘ã€‚ä½†æ—¶é—´ä¸å¤šäº†ã€‚',
            portrait: 'zhangjiao',
            nextNode: null
          },
          refuse: {
            speaker: 'å¼ è§’',
            text: 'å¯æƒœäº†...å¸Œæœ›ä½ ä¸ä¼šåæ‚”ã€‚',
            portrait: 'zhangjiao',
            nextNode: null
          }
        }
      });

      // å¤æ‚å¯¹è¯
      dialogueSystem.registerDialogue('complex', {
        title: 'å¤æ‚å¯¹è¯',
        startNode: 'start',
        nodes: {
          start: {
            speaker: 'å¼ è§’',
            text: 'å®˜åºœä¸å…è®¸ç§äººæ–½ç²¥ï¼Œä½†åŠ äº†ç¬¦çº¸å°±æ˜¯ä»™å®¶ç¬¦æ°´ï¼Œå°±åˆæ³•äº†ã€‚è¿™æ˜¯æˆ‘ä»¬èƒ½åšçš„ï¼Œå¸®åŠ©æ›´å¤šçš„ç¾æ°‘ã€‚',
            portrait: 'zhangjiao',
            nextNode: 'question'
          },
          question: {
            speaker: 'å¼ è§’',
            text: 'ä½ æ˜ç™½æˆ‘çš„æ„æ€å—ï¼Ÿ',
            portrait: 'zhangjiao',
            choices: [
              { text: 'æ˜ç™½äº†ï¼Œè¿™æ˜¯æ™ºæ…§', nextNode: 'understand' },
              { text: 'è¿™ä¸æ˜¯æ¬ºéª—å—ï¼Ÿ', nextNode: 'doubt' }
            ]
          },
          understand: {
            speaker: 'å¼ è§’',
            text: 'å¾ˆå¥½ã€‚åœ¨ä¹±ä¸–ä¸­ç”Ÿå­˜ï¼Œéœ€è¦çš„ä¸ä»…æ˜¯åŠ›é‡ï¼Œè¿˜æœ‰æ™ºæ…§ã€‚',
            portrait: 'zhangjiao',
            nextNode: 'teach'
          },
          doubt: {
            speaker: 'å¼ è§’',
            text: 'æ¬ºéª—ï¼Ÿä¸ï¼Œè¿™æ˜¯åœ¨è§„åˆ™å†…å¯»æ‰¾ç”Ÿå­˜ä¹‹é“ã€‚æœå»·çš„è§„åˆ™æœ¬å°±ä¸å…¬ã€‚',
            portrait: 'zhangjiao',
            nextNode: 'teach'
          },
          teach: {
            speaker: 'å¼ è§’',
            text: 'æˆ‘ä¼šæ•™ä½ æ›´å¤šçš„ä¸œè¥¿ã€‚è·Ÿæˆ‘æ¥å§ã€‚',
            portrait: 'zhangjiao',
            nextNode: null
          }
        }
      });

      log('å¯¹è¯æ•°æ®å·²æ³¨å†Œ', 'success');
    }

    // æ—¥å¿—å‡½æ•°
    function log(message, type = 'info') {
      const logContainer = document.getElementById('logContainer');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    // å…¨å±€å‡½æ•°
    window.startSimpleDialogue = function() {
      dialogueSystem.startDialogue('simple');
      dialogueBox.show();
      log('å¼€å§‹ç®€å•å¯¹è¯', 'info');
    };

    window.startChoiceDialogue = function() {
      dialogueSystem.startDialogue('choice');
      dialogueBox.show();
      log('å¼€å§‹é€‰æ‹©å¯¹è¯', 'info');
    };

    window.startComplexDialogue = function() {
      dialogueSystem.startDialogue('complex');
      dialogueBox.show();
      log('å¼€å§‹å¤æ‚å¯¹è¯', 'info');
    };

    window.endDialogue = function() {
      dialogueSystem.endDialogue();
      dialogueBox.hide();
      log('å¼ºåˆ¶ç»“æŸå¯¹è¯', 'info');
    };

    window.toggleDialogueBox = function() {
      if (dialogueBox.visible) {
        dialogueBox.hide();
        log('éšè—å¯¹è¯æ¡†', 'info');
      } else {
        dialogueBox.show();
        log('æ˜¾ç¤ºå¯¹è¯æ¡†', 'info');
      }
    };

    window.skipTypewriter = function() {
      if (dialogueSystem.isTyping()) {
        dialogueSystem.skipTypewriter();
        log('è·³è¿‡æ‰“å­—æœºæ•ˆæœ', 'info');
      } else {
        log('å½“å‰æ²¡æœ‰æ‰“å­—æœºæ•ˆæœ', 'error');
      }
    };

    window.continueDialogue = function() {
      if (dialogueSystem.isDialogueActive()) {
        dialogueSystem.continue();
        log('ç»§ç»­å¯¹è¯', 'info');
      } else {
        log('æ²¡æœ‰æ´»åŠ¨çš„å¯¹è¯', 'error');
      }
    };

    window.toggleMute = function() {
      audioManager.toggleMute();
      log(`éŸ³æ•ˆ${audioManager.muted ? 'å·²é™éŸ³' : 'å·²å–æ¶ˆé™éŸ³'}`, 'info');
    };

    window.testTypewriterSound = function() {
      log('æ’­æ”¾æ‰“å­—æœºéŸ³æ•ˆï¼ˆå¦‚æœå·²åŠ è½½ï¼‰', 'info');
      if (audioManager.hasSound('dialogue_type')) {
        audioManager.playSound('dialogue_type', { volume: 0.3 });
      } else {
        log('æ‰“å­—æœºéŸ³æ•ˆæœªåŠ è½½', 'error');
      }
    };

    window.testChoiceSound = function() {
      log('æ’­æ”¾é€‰æ‹©éŸ³æ•ˆï¼ˆå¦‚æœå·²åŠ è½½ï¼‰', 'info');
      if (audioManager.hasSound('dialogue_select')) {
        audioManager.playSound('dialogue_select', { volume: 0.7 });
      } else {
        log('é€‰æ‹©éŸ³æ•ˆæœªåŠ è½½', 'error');
      }
    };

    // æ¸²æŸ“å¾ªç¯
    let lastTime = 0;
    function gameLoop(currentTime) {
      const deltaTime = currentTime - lastTime;
      lastTime = currentTime;

      // æ¸…ç©ºç”»å¸ƒ
      ctx.fillStyle = '#34495e';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // ç»˜åˆ¶èƒŒæ™¯æ–‡å­—
      ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
      ctx.font = '48px Arial, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('å¼ è§’é»„å·¾èµ·ä¹‰åºç« ', canvas.width / 2, canvas.height / 2 - 100);
      ctx.font = '24px Arial, sans-serif';
      ctx.fillText('å¯¹è¯æ¡†ç»„ä»¶æµ‹è¯•', canvas.width / 2, canvas.height / 2 - 40);

      // æ›´æ–°å’Œæ¸²æŸ“å¯¹è¯æ¡†
      dialogueBox.update(deltaTime);
      dialogueBox.render(ctx);

      requestAnimationFrame(gameLoop);
    }

    // é¼ æ ‡äº‹ä»¶å¤„ç†
    canvas.addEventListener('mousemove', (e) => {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const mouseX = (e.clientX - rect.left) * scaleX;
      const mouseY = (e.clientY - rect.top) * scaleY;
      
      dialogueBox.handleMouseMove(mouseX, mouseY);
    });

    canvas.addEventListener('click', (e) => {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const mouseX = (e.clientX - rect.left) * scaleX;
      const mouseY = (e.clientY - rect.top) * scaleY;
      
      dialogueBox.handleMouseClick(mouseX, mouseY);
    });

    // åˆå§‹åŒ–
    registerTestDialogues();
    log('å¯¹è¯æ¡†ç»„ä»¶æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
    log('ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•', 'info');
    
    // å¯åŠ¨æ¸²æŸ“å¾ªç¯
    requestAnimationFrame(gameLoop);
  </script>
</body>
</html>
