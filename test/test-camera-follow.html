<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›¸æœºè·Ÿéšæµ‹è¯•</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a2e;
            color: #ffffff;
            font-family: Arial, sans-serif;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #4a9eff;
            margin-bottom: 10px;
        }
        
        .info {
            text-align: center;
            color: #888;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .canvas-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        canvas {
            border: 2px solid #4a9eff;
            background: #0f0c29;
            display: block;
        }
        
        .controls {
            background: #16213e;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: inline-block;
            width: 150px;
            color: #4a9eff;
        }
        
        button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            background: #357abd;
        }
        
        input[type="range"] {
            width: 200px;
            vertical-align: middle;
        }
        
        .value-display {
            display: inline-block;
            width: 60px;
            text-align: right;
            color: #fff;
        }
        
        .stats {
            background: #16213e;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .stat-item {
            padding: 8px;
            background: #0f0c29;
            border-radius: 4px;
        }
        
        .stat-label {
            color: #4a9eff;
            margin-right: 10px;
        }
        
        .instructions {
            background: #16213e;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .instructions h3 {
            color: #4a9eff;
            margin-top: 0;
        }
        
        .instructions ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .instructions li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® ç›¸æœºè·Ÿéšç³»ç»Ÿæµ‹è¯•</h1>
        <div class="info">æµ‹è¯•ç›¸æœºå¹³æ»‘è·Ÿéšå’Œè¾¹ç•Œé™åˆ¶åŠŸèƒ½</div>
        
        <div class="canvas-container">
            <canvas id="gameCanvas" width="1280" height="720"></canvas>
        </div>
        
        <div class="controls">
            <h3 style="color: #4a9eff; margin-top: 0;">ç›¸æœºæ§åˆ¶</h3>
            
            <div class="control-group">
                <label>è·Ÿéšé€Ÿåº¦:</label>
                <input type="range" id="followSpeed" min="0.01" max="1" step="0.01" value="0.1">
                <span class="value-display" id="followSpeedValue">0.10</span>
            </div>
            
            <div class="control-group">
                <label>æ­»åŒºå¤§å° X:</label>
                <input type="range" id="deadzoneX" min="0" max="300" step="10" value="100">
                <span class="value-display" id="deadzoneXValue">100</span>
            </div>
            
            <div class="control-group">
                <label>æ­»åŒºå¤§å° Y:</label>
                <input type="range" id="deadzoneY" min="0" max="300" step="10" value="100">
                <span class="value-display" id="deadzoneYValue">100</span>
            </div>
            
            <div class="control-group">
                <button id="resetCamera">é‡ç½®ç›¸æœº</button>
                <button id="centerCamera">å±…ä¸­ç›¸æœº</button>
                <button id="toggleDebug">åˆ‡æ¢è°ƒè¯•æ¨¡å¼</button>
            </div>
        </div>
        
        <div class="stats">
            <h3 style="color: #4a9eff; margin-top: 0;">å®æ—¶çŠ¶æ€</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">ç©å®¶ä½ç½®:</span>
                    <span id="playerPos">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ç›¸æœºä½ç½®:</span>
                    <span id="cameraPos">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">è·ç¦»å·®:</span>
                    <span id="distance">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">FPS:</span>
                    <span id="fps">-</span>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3>ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
            <ul>
                <li><strong>WASD æˆ– æ–¹å‘é”®</strong> - ç§»åŠ¨ç©å®¶è§’è‰²</li>
                <li><strong>é¼ æ ‡ç‚¹å‡»</strong> - ç‚¹å‡»ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®</li>
                <li><strong>è·Ÿéšé€Ÿåº¦</strong> - è°ƒæ•´ç›¸æœºè·Ÿéšçš„å¹³æ»‘åº¦ï¼ˆè¶Šå¤§è¶Šå¿«ï¼‰</li>
                <li><strong>æ­»åŒºå¤§å°</strong> - è°ƒæ•´ç›¸æœºå¼€å§‹è·Ÿéšçš„è·ç¦»é˜ˆå€¼</li>
                <li>ç©å®¶ç§»åŠ¨åˆ°åœ°å›¾è¾¹ç¼˜æ—¶ï¼Œç›¸æœºä¼šè‡ªåŠ¨é™åˆ¶åœ¨åœ°å›¾èŒƒå›´å†…</li>
                <li>è°ƒè¯•æ¨¡å¼ä¸‹ä¼šæ˜¾ç¤ºç›¸æœºè§†é‡èŒƒå›´å’Œæ­»åŒº</li>
            </ul>
        </div>
    </div>

    <script type="module">
        import { Entity } from './src/ecs/Entity.js';
        import { TransformComponent } from './src/ecs/components/TransformComponent.js';
        import { SpriteComponent } from './src/ecs/components/SpriteComponent.js';
        import { MovementComponent } from './src/ecs/components/MovementComponent.js';
        import { InputManager } from './src/core/InputManager.js';
        import { RenderSystem } from './src/rendering/RenderSystem.js';
        import { MovementSystem } from './src/systems/MovementSystem.js';

        // è·å–Canvaså’Œä¸Šä¸‹æ–‡
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // åœ°å›¾é…ç½®
        const MAP_WIDTH = 3000;
        const MAP_HEIGHT = 2000;
        const TILE_SIZE = 64;

        // åˆ›å»ºè¾“å…¥ç®¡ç†å™¨
        const inputManager = new InputManager(canvas);

        // åˆ›å»ºæ¸²æŸ“ç³»ç»Ÿ
        const renderSystem = new RenderSystem(ctx, null, canvas.width, canvas.height);
        const camera = renderSystem.getCamera();

        // è®¾ç½®ç›¸æœºè¾¹ç•Œï¼ˆåœ°å›¾è¾¹ç•Œï¼‰
        camera.setBounds(0, 0, MAP_WIDTH, MAP_HEIGHT);

        // åˆ›å»ºç§»åŠ¨ç³»ç»Ÿ
        const movementSystem = new MovementSystem({
            inputManager: inputManager,
            camera: camera,
            mapBounds: {
                minX: 0,
                minY: 0,
                maxX: MAP_WIDTH,
                maxY: MAP_HEIGHT
            }
        });

        // åˆ›å»ºç©å®¶å®ä½“
        const player = new Entity('player-1', 'player');
        
        // æ·»åŠ å˜æ¢ç»„ä»¶
        const transform = new TransformComponent(MAP_WIDTH / 2, MAP_HEIGHT / 2);
        player.addComponent('transform', transform);
        
        // æ·»åŠ ç²¾çµç»„ä»¶
        const sprite = new SpriteComponent();
        sprite.color = '#4a9eff';
        sprite.width = 32;
        sprite.height = 32;
        sprite.visible = true;
        player.addComponent('sprite', sprite);
        
        // æ·»åŠ ç§»åŠ¨ç»„ä»¶
        const movement = new MovementComponent(200);
        player.addComponent('movement', movement);

        // è®¾ç½®ç©å®¶å®ä½“ï¼ˆè¿™ä¼šè‡ªåŠ¨è®¾ç½®ç›¸æœºè·Ÿéšï¼‰
        movementSystem.setPlayerEntity(player);

        // å®ä½“åˆ—è¡¨
        const entities = [player];

        // åˆ›å»ºä¸€äº›é™æ€éšœç¢ç‰©ä½œä¸ºå‚è€ƒ
        for (let i = 0; i < 20; i++) {
            const obstacle = new Entity(`obstacle-${i}`, 'obstacle');
            const obstacleTransform = new TransformComponent(
                Math.random() * MAP_WIDTH,
                Math.random() * MAP_HEIGHT
            );
            const obstacleSprite = new SpriteComponent();
            obstacleSprite.color = '#ff6b6b';
            obstacleSprite.width = 48;
            obstacleSprite.height = 48;
            obstacleSprite.visible = true;
            
            obstacle.addComponent('transform', obstacleTransform);
            obstacle.addComponent('sprite', obstacleSprite);
            entities.push(obstacle);
        }

        // è°ƒè¯•æ¨¡å¼
        let debugMode = false;
        renderSystem.setDebugMode(debugMode);

        // æ§åˆ¶é¢æ¿
        const followSpeedSlider = document.getElementById('followSpeed');
        const followSpeedValue = document.getElementById('followSpeedValue');
        const deadzoneXSlider = document.getElementById('deadzoneX');
        const deadzoneXValue = document.getElementById('deadzoneXValue');
        const deadzoneYSlider = document.getElementById('deadzoneY');
        const deadzoneYValue = document.getElementById('deadzoneYValue');

        followSpeedSlider.addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            camera.followSpeed = value;
            followSpeedValue.textContent = value.toFixed(2);
        });

        deadzoneXSlider.addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            camera.deadzone.x = value;
            deadzoneXValue.textContent = value;
        });

        deadzoneYSlider.addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            camera.deadzone.y = value;
            deadzoneYValue.textContent = value;
        });

        document.getElementById('resetCamera').addEventListener('click', () => {
            camera.setPosition(MAP_WIDTH / 2, MAP_HEIGHT / 2);
        });

        document.getElementById('centerCamera').addEventListener('click', () => {
            const playerTransform = player.getComponent('transform');
            camera.setPosition(playerTransform.position.x, playerTransform.position.y);
        });

        document.getElementById('toggleDebug').addEventListener('click', () => {
            debugMode = !debugMode;
            renderSystem.setDebugMode(debugMode);
        });

        // æ€§èƒ½ç›‘æ§
        let lastTime = performance.now();
        let frameCount = 0;
        let fps = 0;
        let fpsUpdateTime = 0;

        // æ¸¸æˆå¾ªç¯
        function gameLoop(currentTime) {
            const deltaTime = (currentTime - lastTime) / 1000;
            lastTime = currentTime;

            // æ›´æ–°FPS
            frameCount++;
            fpsUpdateTime += deltaTime;
            if (fpsUpdateTime >= 1.0) {
                fps = Math.round(frameCount / fpsUpdateTime);
                frameCount = 0;
                fpsUpdateTime = 0;
            }

            // æ›´æ–°ç³»ç»Ÿ
            movementSystem.update(deltaTime, entities);
            renderSystem.update(deltaTime);

            // æ¸²æŸ“
            renderSystem.render(entities);

            // æ¸²æŸ“åœ°å›¾è¾¹ç•Œ
            renderMapBounds();

            // æ¸²æŸ“è°ƒè¯•ä¿¡æ¯
            if (debugMode) {
                renderDebugInfo();
            }

            // æ›´æ–°UI
            updateStats();

            // æ¸…é™¤è¾“å…¥çŠ¶æ€
            inputManager.update();

            requestAnimationFrame(gameLoop);
        }

        // æ¸²æŸ“åœ°å›¾è¾¹ç•Œ
        function renderMapBounds() {
            ctx.save();
            
            // åº”ç”¨ç›¸æœºå˜æ¢
            const halfWidth = camera.width / 2;
            const halfHeight = camera.height / 2;
            ctx.translate(
                halfWidth - camera.position.x,
                halfHeight - camera.position.y
            );

            // ç»˜åˆ¶åœ°å›¾è¾¹ç•Œ
            ctx.strokeStyle = '#ff6b6b';
            ctx.lineWidth = 4;
            ctx.strokeRect(0, 0, MAP_WIDTH, MAP_HEIGHT);

            // ç»˜åˆ¶åœ°å›¾ä¸­å¿ƒç‚¹
            ctx.fillStyle = '#ffff00';
            ctx.beginPath();
            ctx.arc(MAP_WIDTH / 2, MAP_HEIGHT / 2, 8, 0, Math.PI * 2);
            ctx.fill();

            ctx.restore();
        }

        // æ¸²æŸ“è°ƒè¯•ä¿¡æ¯
        function renderDebugInfo() {
            ctx.save();
            
            // åº”ç”¨ç›¸æœºå˜æ¢
            const halfWidth = camera.width / 2;
            const halfHeight = camera.height / 2;
            ctx.translate(
                halfWidth - camera.position.x,
                halfHeight - camera.position.y
            );

            const playerTransform = player.getComponent('transform');

            // ç»˜åˆ¶ç›¸æœºä¸­å¿ƒç‚¹
            ctx.fillStyle = '#00ff00';
            ctx.beginPath();
            ctx.arc(camera.position.x, camera.position.y, 6, 0, Math.PI * 2);
            ctx.fill();

            // ç»˜åˆ¶ç›¸æœºè§†é‡èŒƒå›´
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            ctx.setLineDash([10, 5]);
            ctx.strokeRect(
                camera.position.x - halfWidth,
                camera.position.y - halfHeight,
                camera.width,
                camera.height
            );
            ctx.setLineDash([]);

            // ç»˜åˆ¶æ­»åŒº
            ctx.strokeStyle = '#ffff00';
            ctx.lineWidth = 2;
            ctx.strokeRect(
                camera.position.x - camera.deadzone.x,
                camera.position.y - camera.deadzone.y,
                camera.deadzone.x * 2,
                camera.deadzone.y * 2
            );

            // ç»˜åˆ¶ç©å®¶åˆ°ç›¸æœºçš„è¿çº¿
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(playerTransform.position.x, playerTransform.position.y);
            ctx.lineTo(camera.position.x, camera.position.y);
            ctx.stroke();
            ctx.setLineDash([]);

            ctx.restore();
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const playerTransform = player.getComponent('transform');
            
            document.getElementById('playerPos').textContent = 
                `(${Math.round(playerTransform.position.x)}, ${Math.round(playerTransform.position.y)})`;
            
            document.getElementById('cameraPos').textContent = 
                `(${Math.round(camera.position.x)}, ${Math.round(camera.position.y)})`;
            
            const dx = playerTransform.position.x - camera.position.x;
            const dy = playerTransform.position.y - camera.position.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            document.getElementById('distance').textContent = 
                `${Math.round(distance)} px`;
            
            document.getElementById('fps').textContent = fps;
        }

        // å¯åŠ¨æ¸¸æˆå¾ªç¯
        console.log('Starting camera follow test...');
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>
