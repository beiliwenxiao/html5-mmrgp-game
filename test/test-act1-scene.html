<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Act1Scene æµ‹è¯• - æ•™ç¨‹ä¸“ç”¨ç®€åŒ–å®ç°</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        
        h1 {
            text-align: center;
            color: #4CAF50;
        }
        
        .notice {
            max-width: 800px;
            margin: 10px auto;
            padding: 10px;
            background-color: #2a4a2a;
            border-left: 4px solid #4CAF50;
            font-size: 14px;
        }
        
        #gameCanvas {
            display: block;
            margin: 20px auto;
            border: 2px solid #4CAF50;
            background-color: #2a2a2a;
        }
        
        .controls {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #2a2a2a;
            border-radius: 8px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: inline-block;
            width: 150px;
            color: #aaaaaa;
        }
        
        button {
            padding: 8px 16px;
            margin: 5px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #666666;
            cursor: not-allowed;
        }
        
        .info {
            max-width: 800px;
            margin: 20px auto;
            padding: 15px;
            background-color: #2a2a2a;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        
        .info h3 {
            margin-top: 0;
            color: #4CAF50;
        }
        
        .status {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .status-item {
            padding: 10px;
            background-color: #1a1a1a;
            border-radius: 4px;
        }
        
        .status-label {
            color: #888888;
            font-size: 12px;
        }
        
        .status-value {
            color: #ffffff;
            font-size: 16px;
            font-weight: bold;
        }
        
        .instructions {
            max-width: 800px;
            margin: 20px auto;
            padding: 15px;
            background-color: #2a2a2a;
            border-radius: 8px;
        }
        
        .instructions h3 {
            color: #4CAF50;
        }
        
        .instructions ul {
            line-height: 1.8;
        }
        
        .instructions code {
            background-color: #1a1a1a;
            padding: 2px 6px;
            border-radius: 3px;
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <h1>Act1Scene æµ‹è¯• - ç¬¬ä¸€å¹•ï¼šç»æœ›çš„å¼€å§‹</h1>
    
    <div class="notice">
        <strong>âš ï¸ æ³¨æ„ï¼š</strong>æœ¬åœºæ™¯é‡‡ç”¨æ•™ç¨‹ä¸“ç”¨çš„ç®€åŒ–å®ç°ï¼Œä¸ä½¿ç”¨å®Œæ•´çš„ ECS æ¶æ„å’Œæ ¸å¿ƒç³»ç»Ÿã€‚
        æµ‹è¯•é¡µé¢ç›´æ¥å¤„ç†è¾“å…¥ã€ç§»åŠ¨ã€æˆ˜æ–—å’Œè£…å¤‡é€»è¾‘ã€‚ä¸»æ¸¸æˆåœºæ™¯å°†ä½¿ç”¨ src/systems/ ä¸‹çš„æ ¸å¿ƒç³»ç»Ÿã€‚
    </div>
    
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    
    <div class="controls">
        <h3>æµ‹è¯•æ§åˆ¶</h3>
        
        <div class="control-group">
            <button id="btnStartScene">å¼€å§‹åœºæ™¯</button>
            <button id="btnResetScene">é‡ç½®åœºæ™¯</button>
        </div>
        
        <div class="control-group">
            <label>æ•™ç¨‹é˜¶æ®µ:</label>
            <button id="btnMovement">ç§»åŠ¨æ•™ç¨‹</button>
            <button id="btnPickup">æ‹¾å–æ•™ç¨‹</button>
            <button id="btnEquipment">è£…å¤‡æ•™ç¨‹</button>
            <button id="btnCombat">æˆ˜æ–—æ•™ç¨‹</button>
        </div>
        
        <div class="control-group">
            <label>æˆ˜æ–—æ³¢æ¬¡:</label>
            <button id="btnWave0">é‡ç‹—</button>
            <button id="btnWave1">å®˜åºœå£«å…µ</button>
            <button id="btnWave2">åœŸåŒª</button>
            <button id="btnWave3">é¥¥æ°‘å›´å›°</button>
        </div>
        
        <div class="control-group">
            <label>åœºæ™¯æ§åˆ¶:</label>
            <button id="btnTriggerDeath">è§¦å‘æ­»äº¡</button>
            <button id="btnStartTransition">å¼€å§‹è¿‡æ¸¡</button>
        </div>
    </div>
    
    <div class="info">
        <h3>åœºæ™¯çŠ¶æ€</h3>
        <div class="status">
            <div class="status-item">
                <div class="status-label">å½“å‰é˜¶æ®µ</div>
                <div class="status-value" id="statusPhase">-</div>
            </div>
            <div class="status-item">
                <div class="status-label">æˆ˜æ–—æ³¢æ¬¡</div>
                <div class="status-value" id="statusWave">-</div>
            </div>
            <div class="status-item">
                <div class="status-label">ç§»åŠ¨è·ç¦»</div>
                <div class="status-value" id="statusDistance">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">æ•Œäººæ•°é‡</div>
                <div class="status-value" id="statusEnemies">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">æ‹¾å–ç‰©å“</div>
                <div class="status-value" id="statusItems">0/0</div>
            </div>
            <div class="status-item">
                <div class="status-label">è¿‡æ¸¡çŠ¶æ€</div>
                <div class="status-value" id="statusTransition">æ— </div>
            </div>
        </div>
    </div>
    
    <div class="instructions">
        <h3>æµ‹è¯•è¯´æ˜</h3>
        <ul>
            <li>ç‚¹å‡»"å¼€å§‹åœºæ™¯"åˆå§‹åŒ–ç¬¬ä¸€å¹•åœºæ™¯</li>
            <li>ä½¿ç”¨ <code>WASD</code> æˆ–æ–¹å‘é”®ç§»åŠ¨è§’è‰²ï¼ˆç§»åŠ¨æ•™ç¨‹ï¼‰</li>
            <li>é è¿‘ç‰©å“æŒ‰ <code>E</code> é”®æ‹¾å–ï¼ˆæ‹¾å–æ•™ç¨‹ï¼‰</li>
            <li>æŒ‰ <code>I</code> é”®æ‰“å¼€èƒŒåŒ…è£…å¤‡ç‰©å“ï¼ˆè£…å¤‡æ•™ç¨‹ï¼‰</li>
            <li>æŒ‰ <code>ç©ºæ ¼</code> é”®æ”»å‡»æ•Œäººï¼ˆæˆ˜æ–—æ•™ç¨‹ï¼‰</li>
            <li>åœºæ™¯åŒ…å«ä¸‰æ³¢æˆ˜æ–—ï¼šé‡ç‹— â†’ å®˜åºœå£«å…µ â†’ åœŸåŒª â†’ é¥¥æ°‘å›´å›°</li>
            <li>ç©å®¶æ­»äº¡åä¼šæ˜¾ç¤ºé»‘å±å’Œæ–‡æœ¬ï¼Œç„¶åè¿‡æ¸¡åˆ°ç¬¬äºŒå¹•</li>
            <li>ä½¿ç”¨æµ‹è¯•æŒ‰é’®å¯ä»¥å¿«é€Ÿè·³è½¬åˆ°ä¸åŒé˜¶æ®µ</li>
        </ul>
    </div>
    
    <script type="module">
        import { Act1Scene } from '../src/prologue/scenes/Act1Scene.js';
        
        // è·å–canvaså’Œä¸Šä¸‹æ–‡
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // åˆ›å»ºåœºæ™¯å®ä¾‹
        let scene = null;
        let lastTime = performance.now();
        
        // åˆå§‹åŒ–åœºæ™¯
        function initScene() {
            scene = new Act1Scene();
            scene.enter({
                player: createMockPlayer()
            });
            
            // è®¾ç½®æ•™ç¨‹ç³»ç»Ÿå›è°ƒ
            scene.tutorialSystem.onShow((stepData) => {
                console.log('æ•™ç¨‹æ˜¾ç¤º:', stepData);
                updateStatus();
            });
            
            scene.tutorialSystem.onHide((tutorial) => {
                console.log('æ•™ç¨‹éšè—:', tutorial);
                updateStatus();
            });
            
            scene.tutorialSystem.onComplete((tutorialId) => {
                console.log('æ•™ç¨‹å®Œæˆ:', tutorialId);
                updateStatus();
            });
            
            console.log('Act1Scene initialized');
        }
        
        // åˆ›å»ºæ¨¡æ‹Ÿç©å®¶
        function createMockPlayer() {
            // åˆ›å»ºæŒä¹…åŒ–çš„ç»„ä»¶å¯¹è±¡
            const components = {
                transform: {
                    position: { x: 400, y: 300 },
                    setPosition: function(x, y) {
                        this.position.x = x;
                        this.position.y = y;
                    }
                },
                stats: {
                    hp: 100,
                    maxHp: 100,
                    heal: function(amount) {
                        this.hp = Math.min(this.maxHp, this.hp + amount);
                    },
                    takeDamage: function(amount) {
                        this.hp = Math.max(0, this.hp - amount);
                    }
                },
                equipment: {
                    weapon: null
                },
                sprite: {
                    playAnimation: function(anim) {
                        console.log(`Playing animation: ${anim}`);
                    }
                }
            };
            
            return {
                name: 'æµ‹è¯•ç©å®¶',
                getComponent: (name) => {
                    return components[name] || null;
                }
            };
        }
        
        // æ¸¸æˆå¾ªç¯
        function gameLoop() {
            const currentTime = performance.now();
            const deltaTime = (currentTime - lastTime) / 1000; // è½¬æ¢ä¸ºç§’
            lastTime = currentTime;
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = '#2a2a2a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // å¤„ç†ç©å®¶è¾“å…¥
            handlePlayerMovement(deltaTime);
            handlePickup();
            handleEquipment();
            handleCombat();
            
            // æ›´æ–°å’Œæ¸²æŸ“åœºæ™¯
            if (scene && scene.isActive) {
                scene.update(deltaTime);
                scene.render(ctx);
                
                // æ¸²æŸ“æ”»å‡»ç‰¹æ•ˆ
                renderAttackEffect(ctx);
                
                // ç»˜åˆ¶è°ƒè¯•ä¿¡æ¯
                drawDebugInfo(ctx);
            }
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            updateStatus();
            
            requestAnimationFrame(gameLoop);
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus() {
            if (!scene) return;
            
            document.getElementById('statusPhase').textContent = scene.tutorialPhase || '-';
            document.getElementById('statusWave').textContent = scene.combatWave + 1;
            document.getElementById('statusDistance').textContent = Math.floor(scene.playerMovedDistance);
            document.getElementById('statusEnemies').textContent = 
                scene.currentEnemies.filter(e => !e.isDead).length + '/' + scene.currentEnemies.length;
            
            const pickedCount = scene.pickupItems.filter(i => i.picked).length;
            document.getElementById('statusItems').textContent = 
                pickedCount + '/' + scene.pickupItems.length;
            
            document.getElementById('statusTransition').textContent = 
                scene.isTransitioning ? scene.transitionPhase : 'æ— ';
            
            // æ˜¾ç¤ºå½“å‰æ•™ç¨‹ä¿¡æ¯
            const currentTutorial = scene.tutorialSystem.getCurrentTutorial();
            if (currentTutorial) {
                const stepIndex = scene.tutorialSystem.getCurrentStepIndex();
                const step = currentTutorial.steps[stepIndex];
                console.log(`å½“å‰æ•™ç¨‹: ${currentTutorial.title} - æ­¥éª¤ ${stepIndex + 1}/${currentTutorial.steps.length}`);
                console.log(`æ•™ç¨‹å†…å®¹: ${step.text}`);
            }
        }
        
        // åœ¨ç”»å¸ƒä¸Šç»˜åˆ¶è°ƒè¯•ä¿¡æ¯
        function drawDebugInfo(ctx) {
            if (!scene || !scene.player) return;
            
            const transform = scene.player.getComponent('transform');
            if (!transform) return;
            
            ctx.save();
            ctx.fillStyle = '#ffffff';
            ctx.font = '12px monospace';
            ctx.textAlign = 'left';
            
            const x = 10;
            let y = 20;
            const lineHeight = 16;
            
            ctx.fillText(`ç©å®¶ä½ç½®: (${Math.floor(transform.position.x)}, ${Math.floor(transform.position.y)})`, x, y);
            y += lineHeight;
            
            const stats = scene.player.getComponent('stats');
            if (stats) {
                ctx.fillText(`ç”Ÿå‘½å€¼: ${Math.floor(stats.hp)}/${stats.maxHp}`, x, y);
                y += lineHeight;
            }
            
            const equipment = scene.player.getComponent('equipment');
            if (equipment && equipment.weapon) {
                ctx.fillText(`æ­¦å™¨: ${equipment.weapon.name}`, x, y);
                y += lineHeight;
            }
            
            ctx.fillText(`æ•™ç¨‹é˜¶æ®µ: ${scene.tutorialPhase}`, x, y);
            y += lineHeight;
            
            ctx.fillText(`ç§»åŠ¨è·ç¦»: ${Math.floor(scene.playerMovedDistance)}px`, x, y);
            y += lineHeight;
            
            ctx.fillText(`èƒŒåŒ…çŠ¶æ€: ${isInventoryOpen ? 'æ‰“å¼€' : 'å…³é—­'}`, x, y);
            y += lineHeight;
            
            const aliveEnemies = scene.currentEnemies.filter(e => !e.isDead).length;
            if (aliveEnemies > 0) {
                ctx.fillText(`å­˜æ´»æ•Œäºº: ${aliveEnemies}`, x, y);
                y += lineHeight;
            }
            
            // ç»˜åˆ¶æ”»å‡»èŒƒå›´åœˆ
            if (scene.tutorialPhase === 'combat' && aliveEnemies > 0) {
                ctx.strokeStyle = 'rgba(255, 0, 0, 0.3)';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.arc(transform.position.x, transform.position.y, 100, 0, Math.PI * 2);
                ctx.stroke();
                ctx.setLineDash([]);
            }
            
            ctx.restore();
        }
        
        // æŒ‰é’®äº‹ä»¶
        document.getElementById('btnStartScene').addEventListener('click', () => {
            initScene();
        });
        
        document.getElementById('btnResetScene').addEventListener('click', () => {
            if (scene) {
                scene.exit();
            }
            initScene();
        });
        
        document.getElementById('btnMovement').addEventListener('click', () => {
            if (scene) {
                // å¦‚æœæœ‰æ•™ç¨‹æ­£åœ¨æ˜¾ç¤º,å…ˆå®Œæˆå®ƒ
                if (scene.tutorialSystem.currentTutorial) {
                    scene.tutorialSystem.completeTutorial();
                }
                scene.startMovementTutorial();
            }
        });
        
        document.getElementById('btnPickup').addEventListener('click', () => {
            if (scene) {
                // å¦‚æœæœ‰æ•™ç¨‹æ­£åœ¨æ˜¾ç¤º,å…ˆå®Œæˆå®ƒ
                if (scene.tutorialSystem.currentTutorial) {
                    scene.tutorialSystem.completeTutorial();
                }
                scene.startPickupTutorial();
            }
        });
        
        document.getElementById('btnEquipment').addEventListener('click', () => {
            if (scene) {
                // å¦‚æœæœ‰æ•™ç¨‹æ­£åœ¨æ˜¾ç¤º,å…ˆå®Œæˆå®ƒ
                if (scene.tutorialSystem.currentTutorial) {
                    scene.tutorialSystem.completeTutorial();
                }
                scene.startEquipmentTutorial();
            }
        });
        
        document.getElementById('btnCombat').addEventListener('click', () => {
            if (scene) {
                // å¦‚æœæœ‰æ•™ç¨‹æ­£åœ¨æ˜¾ç¤º,å…ˆå®Œæˆå®ƒ
                if (scene.tutorialSystem.currentTutorial) {
                    scene.tutorialSystem.completeTutorial();
                }
                scene.startCombatTutorial();
            }
        });
        
        document.getElementById('btnWave0').addEventListener('click', () => {
            if (scene) {
                scene.spawnCombatWave(0);
            }
        });
        
        document.getElementById('btnWave1').addEventListener('click', () => {
            if (scene) {
                scene.spawnCombatWave(1);
            }
        });
        
        document.getElementById('btnWave2').addEventListener('click', () => {
            if (scene) {
                scene.spawnCombatWave(2);
            }
        });
        
        document.getElementById('btnWave3').addEventListener('click', () => {
            if (scene) {
                scene.spawnCombatWave(3);
            }
        });
        
        document.getElementById('btnTriggerDeath').addEventListener('click', () => {
            if (scene) {
                scene.triggerPlayerDeath();
            }
        });
        
        document.getElementById('btnStartTransition').addEventListener('click', () => {
            if (scene) {
                scene.startTransition();
            }
        });
        
        // é”®ç›˜è¾“å…¥çŠ¶æ€
        const keys = {
            w: false,
            a: false,
            s: false,
            d: false,
            ArrowUp: false,
            ArrowLeft: false,
            ArrowDown: false,
            ArrowRight: false,
            e: false,
            i: false,
            ' ': false
        };
        
        // é¼ æ ‡çŠ¶æ€
        let mouseTarget = null; // é¼ æ ‡ç‚¹å‡»çš„ç›®æ ‡ä½ç½®
        let isInventoryOpen = false; // èƒŒåŒ…æ˜¯å¦æ‰“å¼€
        
        // é¼ æ ‡ç‚¹å‡»äº‹ä»¶
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // è®¾ç½®ç§»åŠ¨ç›®æ ‡
            mouseTarget = { x, y };
            console.log(`é¼ æ ‡ç‚¹å‡»ç§»åŠ¨åˆ°: (${Math.floor(x)}, ${Math.floor(y)})`);
        });
        
        // é”®ç›˜æŒ‰ä¸‹äº‹ä»¶
        document.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            
            // I é”®æ‰“å¼€/å…³é—­èƒŒåŒ…ï¼ˆç‰¹æ®Šå¤„ç†ï¼‰
            if (key === 'i') {
                isInventoryOpen = !isInventoryOpen;
                console.log(`èƒŒåŒ…${isInventoryOpen ? 'æ‰“å¼€' : 'å…³é—­'}`);
                e.preventDefault();
                return;
            }
            
            // å…¶ä»–æŒ‰é”®çŠ¶æ€è®°å½•
            if (keys.hasOwnProperty(key) || keys.hasOwnProperty(e.key)) {
                keys[key] = true;
                keys[e.key] = true;
                e.preventDefault();
            }
        });
        
        // é”®ç›˜é‡Šæ”¾äº‹ä»¶
        document.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();
            if (keys.hasOwnProperty(key) || keys.hasOwnProperty(e.key)) {
                keys[key] = false;
                keys[e.key] = false;
                e.preventDefault();
            }
        });
        
        // å¤„ç†ç©å®¶ç§»åŠ¨
        function handlePlayerMovement(deltaTime) {
            if (!scene || !scene.player) return;
            
            const transform = scene.player.getComponent('transform');
            if (!transform) return;
            
            const moveSpeed = 200; // åƒç´ /ç§’
            let dx = 0;
            let dy = 0;
            
            // ä¼˜å…ˆå¤„ç†é¼ æ ‡ç‚¹å‡»ç§»åŠ¨
            if (mouseTarget) {
                const distX = mouseTarget.x - transform.position.x;
                const distY = mouseTarget.y - transform.position.y;
                const distance = Math.sqrt(distX * distX + distY * distY);
                
                // å¦‚æœè·ç¦»ç›®æ ‡å¾ˆè¿‘ï¼Œåœæ­¢ç§»åŠ¨
                if (distance < 5) {
                    mouseTarget = null;
                } else {
                    // å½’ä¸€åŒ–æ–¹å‘
                    dx = distX / distance;
                    dy = distY / distance;
                }
            }
            // å¦åˆ™ä½¿ç”¨é”®ç›˜è¾“å…¥
            else {
                // WASD æˆ–æ–¹å‘é”®ç§»åŠ¨
                if (keys.w || keys.ArrowUp) dy -= 1;
                if (keys.s || keys.ArrowDown) dy += 1;
                if (keys.a || keys.ArrowLeft) dx -= 1;
                if (keys.d || keys.ArrowRight) dx += 1;
                
                // å½’ä¸€åŒ–å¯¹è§’çº¿ç§»åŠ¨
                if (dx !== 0 && dy !== 0) {
                    dx *= 0.707; // 1/sqrt(2)
                    dy *= 0.707;
                }
            }
            
            // æ›´æ–°ä½ç½®
            if (dx !== 0 || dy !== 0) {
                const oldX = transform.position.x;
                const oldY = transform.position.y;
                
                transform.position.x += dx * moveSpeed * deltaTime;
                transform.position.y += dy * moveSpeed * deltaTime;
                
                // é™åˆ¶åœ¨ç”»å¸ƒèŒƒå›´å†…
                transform.position.x = Math.max(20, Math.min(canvas.width - 20, transform.position.x));
                transform.position.y = Math.max(20, Math.min(canvas.height - 20, transform.position.y));
                
                // è®¡ç®—ç§»åŠ¨è·ç¦»
                const distance = Math.sqrt(
                    Math.pow(transform.position.x - oldX, 2) + 
                    Math.pow(transform.position.y - oldY, 2)
                );
                scene.playerMovedDistance += distance;
            }
        }
        
        // å¤„ç†æ‹¾å–ç‰©å“
        let lastPickupTime = 0;
        function handlePickup() {
            if (!scene || !scene.player) return;
            
            // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹ E é”®
            if (!keys.e) return;
            
            // é˜²æ­¢è¿ç»­æ‹¾å–ï¼ˆ0.3ç§’å†·å´ï¼‰
            const currentTime = performance.now();
            if (currentTime - lastPickupTime < 300) return;
            
            const transform = scene.player.getComponent('transform');
            if (!transform) return;
            
            const playerX = transform.position.x;
            const playerY = transform.position.y;
            
            // æ£€æŸ¥é™„è¿‘çš„ç‰©å“
            for (const item of scene.pickupItems) {
                if (item.picked) continue;
                
                const dx = item.x - playerX;
                const dy = item.y - playerY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // å¦‚æœåœ¨æ‹¾å–èŒƒå›´å†…ï¼ˆ50åƒç´ ï¼‰
                if (distance <= 50) {
                    scene.pickupItem(item);
                    lastPickupTime = currentTime;
                    console.log(`æ‹¾å–äº†ç‰©å“: ${item.name}`);
                    break; // ä¸€æ¬¡åªæ‹¾å–ä¸€ä¸ªç‰©å“
                }
            }
        }
        
        // å¤„ç†è£…å¤‡
        function handleEquipment() {
            if (!scene || !scene.player) return;
            
            // å¦‚æœèƒŒåŒ…æ‰“å¼€ä¸”æœ‰æ‹¾å–çš„ç‰©å“ï¼Œè‡ªåŠ¨è£…å¤‡ç¬¬ä¸€ä¸ªæ­¦å™¨
            if (isInventoryOpen) {
                const equipment = scene.player.getComponent('equipment');
                if (!equipment) return;
                
                // æŸ¥æ‰¾å·²æ‹¾å–çš„æ­¦å™¨
                const weapon = scene.pickupItems.find(item => 
                    item.picked && item.type === 'weapon' && !equipment.weapon
                );
                
                if (weapon) {
                    equipment.weapon = weapon;
                    console.log(`è£…å¤‡äº†æ­¦å™¨: ${weapon.name}`);
                    
                    // å®Œæˆè£…å¤‡æ•™ç¨‹
                    if (scene.tutorialPhase === 'equipment' && !scene.tutorialsCompleted.equipment) {
                        scene.completeTutorial('equipment');
                    }
                }
            }
        }
        
        // å¤„ç†æˆ˜æ–—
        let lastAttackTime = 0;
        let attackEffect = null; // æ”»å‡»ç‰¹æ•ˆ { x, y, alpha, time }
        
        function handleCombat() {
            if (!scene || !scene.player) return;
            
            // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹ç©ºæ ¼é”®
            if (!keys[' ']) return;
            
            // æ”»å‡»å†·å´ï¼ˆ0.5ç§’ï¼‰
            const currentTime = performance.now();
            if (currentTime - lastAttackTime < 500) return;
            
            const transform = scene.player.getComponent('transform');
            const equipment = scene.player.getComponent('equipment');
            if (!transform) return;
            
            const playerX = transform.position.x;
            const playerY = transform.position.y;
            
            // åŸºç¡€æ”»å‡»åŠ›
            let attackPower = 10;
            if (equipment && equipment.weapon) {
                attackPower += 5; // æ­¦å™¨åŠ æˆ
                console.log(`ä½¿ç”¨æ­¦å™¨: ${equipment.weapon.name}`);
            }
            
            // æŸ¥æ‰¾æœ€è¿‘çš„æ•Œäºº
            let nearestEnemy = null;
            let nearestDistance = Infinity;
            
            for (const enemy of scene.currentEnemies) {
                if (enemy.isDead) continue;
                
                const dx = enemy.x - playerX;
                const dy = enemy.y - playerY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < nearestDistance) {
                    nearestDistance = distance;
                    nearestEnemy = enemy;
                }
            }
            
            // å¦‚æœæœ‰æ•Œäººåœ¨æ”»å‡»èŒƒå›´å†…ï¼ˆ100åƒç´ ï¼‰
            if (nearestEnemy && nearestDistance <= 100) {
                nearestEnemy.hp -= attackPower;
                lastAttackTime = currentTime;
                
                // åˆ›å»ºæ”»å‡»ç‰¹æ•ˆ
                attackEffect = {
                    x: nearestEnemy.x,
                    y: nearestEnemy.y,
                    alpha: 1.0,
                    time: currentTime,
                    damage: attackPower
                };
                
                console.log(`âš”ï¸ æ”»å‡» ${nearestEnemy.name}ï¼Œé€ æˆ ${attackPower} ç‚¹ä¼¤å®³ï¼Œå‰©ä½™ ${Math.max(0, nearestEnemy.hp)} HP`);
                
                // æ£€æŸ¥æ•Œäººæ˜¯å¦æ­»äº¡
                if (nearestEnemy.hp <= 0) {
                    nearestEnemy.isDead = true;
                    console.log(`ğŸ’€ ${nearestEnemy.name} è¢«å‡»è´¥ï¼`);
                }
            } else {
                if (scene.currentEnemies.length === 0) {
                    console.log('âš ï¸ æ²¡æœ‰æ•Œäººï¼Œè¯·ç‚¹å‡»"å¼€å§‹æˆ˜æ–—æ•™ç¨‹"æˆ–"ç”Ÿæˆæ³¢æ¬¡"æŒ‰é’®');
                } else {
                    console.log(`âš ï¸ æ²¡æœ‰æ•Œäººåœ¨æ”»å‡»èŒƒå›´å†…ï¼ˆæœ€è¿‘è·ç¦»: ${Math.floor(nearestDistance)}pxï¼Œéœ€è¦ â‰¤100pxï¼‰`);
                }
            }
        }
        
        // æ¸²æŸ“æ”»å‡»ç‰¹æ•ˆ
        function renderAttackEffect(ctx) {
            if (!attackEffect) return;
            
            const currentTime = performance.now();
            const elapsed = currentTime - attackEffect.time;
            
            // ç‰¹æ•ˆæŒç»­ 500ms
            if (elapsed > 500) {
                attackEffect = null;
                return;
            }
            
            // æ·¡å‡ºæ•ˆæœ
            attackEffect.alpha = 1.0 - (elapsed / 500);
            
            ctx.save();
            ctx.globalAlpha = attackEffect.alpha;
            
            // ç»˜åˆ¶æ”»å‡»åœ†åœˆ
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(attackEffect.x, attackEffect.y, 30 + elapsed / 10, 0, Math.PI * 2);
            ctx.stroke();
            
            // ç»˜åˆ¶ä¼¤å®³æ•°å­—
            ctx.fillStyle = '#ff0000';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`-${attackEffect.damage}`, attackEffect.x, attackEffect.y - 40 - elapsed / 10);
            
            ctx.restore();
        }
        
        // å¯åŠ¨æ¸¸æˆå¾ªç¯
        gameLoop();
        
        // è‡ªåŠ¨åˆå§‹åŒ–åœºæ™¯
        initScene();
    </script>
</body>
</html>
