<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>序章场景基类测试</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #4CAF50;
            text-align: center;
        }
        
        .test-section {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .test-section h2 {
            color: #64B5F6;
            margin-top: 0;
        }
        
        canvas {
            border: 2px solid #4CAF50;
            display: block;
            margin: 20px auto;
            background-color: #000000;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        button {
            padding: 10px 20px;
            font-size: 14px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        
        .info-panel {
            background-color: #333;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .info-panel .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #4CAF50;
            padding-left: 10px;
        }
        
        .info-panel .log-entry.error {
            border-left-color: #f44336;
            color: #ff6b6b;
        }
        
        .info-panel .log-entry.success {
            border-left-color: #4CAF50;
            color: #69f0ae;
        }
        
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status.active {
            background-color: #4CAF50;
            color: white;
        }
        
        .status.inactive {
            background-color: #666;
            color: #ccc;
        }
        
        .status.paused {
            background-color: #ff9800;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>序章场景基类 (PrologueScene) 测试</h1>
        
        <div class="test-section">
            <h2>场景控制</h2>
            <div class="controls">
                <button id="btnEnter">进入场景 (Enter)</button>
                <button id="btnExit">退出场景 (Exit)</button>
                <button id="btnPause">暂停场景 (Pause)</button>
                <button id="btnResume">恢复场景 (Resume)</button>
                <button id="btnNextScene">下一幕 (Next Scene)</button>
            </div>
            <div>
                场景状态: 
                <span id="sceneStatus" class="status inactive">未激活</span>
                <span id="pauseStatus" class="status inactive">未暂停</span>
            </div>
        </div>
        
        <div class="test-section">
            <h2>实体和NPC管理</h2>
            <div class="controls">
                <button id="btnAddEntity">添加实体</button>
                <button id="btnRemoveEntity">移除实体</button>
                <button id="btnAddNPC">添加NPC</button>
                <button id="btnRemoveNPC">移除NPC</button>
            </div>
            <div>
                实体数量: <span id="entityCount">0</span> | 
                NPC数量: <span id="npcCount">0</span>
            </div>
        </div>
        
        <div class="test-section">
            <h2>场景渲染</h2>
            <canvas id="gameCanvas" width="800" height="600"></canvas>
        </div>
        
        <div class="test-section">
            <h2>日志输出</h2>
            <div id="logPanel" class="info-panel"></div>
        </div>
    </div>

    <script type="module">
        import { PrologueScene } from '../src/prologue/scenes/PrologueScene.js';

        // 日志系统
        const logPanel = document.getElementById('logPanel');
        const originalConsoleLog = console.log;
        
        function addLog(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
            originalConsoleLog(message);
        }
        
        console.log = addLog;

        // 创建场景数据
        const mockSceneData = {
            tutorials: [
                { id: 'movement', title: '移动教程' },
                { id: 'combat', title: '战斗教程' }
            ],
            dialogues: {
                intro: {
                    id: 'intro',
                    speaker: '张角',
                    text: '欢迎来到黄巾起义序章！'
                }
            },
            quests: [
                { id: 'quest1', name: '学习移动' },
                { id: 'quest2', name: '学习战斗' }
            ],
            npcs: [
                { id: 'zhangjiao', name: '张角', position: { x: 400, y: 300 } },
                { id: 'zhangliang', name: '张梁', position: { x: 200, y: 300 } }
            ]
        };

        // 创建场景
        let currentScene = new PrologueScene(1, mockSceneData);
        let entityCounter = 0;
        let npcCounter = 0;

        // 创建模拟的场景管理器
        const mockSceneManager = {
            switchScene: (sceneName, data) => {
                addLog(`场景管理器: 切换到 ${sceneName}`, 'success');
                addLog(`传递数据: ${JSON.stringify(data)}`, 'info');
            }
        };
        currentScene.setSceneManager(mockSceneManager);

        // Canvas设置
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // 更新UI状态
        function updateUI() {
            const sceneStatus = document.getElementById('sceneStatus');
            const pauseStatus = document.getElementById('pauseStatus');
            const entityCount = document.getElementById('entityCount');
            const npcCount = document.getElementById('npcCount');

            if (currentScene.isActive) {
                sceneStatus.textContent = '已激活';
                sceneStatus.className = 'status active';
            } else {
                sceneStatus.textContent = '未激活';
                sceneStatus.className = 'status inactive';
            }

            if (currentScene.isPaused) {
                pauseStatus.textContent = '已暂停';
                pauseStatus.className = 'status paused';
            } else {
                pauseStatus.textContent = '运行中';
                pauseStatus.className = 'status active';
            }

            entityCount.textContent = currentScene.entities.size;
            npcCount.textContent = currentScene.npcs.size;
        }

        // 按钮事件
        document.getElementById('btnEnter').addEventListener('click', () => {
            const mockPlayer = {
                id: 'player1',
                name: '测试玩家',
                position: { x: 400, y: 500 }
            };
            currentScene.enter({ player: mockPlayer });
            addLog('场景已进入', 'success');
            updateUI();
        });

        document.getElementById('btnExit').addEventListener('click', () => {
            currentScene.exit();
            addLog('场景已退出', 'success');
            updateUI();
        });

        document.getElementById('btnPause').addEventListener('click', () => {
            currentScene.pause();
            addLog('场景已暂停', 'success');
            updateUI();
        });

        document.getElementById('btnResume').addEventListener('click', () => {
            currentScene.resume();
            addLog('场景已恢复', 'success');
            updateUI();
        });

        document.getElementById('btnNextScene').addEventListener('click', () => {
            currentScene.goToNextScene({ testData: '测试数据' });
            addLog('请求切换到下一幕', 'success');
        });

        document.getElementById('btnAddEntity').addEventListener('click', () => {
            entityCounter++;
            const entity = {
                id: `entity${entityCounter}`,
                x: Math.random() * 700 + 50,
                y: Math.random() * 500 + 50,
                color: `hsl(${Math.random() * 360}, 70%, 50%)`,
                update: function(deltaTime) {
                    // 简单的移动逻辑
                    this.x += Math.sin(Date.now() / 1000) * 50 * deltaTime;
                    this.y += Math.cos(Date.now() / 1000) * 50 * deltaTime;
                    
                    // 边界检查
                    if (this.x < 0) this.x = 0;
                    if (this.x > 800) this.x = 800;
                    if (this.y < 0) this.y = 0;
                    if (this.y > 600) this.y = 600;
                },
                render: function(ctx) {
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, 10, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#fff';
                    ctx.font = '12px Arial';
                    ctx.fillText(this.id, this.x - 20, this.y - 15);
                }
            };
            currentScene.addEntity(entity.id, entity);
            addLog(`添加实体: ${entity.id}`, 'success');
            updateUI();
        });

        document.getElementById('btnRemoveEntity').addEventListener('click', () => {
            if (currentScene.entities.size > 0) {
                const firstEntityId = Array.from(currentScene.entities.keys())[0];
                currentScene.removeEntity(firstEntityId);
                addLog(`移除实体: ${firstEntityId}`, 'success');
                updateUI();
            } else {
                addLog('没有实体可移除', 'error');
            }
        });

        document.getElementById('btnAddNPC').addEventListener('click', () => {
            npcCounter++;
            const npc = {
                id: `npc${npcCounter}`,
                name: `NPC-${npcCounter}`,
                x: Math.random() * 700 + 50,
                y: Math.random() * 500 + 50,
                render: function(ctx) {
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, 15, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.strokeStyle = '#FFA500';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    ctx.fillStyle = '#fff';
                    ctx.font = '14px Arial';
                    ctx.fillText(this.name, this.x - 25, this.y - 20);
                }
            };
            currentScene.addNPC(npc.id, npc);
            addLog(`添加NPC: ${npc.name}`, 'success');
            updateUI();
        });

        document.getElementById('btnRemoveNPC').addEventListener('click', () => {
            if (currentScene.npcs.size > 0) {
                const firstNPCId = Array.from(currentScene.npcs.keys())[0];
                currentScene.removeNPC(firstNPCId);
                addLog(`移除NPC: ${firstNPCId}`, 'success');
                updateUI();
            } else {
                addLog('没有NPC可移除', 'error');
            }
        });

        // 游戏循环
        let lastTime = performance.now();
        
        function gameLoop(currentTime) {
            const deltaTime = (currentTime - lastTime) / 1000;
            lastTime = currentTime;

            // 更新场景
            currentScene.update(deltaTime);

            // 渲染场景
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            currentScene.render(ctx);

            // 显示FPS
            ctx.fillStyle = '#4CAF50';
            ctx.font = '16px Arial';
            ctx.fillText(`FPS: ${Math.round(1 / deltaTime)}`, 10, 20);
            ctx.fillText(`Act: ${currentScene.actNumber}`, 10, 40);
            ctx.fillText(`Entities: ${currentScene.entities.size}`, 10, 60);
            ctx.fillText(`NPCs: ${currentScene.npcs.size}`, 10, 80);

            requestAnimationFrame(gameLoop);
        }

        // 启动游戏循环
        requestAnimationFrame(gameLoop);

        // 初始化UI
        updateUI();
        addLog('序章场景基类测试页面已加载', 'success');
        addLog('点击"进入场景"按钮开始测试', 'info');
    </script>
</body>
</html>
