<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NPCæ‹›å‹Ÿç³»ç»Ÿæµ‹è¯•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .panel {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .panel h2 {
      color: #667eea;
      margin-bottom: 15px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .npc-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .npc-card {
      background: #f8f9fa;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      transition: all 0.3s;
    }

    .npc-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .npc-card.recruited {
      border-color: #28a745;
      background: #d4edda;
    }

    .npc-card.available {
      border-color: #ffc107;
      background: #fff3cd;
    }

    .npc-card.unavailable {
      border-color: #dc3545;
      background: #f8d7da;
      opacity: 0.7;
    }

    .npc-name {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }

    .npc-description {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }

    .npc-attributes {
      font-size: 12px;
      color: #555;
      margin-bottom: 10px;
    }

    .npc-condition {
      font-size: 12px;
      color: #888;
      font-style: italic;
      margin-bottom: 10px;
    }

    .npc-status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .status-recruited {
      background: #28a745;
      color: white;
    }

    .status-available {
      background: #ffc107;
      color: #333;
    }

    .status-unavailable {
      background: #dc3545;
      color: white;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      margin-right: 5px;
    }

    .btn:hover {
      transform: scale(1.05);
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }

    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .log-entry {
      margin-bottom: 5px;
      padding: 5px;
      border-left: 3px solid #667eea;
      padding-left: 10px;
    }

    .log-entry.success {
      border-left-color: #28a745;
      background: #d4edda;
    }

    .log-entry.error {
      border-left-color: #dc3545;
      background: #f8d7da;
    }

    .log-entry.info {
      border-left-color: #17a2b8;
      background: #d1ecf1;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ–ï¸ NPCæ‹›å‹Ÿç³»ç»Ÿæµ‹è¯•</h1>

    <!-- ç»Ÿè®¡é¢æ¿ -->
    <div class="stats">
      <div class="stat-card">
        <div class="stat-value" id="totalNPCs">0</div>
        <div class="stat-label">æ€»NPCæ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="recruitedCount">0</div>
        <div class="stat-label">å·²æ‹›å‹Ÿ</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="availableCount">0</div>
        <div class="stat-label">å¯æ‹›å‹Ÿ</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="partyPower">0</div>
        <div class="stat-label">é˜Ÿä¼æˆ˜æ–—åŠ›</div>
      </div>
    </div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="panel">
      <h2>ğŸ® æ§åˆ¶é¢æ¿</h2>
      <div class="controls">
        <button class="btn btn-success" onclick="rescueZhangLiang()">æ•‘æ´å¼ æ¢ï¼ˆè§£é”ç®¡éª‡ï¼‰</button>
        <button class="btn btn-success" onclick="rescueZhangBao()">æ•‘æ´å¼ å®ï¼ˆè§£é”å‘¨ä»“ï¼‰</button>
        <button class="btn btn-primary" onclick="completeQuest()">å®Œæˆä¸»çº¿ä»»åŠ¡</button>
        <button class="btn btn-primary" onclick="levelUp()">å‡çº§åˆ°10çº§</button>
        <button class="btn btn-danger" onclick="resetSystem()">é‡ç½®ç³»ç»Ÿ</button>
      </div>
    </div>

    <!-- NPCåˆ—è¡¨ -->
    <div class="panel">
      <h2>ğŸ‘¥ NPCåˆ—è¡¨</h2>
      <div class="npc-grid" id="npcGrid"></div>
    </div>

    <!-- å·²æ‹›å‹Ÿé˜Ÿä¼ -->
    <div class="panel">
      <h2>âš”ï¸ æˆ‘çš„é˜Ÿä¼</h2>
      <div class="npc-grid" id="partyGrid"></div>
    </div>

    <!-- æ—¥å¿— -->
    <div class="panel">
      <h2>ğŸ“‹ æ“ä½œæ—¥å¿—</h2>
      <div class="log" id="logContainer"></div>
    </div>
  </div>

  <script type="module">
    import { NPCRecruitmentSystem } from '../src/prologue/systems/NPCRecruitmentSystem.js';

    // åˆ›å»ºç³»ç»Ÿå®ä¾‹
    const system = new NPCRecruitmentSystem();

    // æ¸¸æˆçŠ¶æ€
    const gameState = {
      rescuedTargets: [],
      completedQuests: [],
      playerLevel: 1,
      inventory: []
    };

    // æ³¨å†ŒNPC
    function registerNPCs() {
      // ç®¡éª‡ - éœ€è¦æ•‘æ´å¼ æ¢
      system.registerNPC({
        id: 'guan_hai',
        name: 'ç®¡éª‡',
        description: 'é»„å·¾å†›çŒ›å°†ï¼ŒåŠ›å¤§æ— ç©·',
        attributes: {
          health: 150,
          maxHealth: 150,
          attack: 25,
          defense: 15,
          speed: 90
        },
        skills: ['é‡å‡»', 'ç‹‚æš´'],
        unitType: 'heavy_infantry',
        recruitCondition: {
          type: 'rescue_success',
          targetId: 'zhang_liang'
        },
        dialogue: {
          recruitment: 'ç®¡éª‡æ„¿æ„è¿½éšå°†å†›ï¼Œå…±åˆ›å¤§ä¸šï¼',
          greeting: 'åœ¨ä¸‹ç®¡éª‡ï¼Œä¹…ä»°å°†å†›å¤§åï¼'
        }
      });

      // å‘¨ä»“ - éœ€è¦æ•‘æ´å¼ å®
      system.registerNPC({
        id: 'zhou_cang',
        name: 'å‘¨ä»“',
        description: 'å¿ å‹‡ä¹‹å£«ï¼Œæ­¦è‰ºé«˜å¼º',
        attributes: {
          health: 180,
          maxHealth: 180,
          attack: 30,
          defense: 20,
          speed: 85
        },
        skills: ['æŠ¤ä¸»', 'é“å£'],
        unitType: 'heavy_infantry',
        recruitCondition: {
          type: 'rescue_success',
          targetId: 'zhang_bao'
        },
        dialogue: {
          recruitment: 'å‘¨ä»“æ„¿ä¸ºå°†å†›æ•ˆçŠ¬é©¬ä¹‹åŠ³ï¼',
          greeting: 'å‘¨ä»“è§è¿‡å°†å†›ï¼'
        }
      });

      // æµ‹è¯•NPC - éœ€è¦å®Œæˆä»»åŠ¡
      system.registerNPC({
        id: 'quest_npc',
        name: 'ä»»åŠ¡NPC',
        description: 'å®Œæˆä¸»çº¿ä»»åŠ¡åå¯æ‹›å‹Ÿ',
        attributes: {
          health: 100,
          maxHealth: 100,
          attack: 15,
          defense: 10,
          speed: 100
        },
        skills: ['æ²»ç–—'],
        unitType: 'support',
        recruitCondition: {
          type: 'quest_completed',
          questId: 'main_quest_1'
        },
        dialogue: {
          recruitment: 'æ„Ÿè°¢å°†å†›çš„å¸®åŠ©ï¼Œæˆ‘æ„¿æ„åŠ å…¥ï¼',
          greeting: 'ä½ å¥½ï¼Œå°†å†›ï¼'
        }
      });

      // æµ‹è¯•NPC - éœ€è¦ç­‰çº§
      system.registerNPC({
        id: 'level_npc',
        name: 'é«˜çº§NPC',
        description: 'éœ€è¦10çº§æ‰èƒ½æ‹›å‹Ÿ',
        attributes: {
          health: 120,
          maxHealth: 120,
          attack: 20,
          defense: 12,
          speed: 95
        },
        skills: ['å¼ºåŒ–', 'é¼“èˆ'],
        unitType: 'support',
        recruitCondition: {
          type: 'level_requirement',
          level: 10
        },
        dialogue: {
          recruitment: 'å°†å†›å®åŠ›ä¸å‡¡ï¼Œæˆ‘æ„¿è¿½éšï¼',
          greeting: 'å°†å†›å¨æ­¦ï¼'
        }
      });

      // æ€»æ˜¯å¯æ‹›å‹Ÿçš„NPC
      system.registerNPC({
        id: 'always_npc',
        name: 'æ™®é€šå£«å…µ',
        description: 'éšæ—¶å¯ä»¥æ‹›å‹Ÿ',
        attributes: {
          health: 80,
          maxHealth: 80,
          attack: 12,
          defense: 8,
          speed: 100
        },
        skills: ['æ™®é€šæ”»å‡»'],
        unitType: 'infantry',
        recruitCondition: {
          type: 'always'
        },
        dialogue: {
          recruitment: 'æ„¿ä¸ºå°†å†›æ•ˆåŠ›ï¼',
          greeting: 'å°†å†›å¥½ï¼'
        }
      });
    }

    // è®¾ç½®å›è°ƒ
    function setupCallbacks() {
      system.on('NPCRecruited', (npc) => {
        addLog(`âœ… æˆåŠŸæ‹›å‹Ÿ ${npc.name}ï¼`, 'success');
        updateUI();
      });

      system.on('NPCDismissed', (npc) => {
        addLog(`âŒ ${npc.name} ç¦»å¼€äº†é˜Ÿä¼`, 'error');
        updateUI();
      });

      system.on('RecruitmentAvailable', (npc) => {
        addLog(`ğŸ’¡ ${npc.name} ç°åœ¨å¯ä»¥æ‹›å‹Ÿäº†ï¼`, 'info');
        updateUI();
      });
    }

    // æ·»åŠ æ—¥å¿—
    function addLog(message, type = 'info') {
      const logContainer = document.getElementById('logContainer');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      logContainer.insertBefore(entry, logContainer.firstChild);
    }

    // æ›´æ–°UI
    function updateUI() {
      updateStats();
      updateNPCGrid();
      updatePartyGrid();
    }

    // æ›´æ–°ç»Ÿè®¡
    function updateStats() {
      const totalNPCs = Array.from(system.npcs.values()).length;
      const recruitedCount = system.getRecruitedNPCs().length;
      const availableCount = system.getAvailableNPCs(gameState).length;
      const partyPower = system.getPartyPower();

      document.getElementById('totalNPCs').textContent = totalNPCs;
      document.getElementById('recruitedCount').textContent = recruitedCount;
      document.getElementById('availableCount').textContent = availableCount;
      document.getElementById('partyPower').textContent = partyPower;
    }

    // æ›´æ–°NPCç½‘æ ¼
    function updateNPCGrid() {
      const grid = document.getElementById('npcGrid');
      grid.innerHTML = '';

      for (const npc of system.npcs.values()) {
        const card = createNPCCard(npc);
        grid.appendChild(card);
      }
    }

    // æ›´æ–°é˜Ÿä¼ç½‘æ ¼
    function updatePartyGrid() {
      const grid = document.getElementById('partyGrid');
      grid.innerHTML = '';

      const party = system.getRecruitedNPCs();
      if (party.length === 0) {
        grid.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">é˜Ÿä¼ä¸ºç©ºï¼Œå¿«å»æ‹›å‹ŸNPCå§ï¼</p>';
        return;
      }

      for (const npc of party) {
        const card = createPartyCard(npc);
        grid.appendChild(card);
      }
    }

    // åˆ›å»ºNPCå¡ç‰‡
    function createNPCCard(npc) {
      const card = document.createElement('div');
      const isRecruited = system.isRecruited(npc.id);
      const isAvailable = system.isAvailable(npc.id, gameState);
      
      let statusClass = 'unavailable';
      let statusText = 'ä¸å¯æ‹›å‹Ÿ';
      if (isRecruited) {
        statusClass = 'recruited';
        statusText = 'å·²æ‹›å‹Ÿ';
      } else if (isAvailable) {
        statusClass = 'available';
        statusText = 'å¯æ‹›å‹Ÿ';
      }

      card.className = `npc-card ${statusClass}`;
      card.innerHTML = `
        <div class="npc-name">${npc.name}</div>
        <div class="npc-status status-${statusClass}">${statusText}</div>
        <div class="npc-description">${npc.description}</div>
        <div class="npc-attributes">
          â¤ï¸ ${npc.attributes.health}/${npc.attributes.maxHealth} | 
          âš”ï¸ ${npc.attributes.attack} | 
          ğŸ›¡ï¸ ${npc.attributes.defense} | 
          âš¡ ${npc.attributes.speed}
        </div>
        <div class="npc-condition">
          ${getConditionText(npc.recruitCondition)}
        </div>
        <button class="btn btn-success" 
                onclick="recruitNPC('${npc.id}')" 
                ${!isAvailable || isRecruited ? 'disabled' : ''}>
          æ‹›å‹Ÿ
        </button>
      `;

      return card;
    }

    // åˆ›å»ºé˜Ÿä¼å¡ç‰‡
    function createPartyCard(npc) {
      const card = document.createElement('div');
      card.className = 'npc-card recruited';
      card.innerHTML = `
        <div class="npc-name">${npc.name}</div>
        <div class="npc-status status-recruited">é˜Ÿä¼æˆå‘˜</div>
        <div class="npc-description">${npc.description}</div>
        <div class="npc-attributes">
          â¤ï¸ ${npc.attributes.health}/${npc.attributes.maxHealth} | 
          âš”ï¸ ${npc.attributes.attack} | 
          ğŸ›¡ï¸ ${npc.attributes.defense} | 
          âš¡ ${npc.attributes.speed}
        </div>
        <div class="npc-attributes">
          ğŸ’– å¿ è¯šåº¦: ${npc.loyalty}%
        </div>
        <button class="btn btn-danger" onclick="dismissNPC('${npc.id}')">
          è§£é›‡
        </button>
      `;

      return card;
    }

    // è·å–æ¡ä»¶æ–‡æœ¬
    function getConditionText(condition) {
      switch (condition.type) {
        case 'always':
          return 'ğŸ“Œ æ— æ¡ä»¶å¯æ‹›å‹Ÿ';
        case 'rescue_success':
          return `ğŸ†˜ éœ€è¦æ•‘æ´ ${condition.targetId}`;
        case 'quest_completed':
          return `ğŸ“œ éœ€è¦å®Œæˆä»»åŠ¡ ${condition.questId}`;
        case 'level_requirement':
          return `â­ éœ€è¦ç­‰çº§ ${condition.level}`;
        case 'battle_won':
          return `âš”ï¸ éœ€è¦èµ¢å¾—æˆ˜æ–— ${condition.battleId}`;
        default:
          return 'â“ æœªçŸ¥æ¡ä»¶';
      }
    }

    // æ‹›å‹ŸNPC
    window.recruitNPC = function(npcId) {
      const result = system.recruitNPC(npcId, gameState);
      if (result.success) {
        addLog(result.message, 'success');
      } else {
        addLog(`æ‹›å‹Ÿå¤±è´¥: ${result.message}`, 'error');
      }
      updateUI();
    };

    // è§£é›‡NPC
    window.dismissNPC = function(npcId) {
      const npc = system.getNPC(npcId);
      if (system.dismissNPC(npcId)) {
        addLog(`${npc.name} ç¦»å¼€äº†é˜Ÿä¼`, 'info');
      }
      updateUI();
    };

    // æ•‘æ´å¼ æ¢
    window.rescueZhangLiang = function() {
      if (!gameState.rescuedTargets.includes('zhang_liang')) {
        gameState.rescuedTargets.push('zhang_liang');
        system.makeAvailable('guan_hai');
        addLog('âœ… æˆåŠŸæ•‘æ´å¼ æ¢ï¼ç®¡éª‡ç°åœ¨å¯ä»¥æ‹›å‹Ÿäº†', 'success');
        updateUI();
      } else {
        addLog('âš ï¸ å·²ç»æ•‘æ´è¿‡å¼ æ¢äº†', 'info');
      }
    };

    // æ•‘æ´å¼ å®
    window.rescueZhangBao = function() {
      if (!gameState.rescuedTargets.includes('zhang_bao')) {
        gameState.rescuedTargets.push('zhang_bao');
        system.makeAvailable('zhou_cang');
        addLog('âœ… æˆåŠŸæ•‘æ´å¼ å®ï¼å‘¨ä»“ç°åœ¨å¯ä»¥æ‹›å‹Ÿäº†', 'success');
        updateUI();
      } else {
        addLog('âš ï¸ å·²ç»æ•‘æ´è¿‡å¼ å®äº†', 'info');
      }
    };

    // å®Œæˆä»»åŠ¡
    window.completeQuest = function() {
      if (!gameState.completedQuests.includes('main_quest_1')) {
        gameState.completedQuests.push('main_quest_1');
        addLog('âœ… å®Œæˆä¸»çº¿ä»»åŠ¡ï¼ä»»åŠ¡NPCç°åœ¨å¯ä»¥æ‹›å‹Ÿäº†', 'success');
        updateUI();
      } else {
        addLog('âš ï¸ å·²ç»å®Œæˆè¿‡è¿™ä¸ªä»»åŠ¡äº†', 'info');
      }
    };

    // å‡çº§
    window.levelUp = function() {
      if (gameState.playerLevel < 10) {
        gameState.playerLevel = 10;
        addLog('âœ… å‡çº§åˆ°10çº§ï¼é«˜çº§NPCç°åœ¨å¯ä»¥æ‹›å‹Ÿäº†', 'success');
        updateUI();
      } else {
        addLog('âš ï¸ å·²ç»æ˜¯10çº§äº†', 'info');
      }
    };

    // é‡ç½®ç³»ç»Ÿ
    window.resetSystem = function() {
      system.reset();
      gameState.rescuedTargets = [];
      gameState.completedQuests = [];
      gameState.playerLevel = 1;
      addLog('ğŸ”„ ç³»ç»Ÿå·²é‡ç½®', 'info');
      updateUI();
    };

    // åˆå§‹åŒ–
    registerNPCs();
    setupCallbacks();
    updateUI();
    addLog('ğŸ® NPCæ‹›å‹Ÿç³»ç»Ÿå·²åˆå§‹åŒ–', 'info');
  </script>
</body>
</html>
