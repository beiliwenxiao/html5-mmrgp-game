<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä»»åŠ¡è¿½è¸ªå™¨æµ‹è¯• - QuestTracker</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #ffffff;
      overflow: hidden;
    }

    #gameCanvas {
      display: block;
      background: linear-gradient(180deg, #0f3460 0%, #16213e 100%);
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
    }

    .controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(30, 30, 30, 0.95);
      padding: 20px 30px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      border: 2px solid #555;
      z-index: 1000;
      max-width: 90%;
    }

    .controls h3 {
      margin-bottom: 15px;
      color: #ffff00;
      text-align: center;
      font-size: 18px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 10px;
    }

    button {
      padding: 10px 20px;
      background: linear-gradient(135deg, #4080ff 0%, #6080ff 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0 3px 10px rgba(64, 128, 255, 0.3);
    }

    button:hover {
      background: linear-gradient(135deg, #6080ff 0%, #8090ff 100%);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(64, 128, 255, 0.5);
    }

    button:active {
      transform: translateY(0);
    }

    button.success {
      background: linear-gradient(135deg, #00ff00 0%, #00cc00 100%);
      box-shadow: 0 3px 10px rgba(0, 255, 0, 0.3);
    }

    button.success:hover {
      background: linear-gradient(135deg, #00cc00 0%, #00aa00 100%);
      box-shadow: 0 5px 15px rgba(0, 255, 0, 0.5);
    }

    button.danger {
      background: linear-gradient(135deg, #ff4040 0%, #ff6060 100%);
      box-shadow: 0 3px 10px rgba(255, 64, 64, 0.3);
    }

    button.danger:hover {
      background: linear-gradient(135deg, #ff6060 0%, #ff8080 100%);
      box-shadow: 0 5px 15px rgba(255, 64, 64, 0.5);
    }

    button.warning {
      background: linear-gradient(135deg, #ffaa00 0%, #ffcc00 100%);
      box-shadow: 0 3px 10px rgba(255, 170, 0, 0.3);
    }

    button.warning:hover {
      background: linear-gradient(135deg, #ffcc00 0%, #ffdd00 100%);
      box-shadow: 0 5px 15px rgba(255, 170, 0, 0.5);
    }

    .info {
      margin-top: 15px;
      padding: 10px;
      background: rgba(50, 50, 50, 0.8);
      border-radius: 8px;
      font-size: 12px;
      color: #cccccc;
      text-align: center;
    }

    .status {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(30, 30, 30, 0.95);
      padding: 15px 20px;
      border-radius: 10px;
      border: 2px solid #555;
      font-size: 14px;
      z-index: 999;
    }

    .status-item {
      margin: 5px 0;
      display: flex;
      justify-content: space-between;
      gap: 20px;
    }

    .status-label {
      color: #aaaaaa;
    }

    .status-value {
      color: #ffff00;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>

  <div class="status">
    <div class="status-item">
      <span class="status-label">æ¿€æ´»ä»»åŠ¡:</span>
      <span class="status-value" id="activeQuestCount">0</span>
    </div>
    <div class="status-item">
      <span class="status-label">å®Œæˆä»»åŠ¡:</span>
      <span class="status-value" id="completedQuestCount">0</span>
    </div>
    <div class="status-item">
      <span class="status-label">å±•å¼€ä»»åŠ¡:</span>
      <span class="status-value" id="expandedQuestCount">0</span>
    </div>
  </div>

  <div class="controls">
    <h3>ğŸ¯ ä»»åŠ¡è¿½è¸ªå™¨æµ‹è¯•æ§åˆ¶å°</h3>
    
    <div class="button-group">
      <button onclick="addQuest1()">æ·»åŠ ä»»åŠ¡1</button>
      <button onclick="addQuest2()">æ·»åŠ ä»»åŠ¡2</button>
      <button onclick="addQuest3()">æ·»åŠ ä»»åŠ¡3</button>
    </div>

    <div class="button-group">
      <button class="success" onclick="progressQuest()">æ¨è¿›ä»»åŠ¡è¿›åº¦</button>
      <button class="success" onclick="completeObjective()">å®Œæˆç›®æ ‡</button>
      <button class="warning" onclick="completeQuest()">å®Œæˆä»»åŠ¡</button>
    </div>

    <div class="button-group">
      <button onclick="expandAll()">å±•å¼€æ‰€æœ‰</button>
      <button onclick="collapseAll()">æŠ˜å æ‰€æœ‰</button>
      <button class="danger" onclick="resetTracker()">é‡ç½®è¿½è¸ªå™¨</button>
    </div>

    <div class="info">
      ğŸ’¡ ç‚¹å‡»ä»»åŠ¡å—å¯ä»¥å±•å¼€/æŠ˜å è¯¦æƒ… | é¼ æ ‡æ‚¬åœæŸ¥çœ‹é«˜äº®æ•ˆæœ
    </div>
  </div>

  <script type="module">
    import { QuestTracker } from '../src/prologue/ui/QuestTracker.js';
    import { QuestSystem } from '../src/prologue/systems/QuestSystem.js';

    // åˆå§‹åŒ– Canvas
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // åˆ›å»ºä»»åŠ¡ç³»ç»Ÿ
    const questSystem = new QuestSystem();

    // åˆ›å»ºä»»åŠ¡è¿½è¸ªå™¨
    const questTracker = new QuestTracker({
      questSystem: questSystem,
      y: 20,
      width: 320,
      maxHeight: 600
    });

    // ä»»åŠ¡è®¡æ•°å™¨
    let questCounter = 0;

    // æ·»åŠ æµ‹è¯•ä»»åŠ¡
    window.addQuest1 = function() {
      questCounter++;
      const questId = `quest_${questCounter}`;
      
      questSystem.registerQuest({
        id: questId,
        name: `å‡»è´¥é‡ç‹— #${questCounter}`,
        description: 'åœ¨è’é‡ä¸­å‡»è´¥é‡ç‹—',
        objectives: [
          {
            id: 'obj1',
            description: 'å‡»è´¥5åªé‡ç‹—',
            type: 'kill',
            target: 'wild_dog',
            required: 5
          },
          {
            id: 'obj2',
            description: 'æ”¶é›†3å—å…½çš®',
            type: 'collect',
            target: 'beast_hide',
            required: 3
          }
        ],
        rewards: {
          experience: 100,
          currency: 50
        }
      });

      questSystem.startQuest(questId);
      updateStatus();
    };

    window.addQuest2 = function() {
      questCounter++;
      const questId = `quest_${questCounter}`;
      
      questSystem.registerQuest({
        id: questId,
        name: `å¯»æ‰¾å¼ è§’ #${questCounter}`,
        description: 'å‰å¾€ç²¥æ£šå¯»æ‰¾å¼ è§’',
        objectives: [
          {
            id: 'obj1',
            description: 'åˆ°è¾¾ç²¥æ£š',
            type: 'reach',
            target: 'porridge_shed',
            required: 1
          },
          {
            id: 'obj2',
            description: 'ä¸å¼ è§’å¯¹è¯',
            type: 'interact',
            target: 'zhang_jiao',
            required: 1
          }
        ],
        rewards: {
          experience: 150,
          item: 'talisman_water'
        }
      });

      questSystem.startQuest(questId);
      updateStatus();
    };

    window.addQuest3 = function() {
      questCounter++;
      const questId = `quest_${questCounter}`;
      
      questSystem.registerQuest({
        id: questId,
        name: `è£…å¤‡å‡çº§ #${questCounter}`,
        description: 'è·å¾—æ›´å¥½çš„è£…å¤‡',
        objectives: [
          {
            id: 'obj1',
            description: 'è·å¾—å¸ƒè¡£',
            type: 'collect',
            target: 'cloth_armor',
            required: 1
          },
          {
            id: 'obj2',
            description: 'è·å¾—æœ¨å‰‘',
            type: 'collect',
            target: 'wooden_sword',
            required: 1
          },
          {
            id: 'obj3',
            description: 'è£…å¤‡æ‰€æœ‰ç‰©å“',
            type: 'custom',
            required: 1
          }
        ],
        rewards: {
          experience: 200,
          currency: 100
        }
      });

      questSystem.startQuest(questId);
      updateStatus();
    };

    window.progressQuest = function() {
      const activeQuests = questSystem.getActiveQuests();
      if (activeQuests.length === 0) {
        alert('æ²¡æœ‰æ¿€æ´»çš„ä»»åŠ¡ï¼');
        return;
      }

      // éšæœºé€‰æ‹©ä¸€ä¸ªä»»åŠ¡
      const quest = activeQuests[Math.floor(Math.random() * activeQuests.length)];
      
      // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœªå®Œæˆçš„ç›®æ ‡
      const objective = quest.objectives.find(obj => !obj.completed);
      if (objective) {
        questSystem.updateProgress(quest.id, objective.id, 1);
        console.log(`ä»»åŠ¡ "${quest.name}" çš„ç›®æ ‡ "${objective.description}" è¿›åº¦ +1`);
      }
    };

    window.completeObjective = function() {
      const activeQuests = questSystem.getActiveQuests();
      if (activeQuests.length === 0) {
        alert('æ²¡æœ‰æ¿€æ´»çš„ä»»åŠ¡ï¼');
        return;
      }

      const quest = activeQuests[Math.floor(Math.random() * activeQuests.length)];
      const objective = quest.objectives.find(obj => !obj.completed);
      
      if (objective) {
        questSystem.setProgress(quest.id, objective.id, objective.required);
        console.log(`å®Œæˆç›®æ ‡: "${objective.description}"`);
      }
    };

    window.completeQuest = function() {
      const activeQuests = questSystem.getActiveQuests();
      if (activeQuests.length === 0) {
        alert('æ²¡æœ‰æ¿€æ´»çš„ä»»åŠ¡ï¼');
        return;
      }

      const quest = activeQuests[0];
      
      // å®Œæˆæ‰€æœ‰ç›®æ ‡
      for (const objective of quest.objectives) {
        if (!objective.completed) {
          questSystem.setProgress(quest.id, objective.id, objective.required);
        }
      }

      console.log(`å®Œæˆä»»åŠ¡: "${quest.name}"`);
      updateStatus();
    };

    window.expandAll = function() {
      questTracker.expandAll();
      updateStatus();
    };

    window.collapseAll = function() {
      questTracker.collapseAll();
      updateStatus();
    };

    window.resetTracker = function() {
      if (confirm('ç¡®å®šè¦é‡ç½®è¿½è¸ªå™¨å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰ä»»åŠ¡ï¼')) {
        questSystem.reset();
        questTracker.reset();
        questCounter = 0;
        updateStatus();
      }
    };

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatus() {
      document.getElementById('activeQuestCount').textContent = questSystem.getActiveQuests().length;
      document.getElementById('completedQuestCount').textContent = questSystem.completedQuests.size;
      document.getElementById('expandedQuestCount').textContent = questTracker.expandedQuests.size;
    }

    // é¼ æ ‡äº‹ä»¶å¤„ç†
    canvas.addEventListener('mousemove', (e) => {
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;
      
      questTracker.handleMouseMove(mouseX, mouseY);
    });

    canvas.addEventListener('click', (e) => {
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;
      
      questTracker.handleMouseClick(mouseX, mouseY);
      updateStatus();
    });

    // æ¸¸æˆå¾ªç¯
    let lastTime = 0;
    function gameLoop(currentTime) {
      const deltaTime = currentTime - lastTime;
      lastTime = currentTime;

      // æ¸…ç©ºç”»å¸ƒ
      ctx.fillStyle = '#0f3460';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // ç»˜åˆ¶èƒŒæ™¯ç½‘æ ¼
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
      ctx.lineWidth = 1;
      for (let x = 0; x < canvas.width; x += 50) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }
      for (let y = 0; y < canvas.height; y += 50) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }

      // ç»˜åˆ¶æ ‡é¢˜
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 32px Arial, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillText('ä»»åŠ¡è¿½è¸ªå™¨æµ‹è¯•', canvas.width / 2, 30);

      ctx.fillStyle = '#aaaaaa';
      ctx.font = '16px Arial, sans-serif';
      ctx.fillText('QuestTracker Component Demo', canvas.width / 2, 70);

      // æ›´æ–°å’Œæ¸²æŸ“ä»»åŠ¡è¿½è¸ªå™¨
      questTracker.update(deltaTime);
      questTracker.render(ctx);

      requestAnimationFrame(gameLoop);
    }

    // å¯åŠ¨æ¸¸æˆå¾ªç¯
    requestAnimationFrame(gameLoop);

    // åˆå§‹åŒ–çŠ¶æ€
    updateStatus();

    console.log('âœ… ä»»åŠ¡è¿½è¸ªå™¨æµ‹è¯•é¡µé¢å·²åŠ è½½');
    console.log('ğŸ“‹ ä½¿ç”¨æ§åˆ¶å°æŒ‰é’®æ¥æµ‹è¯•å„ç§åŠŸèƒ½');
  </script>
</body>
</html>
