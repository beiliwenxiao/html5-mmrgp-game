<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è£…å¤‡å¼ºåŒ–ç³»ç»Ÿæµ‹è¯•</title>
  <style>
    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    h1 {
      color: #333;
      text-align: center;
    }
    
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .test-section h2 {
      color: #2c3e50;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    
    .equipment-card {
      background: #ecf0f1;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      border-left: 4px solid #3498db;
    }
    
    .equipment-card.rare {
      border-left-color: #9b59b6;
    }
    
    .equipment-card.epic {
      border-left-color: #e74c3c;
    }
    
    .attribute {
      display: inline-block;
      margin: 5px 10px 5px 0;
      padding: 5px 10px;
      background: #fff;
      border-radius: 3px;
    }
    
    .enhance-level {
      color: #27ae60;
      font-weight: bold;
      font-size: 1.2em;
    }
    
    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    
    button:hover {
      background: #2980b9;
    }
    
    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }
    
    .success {
      color: #27ae60;
      font-weight: bold;
    }
    
    .failure {
      color: #e74c3c;
      font-weight: bold;
    }
    
    .info {
      color: #7f8c8d;
    }
    
    .currency {
      font-size: 1.2em;
      color: #f39c12;
      font-weight: bold;
    }
    
    .log {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 15px;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
    }
    
    .log-entry {
      margin: 5px 0;
      padding: 3px 0;
      border-bottom: 1px solid #34495e;
    }
    
    .preview-table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    
    .preview-table th,
    .preview-table td {
      padding: 8px;
      text-align: left;
      border: 1px solid #ddd;
    }
    
    .preview-table th {
      background: #3498db;
      color: white;
    }
    
    .preview-table tr:nth-child(even) {
      background: #f9f9f9;
    }
  </style>
</head>
<body>
  <h1>ğŸ›¡ï¸ è£…å¤‡å¼ºåŒ–ç³»ç»Ÿæµ‹è¯•</h1>

  <div class="test-section">
    <h2>ç©å®¶çŠ¶æ€</h2>
    <div id="player-status">
      <p>è´§å¸: <span class="currency" id="player-currency">10000</span> é“œé’±</p>
    </div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯•è£…å¤‡</h2>
    <div id="equipment-list"></div>
  </div>

  <div class="test-section">
    <h2>æ“ä½œæ—¥å¿—</h2>
    <div class="log" id="log"></div>
  </div>

  <script type="module">
    import { EnhancementSystem } from '../src/prologue/systems/EnhancementSystem.js';

    // åˆå§‹åŒ–ç³»ç»Ÿ
    const enhancementSystem = new EnhancementSystem();
    
    // åˆ›å»ºç©å®¶
    const player = {
      currency: 10000
    };

    // åˆ›å»ºæµ‹è¯•è£…å¤‡
    const equipments = [
      {
        id: 'iron_sword',
        name: 'é“å‰‘',
        type: 'weapon',
        rarity: 'common',
        enhanceLevel: 0,
        attributes: {
          attack: 10,
          defense: 0
        }
      },
      {
        id: 'steel_armor',
        name: 'é’¢é“ ',
        type: 'armor',
        rarity: 'uncommon',
        enhanceLevel: 0,
        attributes: {
          attack: 0,
          defense: 15
        }
      },
      {
        id: 'magic_ring',
        name: 'é­”æ³•æˆ’æŒ‡',
        type: 'accessory',
        rarity: 'rare',
        enhanceLevel: 0,
        attributes: {
          attack: 5,
          defense: 5
        }
      },
      {
        id: 'legendary_blade',
        name: 'ä¼ è¯´ä¹‹åˆƒ',
        type: 'weapon',
        rarity: 'legendary',
        enhanceLevel: 0,
        attributes: {
          attack: 50,
          defense: 10
        }
      }
    ];

    // æ—¥å¿—å‡½æ•°
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // æ›´æ–°ç©å®¶çŠ¶æ€æ˜¾ç¤º
    function updatePlayerStatus() {
      document.getElementById('player-currency').textContent = player.currency;
    }

    // è·å–å“è´¨é¢œè‰²ç±»
    function getRarityClass(rarity) {
      const classes = {
        'common': '',
        'uncommon': '',
        'rare': 'rare',
        'epic': 'epic',
        'legendary': 'epic'
      };
      return classes[rarity] || '';
    }

    // æ¸²æŸ“è£…å¤‡å¡ç‰‡
    function renderEquipment(equipment) {
      const card = document.createElement('div');
      card.className = `equipment-card ${getRarityClass(equipment.rarity)}`;
      card.id = `equipment-${equipment.id}`;

      const enhanceText = enhancementSystem.getEnhanceLevelText(equipment.enhanceLevel);
      
      card.innerHTML = `
        <h3>${equipment.name} <span class="enhance-level">${enhanceText}</span></h3>
        <p class="info">å“è´¨: ${equipment.rarity} | ç±»å‹: ${equipment.type}</p>
        <div>
          ${Object.entries(equipment.attributes).map(([key, value]) => 
            `<span class="attribute">${key}: ${value}</span>`
          ).join('')}
        </div>
        <div style="margin-top: 10px;">
          <button onclick="window.enhanceEquipment('${equipment.id}')">å¼ºåŒ–è£…å¤‡</button>
          <button onclick="window.previewEnhance('${equipment.id}')">é¢„è§ˆå¼ºåŒ–</button>
          <button onclick="window.dismantleEquipment('${equipment.id}')">æ‹†è§£è£…å¤‡</button>
        </div>
      `;

      return card;
    }

    // æ¸²æŸ“æ‰€æœ‰è£…å¤‡
    function renderAllEquipments() {
      const container = document.getElementById('equipment-list');
      container.innerHTML = '';
      equipments.forEach(eq => {
        container.appendChild(renderEquipment(eq));
      });
    }

    // å¼ºåŒ–è£…å¤‡
    window.enhanceEquipment = function(equipmentId) {
      const equipment = equipments.find(eq => eq.id === equipmentId);
      if (!equipment) return;

      log(`å°è¯•å¼ºåŒ– ${equipment.name}...`);

      const result = enhancementSystem.enhanceEquipment(equipment, player);

      if (result.success) {
        log(`âœ“ å¼ºåŒ–æˆåŠŸ! ${equipment.name} ç°åœ¨æ˜¯ ${enhancementSystem.getEnhanceLevelText(result.newLevel)}`, 'success');
        log(`  æ¶ˆè€—: ${result.cost} é“œé’± | æˆåŠŸç‡: ${(result.successRate * 100).toFixed(0)}%`);
      } else {
        if (result.reason === 'enhance_failed') {
          log(`âœ— å¼ºåŒ–å¤±è´¥! æ¶ˆè€—: ${result.cost} é“œé’± | æˆåŠŸç‡: ${(result.successRate * 100).toFixed(0)}%`, 'failure');
        } else if (result.reason === 'insufficient_currency') {
          log(`âœ— è´§å¸ä¸è¶³! éœ€è¦: ${result.cost} é“œé’±`, 'failure');
        } else if (result.reason === 'max_level_reached') {
          log(`âœ— å·²è¾¾åˆ°æœ€å¤§å¼ºåŒ–ç­‰çº§!`, 'failure');
        } else {
          log(`âœ— å¼ºåŒ–å¤±è´¥: ${result.reason}`, 'failure');
        }
      }

      updatePlayerStatus();
      renderAllEquipments();
    };

    // é¢„è§ˆå¼ºåŒ–
    window.previewEnhance = function(equipmentId) {
      const equipment = equipments.find(eq => eq.id === equipmentId);
      if (!equipment) return;

      const preview = enhancementSystem.previewEnhancedAttributes(equipment);

      if (!preview) {
        log(`${equipment.name} å·²è¾¾åˆ°æœ€å¤§å¼ºåŒ–ç­‰çº§ï¼Œæ— æ³•é¢„è§ˆ`, 'info');
        return;
      }

      log(`é¢„è§ˆ ${equipment.name} å¼ºåŒ–æ•ˆæœ:`);
      log(`  å½“å‰ç­‰çº§: ${preview.currentLevel} -> ä¸‹ä¸€çº§: ${preview.nextLevel}`);
      log(`  æˆåŠŸç‡: ${(preview.successRate * 100).toFixed(0)}% | æ¶ˆè€—: ${preview.cost} é“œé’±`);
      
      for (const [attr, value] of Object.entries(preview.currentAttributes)) {
        const nextValue = preview.previewAttributes[attr];
        const increase = nextValue - value;
        log(`  ${attr}: ${value} -> ${nextValue} (+${increase})`);
      }
    };

    // æ‹†è§£è£…å¤‡
    window.dismantleEquipment = function(equipmentId) {
      const equipment = equipments.find(eq => eq.id === equipmentId);
      if (!equipment) return;

      if (!confirm(`ç¡®å®šè¦æ‹†è§£ ${equipment.name} å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼`)) {
        return;
      }

      const result = enhancementSystem.dismantleEquipment(equipment);

      if (result.success) {
        player.currency += result.currency;
        log(`âœ“ æ‹†è§£æˆåŠŸ! è·å¾— ${result.currency} é“œé’±`, 'success');
        
        // ä»åˆ—è¡¨ä¸­ç§»é™¤è£…å¤‡
        const index = equipments.findIndex(eq => eq.id === equipmentId);
        if (index !== -1) {
          equipments.splice(index, 1);
        }
      } else {
        log(`âœ— æ‹†è§£å¤±è´¥: ${result.reason}`, 'failure');
      }

      updatePlayerStatus();
      renderAllEquipments();
    };

    // åˆå§‹åŒ–
    log('è£…å¤‡å¼ºåŒ–ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
    log(`ç©å®¶åˆå§‹è´§å¸: ${player.currency} é“œé’±`);
    log(`åŠ è½½äº† ${equipments.length} ä»¶è£…å¤‡`);
    renderAllEquipments();

    // è¿è¡Œè‡ªåŠ¨æµ‹è¯•
    function runAutoTests() {
      log('=== å¼€å§‹è‡ªåŠ¨æµ‹è¯• ===', 'info');

      // æµ‹è¯•1: å¼ºåŒ–æˆåŠŸç‡
      log('æµ‹è¯•1: éªŒè¯å¼ºåŒ–æˆåŠŸç‡é…ç½®');
      const rate0 = enhancementSystem.getEnhanceRate(0);
      const rate5 = enhancementSystem.getEnhanceRate(5);
      log(`  +0->+1 æˆåŠŸç‡: ${(rate0 * 100).toFixed(0)}% (é¢„æœŸ: 100%)`);
      log(`  +5->+6 æˆåŠŸç‡: ${(rate5 * 100).toFixed(0)}% (é¢„æœŸ: 50%)`);

      // æµ‹è¯•2: æ¶ˆè€—è®¡ç®—
      log('æµ‹è¯•2: éªŒè¯å¼ºåŒ–æ¶ˆè€—è®¡ç®—');
      const testEq = { ...equipments[0], enhanceLevel: 0 };
      const cost0 = enhancementSystem.calculateEnhanceCost(testEq);
      testEq.enhanceLevel = 5;
      const cost5 = enhancementSystem.calculateEnhanceCost(testEq);
      log(`  +0 å¼ºåŒ–æ¶ˆè€—: ${cost0} é“œé’±`);
      log(`  +5 å¼ºåŒ–æ¶ˆè€—: ${cost5} é“œé’±`);
      log(`  æ¶ˆè€—å¢é•¿: ${((cost5 / cost0 - 1) * 100).toFixed(0)}%`);

      // æµ‹è¯•3: æ‹†è§£ä»·å€¼
      log('æµ‹è¯•3: éªŒè¯æ‹†è§£ä»·å€¼è®¡ç®—');
      const commonEq = { ...equipments[0], enhanceLevel: 0 };
      const rareEq = { ...equipments[2], enhanceLevel: 0 };
      const commonValue = enhancementSystem.calculateDismantleValue(commonEq);
      const rareValue = enhancementSystem.calculateDismantleValue(rareEq);
      log(`  æ™®é€šè£…å¤‡æ‹†è§£: ${commonValue} é“œé’±`);
      log(`  ç¨€æœ‰è£…å¤‡æ‹†è§£: ${rareValue} é“œé’±`);

      // æµ‹è¯•4: å±æ€§åŠ æˆ
      log('æµ‹è¯•4: éªŒè¯å±æ€§åŠ æˆè®¡ç®—');
      const attrTestEq = {
        id: 'test',
        name: 'æµ‹è¯•',
        rarity: 'common',
        enhanceLevel: 0,
        attributes: { attack: 10 }
      };
      const originalAttack = attrTestEq.attributes.attack;
      enhancementSystem.enhanceEquipment(attrTestEq, { currency: 10000 });
      const newAttack = attrTestEq.attributes.attack;
      log(`  åŸå§‹æ”»å‡»: ${originalAttack}`);
      log(`  +1 æ”»å‡»: ${newAttack}`);
      log(`  å¢å¹…: ${((newAttack / originalAttack - 1) * 100).toFixed(0)}% (é¢„æœŸ: 10%)`);

      log('=== è‡ªåŠ¨æµ‹è¯•å®Œæˆ ===', 'success');
    }

    // å»¶è¿Ÿè¿è¡Œè‡ªåŠ¨æµ‹è¯•
    setTimeout(runAutoTests, 500);
  </script>
</body>
</html>
